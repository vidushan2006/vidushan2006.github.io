<!DOCTYPE HTML>
<html>
<head>
  <title>Ⓥ VIDU Ⓥ</title>
  <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="keywords" content="VIDU, private video, video playlist, custom player, youtube tools, video downloader, web tools">
 
  <meta name="google-site-verification" content="V0_MuUaOfxHestyNxMpimHgDdyqJ3t5bw0Djyc1jfYc" />
  
  <link rel="canonical" href="https://vidu2006.netlify.app/" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <meta property="og:title" content="VIDU - Your Private Video Hub">
  <meta property="og:description" content="Explore and watch exclusive video playlists with a feature-rich, custom-built player and handy web tools.">
  <meta property="og:image" content="https://vidu2006.netlify.app/assets/images/vidu_social_preview.png"> <meta property="og:url" content="https://vidu2006.netlify.app/">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="VIDU - Your Private Video Hub">
  <meta name="twitter:description" content="Explore and watch exclusive video playlists with a feature-rich, custom-built player and handy web tools.">
  <meta name="twitter:image" content="https://vidu2006.netlify.app/assets/images/vidu_social_preview.png"> <link rel="stylesheet" href="assets/css/main.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS for AI Chatbot styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Libraries for AI Assistant -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">


  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "VIDU",
    "url": "https://vidu2006.netlify.app/",
    "description": "A personal, high-performance dashboard for accessing private video playlists with a custom-built player and powerful YouTube tools.",
    "creator": {
      "@type": "Person",
      "name": "VIDU"
    }
  }
  </script>
  
  <style>
    /* [YOUR EXISTING CSS STYLES GO HERE] */
    :root{
      --bg-overlay: rgba(4,6,12,0.46);
      --glass: rgba(255,255,255,0.04);
      --glass-strong: rgba(255,255,255,0.06);
      --accent-1: #7b61ff;
      --accent-2: #39ff14; /* green for seek/volume fill / thumb */
      --accent-3: #ff6b6b;
      --muted: #bfc8dd;
      --text: #f2f6ff;
      --card-radius: 10px;
      --ease: cubic-bezier(.16,.84,.24,1);
    }

    /* FIX 2: Remove focus outline from all buttons and links */
    a:focus, button:focus, input[type="submit"]:focus, input[type="reset"]:focus, input[type="button"]:focus {
        outline: none;
        box-shadow: none;
    }

    body{
      /* The background-image is now set dynamically by a script at the end of the body */
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-color: #04060c; /* Fallback color */
      font-family:"Inter","Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      margin:0;
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    body::before{
      content:'';
      position:fixed;
      inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.38));
      pointer-events:none;
      z-index:0;
    }

    #wrapper{position:relative;z-index:3;padding-bottom:48px;}

    header#header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 22px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      z-index: 10;
      position: sticky;
      top: 12px;
      width: 100%;
      max-width: 750px;
      margin: 0 auto;
      box-shadow: 0 8px 30px rgba(2, 4, 12, 0.5);
      background: rgba(30, 33, 42, 0.4);
      backdrop-filter: blur(7px);
      -webkit-backdrop-filter: blur(16px);
    }

    .header-right-controls {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);user-select:none;position:relative;}
    .logo-circle{
      width: clamp(72px, 9vw, 120px);
      aspect-ratio:1/1;
      border-radius:50%;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.03);
      /* FIX: Replaced border with inset box-shadow to prevent rendering artifacts */
      box-shadow: inset 0 0 0 10px rgba(255, 255, 255, 0.06), 0 10px 24px rgba(0,0,0,0.4);
      transform: translateZ(0);
      flex-shrink:0;
    }
    .logo-circle img{width:100%;height:100%;object-fit:cover;object-position:center center;display:block;transform: translateZ(0);}

    nav ul{list-style:none;margin:0;padding:0;display:flex;gap:10px;align-items:center;}
    
    nav ul li a {
      font-weight: 700;
      font-size: 14px;
      position: relative;
      padding: 8px 16px;
      color: var(--accent-2);
      text-decoration: none;
      border-radius: 8px;
      transition: all .18s var(--ease);
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(57, 255, 20, 0.08);
      border: 1px solid rgba(57, 255, 20, 0.25);
      text-shadow: 0 0 10px rgba(57, 255, 20, 0.4);
      box-shadow: inset 0 0 12px rgba(57, 255, 20, 0.15);
    }

    nav ul li a:hover {
      color: #fff;
      transform: translateY(-3px) scale(1.03);
      background: rgba(57, 255, 20, 0.15);
      border-color: rgba(57, 255, 20, 0.5);
      box-shadow: inset 0 0 12px rgba(57, 255, 20, 0.3), 0 0 20px rgba(57, 255, 20, 0.3);
    }

    /* MODIFICATION: Added transition and transform-origin for zoom effect */
    .wrapper.style1{
      padding-top:12px;
      /* NEW: Add transition for the zoom effect */
      transition: transform 0.4s var(--ease);
      /* NEW: Set the origin to the top center, so it zooms "into" the page */
      transform-origin: top center;
    }
    .inner{max-width:1100px;margin:0 auto;padding:20px;position:relative;z-index:3;}

    .list-container{list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;align-items:flex-start;margin-top:6px;}
    .list-item{
      width:150px; cursor:pointer; text-align:center; background:rgba(18, 20, 28, 0.5); border-radius:var(--card-radius); padding:10px; 
      transition:transform .25s var(--ease);
      border:1px solid rgba(255,255,255,0.06); box-shadow:0 8px 24px rgba(6,8,16,0.5); position:relative; will-change:transform, opacity;
    }

    .list-item::after{content:'';position:absolute;left:8px;right:8px;bottom:8px;height:4px;border-radius:4px;background:linear-gradient(90deg, rgba(123,97,255,0.25), rgba(57,255,20,0.18), rgba(255,107,107,0.12));opacity:0;transform:translateY(6px);transition:opacity .25s var(--ease),transform .25s var(--ease);pointer-events:none;}
    .list-item:hover::after{opacity:1;transform:translateY(0);}
    .list-item:hover{transform: translateY(-6px) scale(1.02); box-shadow:0 16px 32px rgba(6,8,16,0.6);}
    .list-item img{width:100%;border-radius:6px;display:block;transition:transform .4s var(--ease);box-shadow:0 8px 20px rgba(0,0,0,0.4);will-change:transform;background:rgba(0,0,0,0.1);}
    .list-item:hover img{transform:scale(1.04);}

    .list-item .title{display:block;margin-top:0.45rem;color:var(--text);font-weight:700;font-size:14px;text-shadow:0 1px 0 rgba(0,0,0,0.45);}

    .modal-backdrop{
        position:fixed;
        inset:0;
        background:linear-gradient(180deg, rgba(2,3,8,0.6), rgba(0,0,0,0.75));
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:9999;
        padding:16px;
        box-sizing:border-box;
    }
    .player-context {
        position: relative;
    }
    .modal{
        width:min(960px, 92vw);
        background:linear-gradient(180deg, rgba(12,12,12,0.96), rgba(6,6,8,0.98));
        border-radius:14px;
        padding:18px;color:#fff;
        border:1px solid rgba(255,255,255,0.035);
        box-shadow:0 25px 50px rgba(2,6,18,0.7);
        flex-shrink: 1;
    }

    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;}
    .btn{background:linear-gradient(90deg, var(--accent-1), var(--accent-3));color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none;}

    .password-row{display:flex;gap:8px;margin-top:8px;}
    .password-row input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,0.02);color:var(--text);outline:none;transition:box-shadow .15s;}
    .password-row input:focus{box-shadow:0 0 0 2px var(--accent-1);}
    .muted{color:var(--muted);font-size:13px;}

    @media (max-width:720px){ .list-item{width:calc(50% - 12px);} }

    .list-item{opacity:0;transform-origin:center;animation:floatIn .5s forwards;}
    @keyframes floatIn{from{opacity:0;transform:translateY(12px) scale(.995);}to{opacity:1;transform:translateY(0) scale(1);} }

    .ripple{position:relative;overflow:hidden;}
    .ripple .drop{position:absolute;border-radius:50%;transform:scale(0);background:rgba(255,255,255,0.10);animation:rip .6s ease-out;pointer-events:none;}
    @keyframes rip{to{transform:scale(6);opacity:0;}}

    header nav ul li a.touch-active, .logo.touch-active{transform:scale(0.985);transition:transform .08s linear;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
    header nav ul li a.pulse, .logo.pulse{animation:btnPulse .5s ease-out;}
    @keyframes btnPulse{0%{box-shadow:0 0 0 rgba(57,255,20,0.28);}50%{box-shadow:0 0 30px rgba(57,255,20,0.22);}100%{box-shadow:0 0 0 rgba(57,255,20,0);} }


    /* --- FUTURISTIC PLAYER CSS --- */
    .vidu-player-host {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 12px;
      background: #000;
      transform: translateZ(0);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      transition: filter .3s ease;
    }
    .vidu-mount {
      width:100%; 
      aspect-ratio: 16 / 9;
      background:#000; 
      display:block;
    }
    .vidu-mount iframe{
      width:100%; height:100%; display:block; border:0; pointer-events:none;
    }
    
    .vidu-player-host.vidu-player-inverted {
        filter: invert(1);
    }

    .vidu-player-inverted .vidu-overlay,
    .vidu-player-inverted .vidu-close-btn,
    .vidu-player-inverted .vidu-popup-btn,
    .vidu-player-inverted .vidu-invert-btn,
    .vidu-player-inverted .vidu-playlist-toggle-btn,
    .vidu-player-inverted .vidu-osd-feedback,
    .vidu-player-inverted .vidu-seek-feedback {
        filter: invert(1);
    }

    .vidu-loading {
      position:absolute; inset:0; z-index:9995; display:flex; align-items:center; justify-content:center;
      background: rgba(10, 12, 18, 0.85);
      transition: opacity .3s ease;
      will-change: opacity;
    }
    .vidu-loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--glass-strong);
        border-top-color: var(--accent-2);
        border-radius: 50%;
        animation: vidu-spin 1s linear infinite;
    }
    @keyframes vidu-spin { to { transform: rotate(360deg); } }
    
    .vidu-loading.hidden {
      opacity:0; pointer-events:none;
    }

    .vidu-controls-bg {
      position:absolute; left:0; right:0; bottom:0; height:120px;
      background: transparent;
      pointer-events:none; z-index:9996;
      transition:opacity .3s var(--ease);
      will-change:opacity;
    }
    .vidu-controls-bg.hidden { opacity:0; }

    .vidu-overlay {
      position:absolute; left:12px; right:12px; bottom:12px; z-index:9999;
      padding: 10px 16px;
      border-radius: 12px;
      box-sizing:border-box;
      /* FIX 1: Removed transition on `left` and `right` to prevent animation glitch */
      transition: opacity .3s var(--ease), transform .3s var(--ease);
      will-change: opacity, transform;
      background: rgba(20, 22, 28, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(2, 4, 12, 0.3);
    }
    .vidu-overlay.hidden {
      opacity:0;
      transform: translateY(100%);
      pointer-events:none;
    }
    
    .vidu-controls-grid {
      display: grid;
      grid-template-areas:
        "seek seek seek"
        "left center right";
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto auto;
      gap: 8px 16px;
      align-items: center;
    }

    .vidu-seek-container { grid-area: seek; position: relative; padding: 8px 0; }
    .vidu-controls-left { grid-area: left; display: flex; align-items: center; gap: 12px; justify-self: start; }
    .vidu-controls-center { grid-area: center; display: flex; align-items: center; gap: 8px; justify-self: center; }
    .vidu-controls-right { grid-area: right; display: flex; align-items: center; gap: 8px; justify-self: end; }


    .vidu-btn {
      background: transparent; color:#fff; padding:0; border-radius:8px; cursor:pointer; user-select:none; border:none;
      display:flex; align-items:center; justify-content:center; width:40px; height:40px;
      transition: background .18s var(--ease), transform .12s ease;
      position: relative;
    }
    .vidu-btn:hover { background: rgba(255,255,255,0.1); }
    .vidu-btn:active{ transform: scale(.95); transition-duration: .08s; }
    .vidu-btn svg { width: 22px; height: 22px; transition: transform .2s var(--ease); will-change: transform; }
    .vidu-btn:hover svg { transform: scale(1.1); }

    .vidu-custom-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      background: rgba(20, 22, 28, 0.92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #e5e7eb; /* Modern off-white */
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.5px; /* Compacted letters */
      text-shadow: 0 0 8px rgba(229, 231, 235, 0.3); /* Subtle glow */
      white-space: nowrap;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      border: 1px solid rgba(255, 255, 255, 0.15); /* Neutral border */
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s var(--ease), transform 0.2s var(--ease);
      transform-origin: bottom center;
      transform: translateX(-50%) translateY(4px);
      will-change: opacity, transform;
      z-index: 10005;
    }

    .vidu-btn:hover .vidu-custom-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .vidu-custom-tooltip:empty {
      display: none;
    }

    #vidu_playbtn {
      width: 44px; height: 44px; background: rgba(255, 255, 255, 0.1); border-radius: 12px;
      position: relative;
      overflow: hidden;
    }
    #vidu_playbtn:hover { background: rgba(255, 255, 255, 0.2); }
    #vidu_playbtn svg { width: 24px; height: 24px; }
    
    .vidu-range {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px; background: transparent; cursor: pointer;
      position: absolute; top: 0; left: 0; bottom: 0; right: 0; margin: auto 0; padding: 0;
    }
    .vidu-range:focus {
      outline: none;
    }
    .seek-track {
      position: relative; width: 100%; height: 6px;
      background: rgba(59, 130, 246, 0.35);
      border-radius: 6px;
      pointer-events: none; overflow: hidden;
    }
    .seek-progress {
      position: absolute; left: 0; top: 0; height: 100%;
      background: var(--accent-2); border-radius: 6px;
      will-change: width;
      transition: box-shadow 0.3s ease, background 0.3s ease;
    }
    
    /* RE-ADDED: Restored the buffering glow effect for the progress bar track. */
    .seek-track.buffering::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #ff3366, #7b61ff, #39ff14, #00c6ff, #ff3366);
        background-size: 250% 100%;
        animation: vidu-glow-animation 1.2s linear infinite;
        filter: blur(3px);
        opacity: 0.9;
        border-radius: 6px;
    }
    @keyframes vidu-glow-animation {
        0% { background-position: 125% 0; }
        100% { background-position: -125% 0; }
    }
    .vidu-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: transparent;
      border: 0;
      cursor: pointer;
    }
    .vidu-range::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: transparent;
      border: 0;
      cursor: pointer;
    }
    .seek-thumb {
      position: absolute; top: 50%; left: 0; width: 16px; height: 16px;
      background: #00c6ff;
      border-radius: 50%; transform: translateY(-50%) scale(1);
      pointer-events: none; 
      box-shadow: 0 0 8px rgba(0, 198, 255, 0.7);
      transition: transform .2s var(--ease);
      will-change: left, transform;
    }
    .vidu-seek-container:hover .seek-thumb {
      transform: translateY(-50%) scale(1.15); 
      box-shadow: 0 0 16px rgba(0, 198, 255, 1);
    }
    
    .seek-preview {
      position: absolute;
      bottom: 24px;
      left: 0;
      opacity: 0;
      pointer-events: none;
      will-change: transform, opacity;
      transform-origin: bottom center;
      transform: translateX(var(--preview-x, 0)) translateY(8px) scale(0.9);
      transition: opacity 0.15s var(--ease), transform 0.15s var(--ease);
      z-index: 10;
    }
    .vidu-seek-container:hover .seek-preview {
      opacity: 1;
      transform: translateX(var(--preview-x, 0)) translateY(0) scale(1);
    }
    .seek-preview-box {
        background: rgba(10, 12, 18, 0.9);
        padding: 6px 14px;
        border-radius: 6px;
        border: 1px solid rgba(57, 255, 20, 0.3);
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .seeking-text-inner {
      color: var(--accent-2);
      font-weight: 700;
      font-size: 15px;
      white-space: nowrap;
      text-shadow: 0 0 4px rgba(57, 255, 20, 0.4);
      display: flex;
      align-items: baseline;
      justify-content: center;
    }
    .seeking-dots, .playing-dots, .dots {
      display: inline-block;
      width: 1.5em;
      text-align: left;
      vertical-align: bottom;
    }
    @keyframes seeking-dots-anim {
      33% { content: ".."; }
      66% { content: "..."; }
    }
    .seeking-dots::after, .playing-dots::after, .dots::after {
      content: ".";
      animation: seeking-dots-anim 1.5s steps(3, start) infinite;
    }
    .seek-preview-time {
        display: block;
        color: var(--text);
        font-size: 13px;
        font-weight: 600;
        margin-top: 2px;
    }

    .vidu-time-container { display: flex; align-items: baseline; }
    .vidu-time {
      min-width: auto; font-size:14px; font-weight:600; color:var(--text); text-align:center;
      letter-spacing:0.5px; text-shadow:0 1px 2px rgba(0,0,0,0.6); user-select:none;
    }
    .vidu-time-separator { color: var(--muted); margin: 0 6px; font-size: 13px; }

    .vidu-close-btn {
      position:absolute; top:12px; right:12px; z-index:10002;
      width:38px; height:38px; padding:6px; border-radius:50%;
      background:rgba(20, 22, 28, 0.85);
      border:1px solid rgba(255,255,255,0.08); color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.5);
      transition: opacity .3s ease, transform .3s ease, background .3s ease;
      will-change: opacity, transform;
    }
    .vidu-close-btn:hover {
      transform: scale(1.1) rotate(90deg);
      background: rgba(30, 32, 40, 0.9);
    }
    .vidu-close-btn.hidden {
      opacity:0; transform: translateY(-8px) scale(0.95); pointer-events:none;
    }

    .vidu-popup-btn {
      position:absolute; top:12px; left:12px; z-index:10002;
      width:38px; height:38px; padding:6px; border-radius:50%;
      background:rgba(20, 22, 28, 0.85);
      border:1px solid rgba(255,255,255,0.08); color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.5);
      transition: opacity .3s ease, transform .3s ease, background .3s ease;
      will-change: opacity, transform;
    }
    .vidu-popup-btn svg { width: 20px; height: 20px; }
    .vidu-popup-btn:hover {
      transform: scale(1.1);
      background: rgba(30, 32, 40, 0.9);
    }
    .vidu-popup-btn.hidden {
      opacity:0; transform: translateY(-8px) scale(0.95); pointer-events:none;
    }

    .vidu-invert-btn {
      position:absolute; top:60px; left:12px; z-index:10002;
      width:38px; height:38px; padding:6px; border-radius:50%;
      background:rgba(20, 22, 28, 0.85);
      border:1px solid rgba(255,255,255,0.08); color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.5);
      transition: opacity .3s ease, transform .3s ease, background .3s ease;
      will-change: opacity, transform;
    }
    .vidu-invert-btn svg { width: 22px; height: 22px; }
    .vidu-invert-btn:hover {
      transform: scale(1.1);
      background: rgba(30, 32, 40, 0.9);
    }
    .vidu-invert-btn.hidden {
      opacity:0; transform: translateY(-8px) scale(0.95); pointer-events:none;
    }

    .vidu-playlist-toggle-btn {
      position:absolute; top:108px; left:12px; z-index:10002;
      width:38px; height:38px; padding:6px; border-radius:50%;
      background:rgba(20, 22, 28, 0.85);
      border:1px solid rgba(255,255,255,0.08); color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.5);
      transition: opacity .3s ease, transform .3s ease, background .3s ease, color .3s ease, border-color .3s ease;
      will-change: opacity, transform;
    }
     .vidu-playlist-toggle-btn.active {
      color: var(--accent-2);
      border-color: rgba(57, 255, 20, 0.4);
    }
    .vidu-playlist-toggle-btn svg { width: 22px; height: 22px; }
    .vidu-playlist-toggle-btn:hover {
      transform: scale(1.1);
      background: rgba(30, 32, 40, 0.9);
    }
    .vidu-playlist-toggle-btn.hidden {
      opacity:0; transform: translateY(-8px) scale(0.95); pointer-events:none;
    }

    #close-player { display:none !important; }

    .vidu-player-host:-webkit-full-screen .vidu-mount, .vidu-player-host:fullscreen .vidu-mount { height:100vh !important; width:100% !important; }
    .vidu-player-host:-webkit-full-screen .vidu-mount iframe, .vidu-player-host:fullscreen .vidu-mount iframe { height:100vh !important; width:100% !important; max-height:none !important; }
    
    @media (max-width:720px){ .vidu-overlay{ left:8px; right:8px; bottom:8px; } }
    
    @media (max-width:540px){ 
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) .vidu-controls-grid { 
          grid-template-areas: "seek seek" "center right"; 
          grid-template-columns: 1fr 1fr;
      }
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) .vidu-controls-center {
          justify-self: start;
          padding-left: 8px;
      }
      .vidu-time-container { display: none; } 
    }
    
    @media (hover: none) and (pointer: coarse) {
      .vidu-popup-btn,
      .vidu-playlist-toggle-btn {
        display: none !important;
      }
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) .vidu-invert-btn,
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) .vidu-volume-container,
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) #vidu_prevbtn,
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) #vidu_nextbtn,
      .vidu-player-host:not(:-webkit-full-screen):not(:fullscreen) .vidu-playback-menu-container {
        display: none !important;
      }
    }

    .vidu-osd-feedback{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:10003;
      padding:12px 18px; border-radius:12px; 
      background:rgba(20, 22, 28, 0.9);
      border:1px solid rgba(255,255,255,0.08);
      font-weight:800; font-size:18px; color:var(--text); box-shadow:0 10px 25px rgba(0,0,0,0.5);
      pointer-events:none; opacity:0;
      transition:opacity .28s ease; 
      display:flex; align-items:center; justify-content:center; gap: 10px;
      min-width: 90px;
      visibility: hidden;
      will-change: opacity;
    }
    .vidu-osd-feedback.visible {
        opacity: 1;
        visibility: visible;
    }
    .vidu-osd-feedback svg { width: 28px; height: 28px; fill: currentColor; }
    
    /* FIX 2: Added background and improved styling for better visibility */
    .vidu-seek-feedback {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10003;
        color: var(--text);
        font-size: 16px;
        font-weight: 700;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        opacity: 0;
        pointer-events: none;
        background: rgba(20, 22, 28, 0.9);
        padding: 16px 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        min-width: 100px;
        box-sizing: border-box;
    }
    .vidu-seek-feedback.left { left: 15%; }
    .vidu-seek-feedback.right { right: 15%; }
    
    .vidu-seek-feedback.show { animation: vidu-seek-arrow-pop 0.8s var(--ease) forwards; }
    @keyframes vidu-seek-arrow-pop {
        0% { transform: translateY(-50%) scale(0.7); opacity: 0; }
        20% { transform: translateY(-50%) scale(1.1); opacity: 1; }
        80% { transform: translateY(-50%) scale(1); opacity: 1; }
        100% { transform: translateY(-50%) scale(0.85); opacity: 0; }
    }
    
    .vidu-seek-feedback svg {
        width: 48px; height: 48px;
        fill: #fff; /* Solid white for better contrast */
    }

    /* --- NEW: High-End Playback Speed Menu --- */
    .vidu-playback-menu-container {
      position: relative;
    }
    .vidu-playback-menu {
      position: absolute;
      bottom: calc(100% + 12px);
      right: 50%;
      width: auto;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform-origin: bottom center;
      transition: opacity .2s var(--ease), transform .2s var(--ease);
      pointer-events: none;
      will-change: opacity, transform;
      transform: translateX(50%) translateY(10px) scale(0.95);
    }
    .vidu-playback-menu.open {
        opacity: 1;
        transform: translateX(50%) translateY(0) scale(1);
        pointer-events: auto;
    }
    .speed-selector {
      display: flex;
      flex-direction: column;
      position: relative;
      background: rgba(28, 30, 38, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 1px;
      gap: 1px;
    }
    .speed-option {
        background: transparent;
        border: none;
        color: var(--muted);
        padding: 2px 7px;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
        width: 100%;
        text-align: center;
        border-radius: 20px;
        transition: color .2s ease;
        z-index: 2;
        position: relative;
        line-height: 1;
    }
    .speed-option.active {
      color: #fff;
    }
    .speed-selector-indicator {
      position: absolute;
      top: 5px; /* Updated by JS */
      left: 5px;
      right: 5px;
      width: auto;
      height: 5; /* Updated by JS */
      background: rgba(57, 255, 20, 0.4);
      border-radius: 14px;
      box-shadow: 0 0 12px rgba(57, 255, 20, 0.3);
      border: 1px solid rgba(57, 255, 20, 0.5);
      transition: top .25s var(--ease), height .25s var(--ease);
      z-index: 1;
    }
    
    .vidu-playlist-panel {
      position: absolute;
      top: 0;
      left: 100%;
      margin-left: 16px;
      width: 320px;
      height: 100%;
      max-height: min(558px, 90vh);
      background: linear-gradient(180deg, rgba(18,20,28,0.97), rgba(8,9,14,0.98));
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 16px 40px rgba(2,6,18,0.6);
      display: flex;
      flex-direction: column;
      color: var(--text);
      transition: opacity .35s var(--ease), transform .35s var(--ease);
      opacity: 1;
      transform: translateX(0);
    }
    .vidu-playlist-panel:not(.show) {
        opacity: 0;
        transform: translateX(-20px);
        pointer-events: none;
    }
    .vidu-playlist-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); flex-shrink: 0; }
    .vidu-playlist-header h3 { margin: 0; font-size: 16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .vidu-playlist-content { flex-grow: 1; overflow-y: auto; padding: 8px; }
    .vidu-playlist-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; border: 1px solid transparent; }
    .vidu-playlist-item:hover { background-color: var(--glass-strong); }
    .vidu-playlist-item.active { background-color: rgba(57, 255, 20, 0.15); border-color: rgba(57, 255, 20, 0.5); color: #fff; }
    .vidu-playlist-item.active .title { font-weight: 800; }
    .vidu-playlist-item-thumb-wrapper { position: relative; width: 100px; height: 56.25px; flex-shrink: 0; }
    .vidu-playlist-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; display: block; }
    .vidu-playlist-item-number { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.75); color: #fff; font-size: 11px; font-weight: 700; padding: 1px 6px; border-radius: 4px; line-height: 1.4; z-index: 1; pointer-events: none;}
    .vidu-playlist-item .title { font-size: 13px; font-weight: 600; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    
    .vidu-playlist-loader {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 20px;
        box-sizing: border-box;
    }
    .vidu-playlist-loader p {
        margin: 0 0 16px 0;
        font-size: 15px;
        font-weight: 600;
        color: var(--muted);
    }
    .vidu-playlist-loader .spinner {
        width: 36px;
        height: 36px;
        border: 4px solid var(--glass-strong);
        border-top-color: var(--accent-2);
        border-radius: 50%;
        animation: vidu-spin 1s linear infinite;
    }
    
    .vidu-playlist-item-playing-indicator {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(10, 12, 18, 0.9);
        border-radius: 4px;
        color: var(--accent-2);
        font-weight: 700;
        font-size: 14px;
        text-shadow: 0 0 4px rgba(57, 255, 20, 0.4);
    }
    .vidu-playlist-item.active .vidu-playlist-item-thumb-wrapper img,
    .vidu-playlist-item.active .vidu-playlist-item-thumb-wrapper .vidu-playlist-item-number {
        opacity: 0;
    }
    .vidu-playlist-item.active .vidu-playlist-item-playing-indicator {
        display: flex;
    }


    .header-icon-btn { background: transparent; border: none; color: var(--muted); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all .18s var(--ease); position: relative; width: 38px; height: 38px; }
    .header-icon-btn:hover { color: var(--text); background: var(--glass); transform: scale(1.1); }
    .header-icon-btn svg { width: 22px; height: 22px; fill: currentColor; }

    .notification-panel { position: fixed; top: 80px; width: 340px; max-width: 90vw; background: rgba(20, 22, 28, 0.95); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--card-radius); box-shadow: 0 16px 50px rgba(2, 4, 12, 0.6); z-index: 10000; color: var(--text); opacity: 0; transform: translateY(-10px) scale(0.98); transition: opacity .25s var(--ease), transform .25s var(--ease); pointer-events: none; will-change: opacity, transform; }
    #notification-panel { right: 22px; } /* Default to right for notifications */
    .notification-panel.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    .notification-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.07); }
    .notification-header h3 { margin: 0; font-size: 16px; font-weight: 700; }
    .notification-close-btn { background: none; border: none; color: var(--muted); font-size: 26px; line-height: 1; cursor: pointer; padding: 0 4px; transition: color .18s ease, transform .18s ease; }
    .notification-close-btn:hover { color: var(--text); transform: scale(1.1); }
    .notification-content { padding: 18px; font-size: 14px; max-height: 400px; overflow-y: auto; }
    .notification-content p { margin: 0; line-height: 1.6; }

    /* MODIFIED: Styles for the new personalized watch counter */
    .notification-stats { 
      display: flex; 
      align-items: center; 
      justify-content: center; /* Center the content */
      gap: 8px; /* Add a small gap between the icon and the number */
      padding: 12px 18px; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.07); 
      background: rgba(255, 255, 255, 0.02); 
    }
    .stats-icon svg { 
      width: 28px; 
      height: 28px; 
      fill: var(--accent-2); 
    }
    .stats-value { 
      font-size: 20px; 
      font-weight: 800; 
      color: var(--text); 
    }

    .loading-popup-overlay { position: fixed; inset: 0; background: rgba(4, 6, 12, 0.7); z-index: 20000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s var(--ease); will-change: opacity; }
    .loading-popup-overlay.show { opacity: 1; pointer-events: auto; }
    .loading-popup-content { background: linear-gradient(180deg, #1c1c20, #121214); padding: 28px 35px; border-radius: var(--card-radius); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 12px 40px rgba(0,0,0,0.5); text-align: center; max-width: 400px; width: 90%; color: var(--text); }
    .loading-popup-content p { margin: 0 0 18px 0; font-size: 16px; font-weight: 600; line-height: 1.6; }
    .loading-bar-container { width: 100%; height: 8px; background: var(--glass-strong); border-radius: 8px; overflow: hidden; }
    .loading-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); border-radius: 8px; }
    
    #restoring-position-overlay.loading-popup-overlay {
        background: rgba(4, 6, 12, 0.85);
    }

    .fs-playlist-overlay { position: fixed; inset: 0; background: rgba(8, 9, 14, 0.9); z-index: 15000; display: none; flex-direction: column; color: var(--text); opacity: 0; transform: scale(1.02); transition: opacity 0.3s var(--ease), transform 0.3s var(--ease); will-change: opacity, transform; }
    .fs-playlist-overlay.show { display: flex; opacity: 1; transform: scale(1); }
    .fs-playlist-header { display: flex; align-items: center; padding: 18px 24px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.08); flex-shrink: 0; }
    .fs-playlist-header h3 { margin: 0; font-size: 18px; font-weight: 800; }
    .fs-playlist-count { margin-left: 16px; font-size: 14px; font-weight: 600; color: var(--muted); background: var(--glass-strong); padding: 4px 10px; border-radius: 16px; }
    .fs-playlist-close-btn { margin-left: auto; background: none; border: none; color: var(--muted); font-size: 32px; line-height: 1; cursor: pointer; transition: color .2s ease, transform .2s ease; }
    .fs-playlist-close-btn:hover { color: var(--text); transform: scale(1.1) rotate(90deg); }
    .fs-playlist-content { flex: 1; overflow-y: auto; padding: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; align-content: start; }
    .fs-playlist-item { position: relative; background: var(--glass); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: var(--card-radius); padding: 12px; cursor: pointer; transition: transform 0.25s var(--ease), box-shadow 0.25s var(--ease), background 0.25s var(--ease); will-change: transform; }
    .fs-playlist-item:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); background: var(--glass-strong); }
    
    .fs-video-thumbnail {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 6px;
        margin-bottom: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        background: #000;
        overflow: hidden;
    }
    .fs-video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }
    .fs-playlist-item:hover .fs-video-thumbnail img {
        transform: scale(1.05);
    }
    .fs-video-number {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(0,0,0,0.75);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 4px;
        line-height: 1.4;
        z-index: 1;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    /* NEW: Video Duration Style */
    .fs-video-duration {
        position: absolute;
        bottom: 6px;
        right: 6px;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 700;
        line-height: 1;
        z-index: 1;
        pointer-events: none;
    }

    .fs-playlist-item .title { font-weight: 700; font-size: 14px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    
    .fs-playlist-loader { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(8, 9, 14, 0.7); }
    .fs-playlist-loader .spinner { width: 50px; height: 50px; border: 4px solid var(--glass-strong); border-top-color: var(--accent-2); border-radius: 50%; animation: spin 1s linear infinite; }
    .fs-playlist-loader p { margin-top: 16px; font-weight: 600; color: var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }

    .vidu-volume-container { position: relative; }
    .vidu-volume-panel {
        position: absolute;
        bottom: 50px;
        left: 50%;
        width: 40px;
        height: 150px;
        background: rgba(30, 32, 38, 0.96);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        opacity: 0;
        visibility: hidden;
        transition: opacity .2s var(--ease), transform .2s var(--ease);
        transform-origin: bottom center;
        transform: translateX(-50%) translateY(10px) scale(0.95);
        pointer-events: none;
    }
    .vidu-volume-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0) scale(1);
        pointer-events: auto;
    }
    .vidu-volume-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 120px;
        cursor: pointer;
        background: transparent;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-90deg);
    }
    .vidu-volume-slider::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        background: rgba(59, 130, 246, 0.6);
        border-radius: 6px;
    }
    .vidu-volume-slider::-moz-range-track {
        width: 100%;
        height: 6px;
        background: rgba(59, 130, 246, 0.6);
        border-radius: 6px;
    }
    .vidu-volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: var(--accent-2);
        margin-top: -5px;
        box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
    }
    .vidu-volume-slider::-moz-range-thumb {
        height: 16px;
        width: 16px;
        border-radius: 50%;
        background: var(--accent-2);
        border: 0;
        box-shadow: 0 0 8px rgba(57, 255, 20, 0.5);
    }
    
    .popup-notice {
        position: fixed;
        bottom: 20px;
        left: 50%;
        background: rgba(20, 22, 28, 0.95);
        color: var(--text);
        padding: 10px 20px;
        border-radius: var(--card-radius);
        border: 1px solid rgba(57, 255, 20, 0.3);
        box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        z-index: 19000;
        font-weight: 600;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s var(--ease), transform 0.3s var(--ease);
        transform: translateX(-50%) translateY(10px);
        transform-origin: bottom center;
        will-change: opacity, transform;
        visibility: hidden;
    }
    .popup-notice.show {
        opacity: 1;
        pointer-events: auto;
        visibility: visible;
        transform: translateX(-50%) translateY(0px);
    }

    /* POPUP PLAYER MODE STYLES */
    body.popup-mode { padding: 0 !important; background: #000 !important; overflow: hidden; }
    body.popup-mode::before { display:none; }
    body.popup-mode #wrapper, body.popup-mode #footer, body.popup-mode header#header { display: none !important; }
    body.popup-mode #modal-root { display: block !important; }
    body.popup-mode .modal-backdrop { background: transparent !important; padding: 0; }
    body.popup-mode .modal { 
        width: 100vw; height: 100vh; max-width: none; 
        padding: 0; margin: 0; border-radius: 0; 
        background: #000; border:0; box-shadow:none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    body.popup-mode #player-block { margin-top:0 !important; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    body.popup-mode .vidu-player-host {
        border-radius: 0;
        width: 100vw;
        height: calc(100vw * 9 / 16);
        max-height: 100vh;
        max-width: 100vw;
    }
    @media (min-aspect-ratio: 16/9) {
        body.popup-mode .vidu-player-host {
            height: 100vh;
            width: calc(100vh * 16 / 9);
        }
    }
    body.popup-mode .vidu-mount {
        width: 100%; height: 100%;
        aspect-ratio: unset;
    }
    
    body.popup-mode #vidu_fullbtn,
    body.popup-mode .vidu-invert-btn,
    body.popup-mode .vidu-volume-container,
    body.popup-mode #vidu_prevbtn,
    body.popup-mode #vidu_nextbtn {
        display: none !important;
    }
    
    body.popup-mode .vidu-controls-bg { height: 55px; }
    body.popup-mode .vidu-overlay { padding: 2px 10px; bottom: 4px; left: 4px; right: 4px; border-radius: 8px; }
    body.popup-mode .vidu-controls-grid { 
        grid-template-areas: "seek seek" "center right"; 
        grid-template-columns: 1fr 1fr;
    }
    body.popup-mode .vidu-controls-center {
        justify-self: start;
        padding-left: 8px;
    }
    body.popup-mode .vidu-time-container { display: none; }
    body.popup-mode .vidu-seek-container { padding: 4px 0; }
    body.popup-mode .vidu-playback-menu { bottom: 50px; }
    body.popup-mode .vidu-volume-panel { display: none !important; }
    
    @media (hover: hover) and (min-width: 1024px) {
      .vidu-player-host:-webkit-full-screen .vidu-playlist-toggle-btn,
      .vidu-player-host:fullscreen .vidu-playlist-toggle-btn {
        display: none !important;
      }

      .vidu-player-host:-webkit-full-screen .vidu-overlay,
      .vidu-player-host:fullscreen .vidu-overlay {
        left: 15% !important;
        right: 15% !important;
        bottom: 24px !important;
      }

      @keyframes rainbow-glow-animation {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      .vidu-player-host.is-playing .seek-progress {
        box-shadow: 0 0 8px 1px rgba(255, 107, 107, 0.7), 0 0 12px 2px rgba(57, 255, 20, 0.5), 0 0 16px 3px rgba(0, 198, 255, 0.4);
        background: linear-gradient(270deg, #ff6b6b, #fcc419, #51cf66, #339af0, #845ef7, #ff6b6b);
        background-size: 400% 400%;
        animation: rainbow-glow-animation 3s linear infinite;
      }

      #vidu_playbtn::before {
        content: '';
        position: absolute;
        z-index: -2;
        left: -50%;
        top: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(
          from 180deg at 50% 50%,
          #ff6b6b, #fcc419, #51cf66, #339af0, #845ef7, #cc5de8, #f06595, #ff6b6b
        );
        opacity: 0;
        transition: opacity 0.4s ease-in-out, background 0.4s ease;
      }
      #vidu_playbtn::after {
        content: '';
        position: absolute;
        z-index: -1;
        left: 3px;
        top: 3px;
        width: calc(100% - 6px);
        height: calc(100% - 6px);
        background: rgba(30, 33, 42, 0.9);
        border-radius: 10px;
      }
      
      @keyframes rotate-glow {
        100% {
          transform: rotate(1turn);
        }
      }
      
      /* MODIFIED: Glowing style for the filled progress bar when paused. */
      .vidu-player-host:not(.is-playing) .seek-progress {
        background: linear-gradient(270deg, #ff6b6b, #fcc419, #51cf66, #339af0, #845ef7, #ff6b6b);
        background-size: 400% 400%;
        animation: rainbow-glow-animation 5s linear infinite; /* Matches pause button speed */
      }
      
      /* MODIFIED: Glow style for the play button when the video is paused. */
      .vidu-player-host:not(.is-playing) #vidu_playbtn::before {
        animation: rotate-glow 5s linear infinite; /* Slower rotation */
        opacity: 0.8;
      }

      .vidu-player-host.is-playing #vidu_playbtn::before {
        animation: rotate-glow 1.8s linear infinite;
        opacity: 1;
      }
    }
    
    /* NEW: Download Panel Styles */
    #download-panel {
        left: 22px;
        right: auto; /* IMPORTANT: Override right positioning */
    }
    .download-list { 
        list-style: none; 
        padding: 0; 
        margin: -18px; /* Counteract parent padding */
    }
    .download-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px 18px; 
        border-bottom: 1px solid rgba(255, 255, 255, 0.07); 
    }
    .download-item:last-child { 
        border-bottom: none; 
    }
    .download-item-title { 
        font-weight: 600; 
        font-size: 14px; 
        color: var(--text);
    }
    .download-item-btn {
        background: var(--glass-strong);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        width: 32px; height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all .18s var(--ease);
        flex-shrink: 0;
        margin-left: 12px;
        text-decoration: none;
    }
    .download-item-btn:hover { 
        background: var(--accent-2); 
        color: #000; 
        transform: scale(1.1); 
        border-color: rgba(57, 255, 20, 0.5);
    }
    .download-item-btn svg { 
        width: 18px; 
        height: 18px; 
        fill: currentColor; 
    }
    /* UPDATED: Styles for the "Play Last Video" button to use a CSS triangle */
    #play-last-video-btn {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 56px;
        height: 56px;
        background-color: var(--accent-2);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 25px rgba(20, 200, 20, 0.3);
        cursor: pointer;
        z-index: 9990;
        transition: all 0.2s var(--ease);
        display: none;
    }
    #play-last-video-btn:hover {
        transform: scale(1.1);
        background-color: #4aff28;
        box-shadow: 0 12px 30px rgba(20, 255, 20, 0.4);
    }
    .play-icon-triangle {
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 11px 0 11px 18px;
        border-color: transparent transparent transparent white;
        margin-left: 4px;
    }

    /* AI Chatbot Styles */
    #ai-toggle-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 9998;
    }

    #ai-assistant-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(10, 12, 18, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 20000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s var(--ease);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #ai-assistant-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }

    #ai-assistant-container {
        width: 90vw;
        max-width: 750px;
        height: 80vh;
        max-height: 700px;
        background-color: #1E202B;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: scale(0.95);
        transition: transform 0.3s var(--ease);
    }

    #ai-assistant-overlay.visible #ai-assistant-container {
        transform: scale(1);
    }
    
    #ai-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background-color: #2a2d3a;
        flex-shrink: 0;
    }

    #ai-header h3 {
        font-weight: 700;
        font-size: 16px;
        color: #fff;
        background: linear-gradient(90deg, #A855F7, #EC4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    #ai-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    #ai-history::-webkit-scrollbar { width: 6px; }
    #ai-history::-webkit-scrollbar-track { background: #1E202B; }
    #ai-history::-webkit-scrollbar-thumb { background: #4a4e69; border-radius: 3px; }

    .ai-message {
        display: flex;
        gap: 12px;
        max-width: 90%;
    }
    
    .ai-message.user-message {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .ai-message .icon {
        width: 32px;
        height: 32px;
        flex-shrink: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #4a4e69;
    }
    
    .ai-message.user-message .icon {
        background-color: #7b61ff;
    }

    .ai-message .content {
        background-color: #2a2d3a;
        padding: 12px 16px;
        border-radius: 12px;
        color: #e2e8f0;
        font-size: 15px;
        line-height: 1.6;
    }

    .ai-message .content p:not(:last-child) {
        margin-bottom: 1em;
    }
    .ai-message .content h1, .ai-message .content h2, .ai-message .content h3 {
        color: #fff;
        font-weight: 700;
        margin-bottom: 0.5em;
        margin-top: 1em;
    }
    .ai-message .content ul, .ai-message .content ol {
        padding-left: 20px;
        margin-block: 1em;
    }
     .ai-message .content li {
        margin-bottom: 0.5em;
    }
    .ai-message .content a {
        color: #A855F7;
        text-decoration: underline;
    }
    .ai-message .content pre {
        margin-block: 1em;
        border-radius: 8px;
        font-size: 14px;
    }

    #ai-input-area {
        padding: 16px;
        background-color: #2a2d3a;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    #ai-input-box {
        position: relative;
        padding: 2px;
        border-radius: 12px;
        background: linear-gradient(90deg, #A855F7, #EC4899, #F59E0B, #A855F7);
        background-size: 300% 300%;
        animation: gradient-flow 5s ease infinite;
    }

    @keyframes gradient-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    #ai-input-wrapper {
        display: flex;
        align-items: center;
        background-color: #1E202B;
        border-radius: 10px;
        padding: 0 12px;
    }
    
    #ai-input-wrapper .icon {
        color: #A855F7;
    }

    #ai-input {
        flex-grow: 1;
        background: transparent;
        border: none;
        outline: none;
        color: #fff;
        padding: 12px 8px;
        font-size: 16px;
    }
    #ai-input::placeholder { color: #9ca3af; }
    
    #ai-switch-mode {
        display: none; /* REMOVED: No longer needed for the self-hosted AI */
    }

    #ai-mic-btn {
        background: transparent;
        border: none;
        color: #EC4899;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    #ai-mic-btn:hover { background-color: rgba(255,255,255,0.1); }
    #ai-mic-btn.recording { color: #e11d48; animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); }
        100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #A855F7;
        border-radius: 50%;
        display: inline-block;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
    
    .ai-response-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        padding-left: 44px; /* Align with content */
    }
    .ai-response-actions button {
        background-color: #4a4e69;
        border: none;
        color: #e2e8f0;
        padding: 6px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .ai-response-actions button:hover {
        background-color: #7b61ff;
    }
  </style>
</head>
<body class="landing is-preload">
<script>
// POPUP MODE HANDLER
(function() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('popup') === 'true') {
            let popupPlayerInstance = null;
            document.body.classList.add('popup-mode');
            const videoId = urlParams.get('videoId');
            const time = parseFloat(urlParams.get('time')) || 0;
            const title = urlParams.get('title') || 'VIDU Popup';

            document.addEventListener('DOMContentLoaded', () => {
               document.title = title;
               const modalRoot = document.getElementById('modal-root');
               modalRoot.innerHTML = `<div class="modal-backdrop"><div class="modal"><div id="player-block" style="display:block;"><div id="player-wrap"></div></div></div></div>`;

               if (window.showViduPlayer && videoId) {
                   window.showViduPlayer(videoId).then(player => {
                       popupPlayerInstance = player;
                       setTimeout(() => { player.seekTo(time, true); }, 500);
                   });
               }
            });

            window.addEventListener('beforeunload', () => {
                if (popupPlayerInstance && typeof popupPlayerInstance.getCurrentTime === 'function') {
                    const currentTime = popupPlayerInstance.getCurrentTime();
                    const state = { videoId, time: currentTime, title, timestamp: Date.now() };
                    try {
                        localStorage.setItem('vidu_popup_close_state', JSON.stringify(state));
                    } catch(e) {
                        console.error("Failed to save popup state to localStorage", e);
                    }
                }
            });
        }
    } catch(e) {
        console.error("Popup mode initialization failed:", e);
    }
})();
</script>
 <div id="wrapper">
  <header id="header">
    <a href="index.html" class="logo" aria-label="VIDU home" title="VIDU home">
      <div class="logo-circle" aria-hidden="true">
        <img src="https://i.pinimg.com/736x/4d/fa/7b/4dfa7b57656b556f257b4a2e4f8fc8fa.jpg" alt="VIDU Logo" />
      </div>
    </a>
    <div class="header-right-controls">
        <button id="download-btn-header" class="header-icon-btn" aria-label="Download" title="Download">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
        </button>
        <nav>
          <ul>
            <li><a href="videos.html">🔒Private</a></li>
            <li><a href="Tools.html" id="nav-tools" title="Tools" aria-label="Tools">🤖Tools</a></li>
            <li><a href="about.html">ℹ️About</a></li>
          </ul>
        </nav>
        <button id="notification-btn" class="header-icon-btn" aria-label="Notifications" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
        </button>
    </div>
  </header>
  <section id="home" class="wrapper style1 fade-up">
    <div class="inner">
      <ul id="playlist-list" class="list-container">
        </ul>
      <div id="playlist-videos" style="margin-top:2rem; display:none;"></div>  </div>
  </section>
  <footer id="footer">
  </footer>
 </div>

 <div id="modal-root" style="display:none;"></div>
 
 <div id="notification-panel" class="notification-panel" role="dialog" aria-labelledby="notification-title" aria-hidden="true">
    <div class="notification-header">
        <h3 id="notification-title">🔔 Notifications 🔔</h3>
        <button id="notification-close-btn" class="notification-close-btn" aria-label="Close notifications">&times;</button>
    </div>
    <div id="notification-stats" class="notification-stats">
      <div class="stats-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </div>
      <span id="user-watch-count" class="stats-value">0</span>
    </div>
  <div class="notification-content">
  <p style="margin:0 0 12px 0; font-weight:800; font-size:18px; color: #fff;">
    Ayo, VIDU here. The architect of this whole operation. 👨‍💻
  </p>
  <p style="margin:0 0 20px 0; color: #b8c1d9;">
    You wanted to know what's under the hood? Aight, here’s the full breakdown of every single feature I personally coded into this site. It's a vibe.
  </p>

  <h4 style="color: #00ff8a; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(0, 255, 138, 0.2); padding-bottom: 5px;">🎬 The VIDU Player™️ (Yeah, I built that)</h4>
  <ul style="padding-left: 20px; line-height: 1.7; list-style-type: '✅ '; margin-bottom: 20px;">
    <li>
      <strong>Custom Controls:</strong> The default YouTube player is mid, so I built my own slick interface over the YouTube Iframe API. All the buttons and sliders? That's pure HTML and CSS, controlled by my JavaScript.
    </li>
    <li>
      <strong>Keyboard Warrior Mode:</strong> I added `keydown` event listeners so you can go full hacker mode. <strong>Space</strong> for play/pause, <strong>Arrow Keys</strong> for skipping and volume control, and <strong>F</strong> for fullscreen. No mouse required.
    </li>
    <li>
      <strong>Speed Demon Settings:</strong> The little gear icon lets you change playback speed. I'm hooking into the player's `setPlaybackRate()` function to let you bend time. You're welcome.
    </li>
    <li>
      <strong>"Never Lose Your Spot" Save:</strong> Your browser has a secret diary called `localStorage`. I wrote a script to save your video timestamp there every minute. When you come back, it reads that file and `seekTo()` puts you right back where you were. Magic. ✨
    </li>
  </ul>

  <h4 style="color: #00ff8a; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(0, 255, 138, 0.2); padding-bottom: 5px;">🔐 Security & Playlists</h4>
  <ul style="padding-left: 20px; line-height: 1.7; list-style-type: '✅ '; margin-bottom: 20px;">
    <li>
      <strong>The Vault (Password Protection):</strong> For the exclusive content, I added a password check. It's a simple but effective system using Base64 encoding on the password string, which my JavaScript decodes and verifies before letting you in. 🤫
    </li>
    <li>
      <strong>Multi-User Login:</strong> The private page isn't a free-for-all. I built a client-side login system with a JavaScript object acting as a user database. It checks your creds and grants access only to the playlists you're cleared for. VIP treatment only. 💅
    </li>
    <li>
      <strong>YT Playlist Importer:</strong> This is the big one. I'm using the official YouTube Data API. When you paste a link, my code makes a `fetch` call, pulls all the video data, and then dynamically builds that slick fullscreen playlist view for you to scroll through.
    </li>
  </ul>

  <h4 style="color: #00ff8a; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(0, 255, 138, 0.2); padding-bottom: 5px;">🛠️ The VIDU Tool Shed</h4>
  <ul style="padding-left: 20px; line-height: 1.7; list-style-type: '✅ '; margin-bottom: 20px;">
    <li>
      <strong>The Video Yoinker (YT Downloader):</strong> Need a video offline? Just paste one or more links. I use a clever bit of code called a Regular Expression (regex) to instantly find the video ID from any link format. Then I just hand it off to a download service for you.
    </li>
    <li>
      <strong>Link Glo-Up (YT Converter):</strong> Long, ugly YouTube links are a crime. This tool also uses regex to find the video ID and then rebuilds the URL into the clean `youtu.be` format. So much better for sharing.
    </li>
  </ul>
  
  <h4 style="color: #00ff8a; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(0, 255, 138, 0.2); padding-bottom: 5px;">✨ The Vibe (UI/UX)</h4>
  <ul style="padding-left: 20px; line-height: 1.7; list-style-type: '✅ '; margin-bottom: 20px;">
    <li>
      <strong>Glassy Everything:</strong> That cool, see-through blur effect on the modals and header? That's a CSS property called `backdrop-filter: blur()`. Makes everything look premium.
    </li>
    <li>
      <strong>Buttery Smooth Animations:</strong> Every fade-in, every sliding card, every loading bar—that's all custom CSS `transitions` and `animations` I wrote to make the experience feel alive and responsive. No jank here.
    </li>
  </ul>

  <p style="margin:20px 0 0 0; font-size:13px; color:#aeb8d0; text-align: center;">
    <em>Literally coded the soul into this site. Hope you dig it.</em><br/>
    <strong>- VIDU ✌️</strong>
  </p>
</div>
</div>

 <div id="download-panel" class="notification-panel" role="dialog" aria-labelledby="download-title" aria-hidden="true">
    <div class="notification-header">
        <h3 id="download-title">⬇️ Downloads ⬇️</h3>
        <button id="download-close-btn" class="notification-close-btn" aria-label="Close downloads">&times;</button>
    </div>
    <div id="download-content" class="notification-content">
        <p class="muted" style="text-align:center;">Loading downloads...</p>
    </div>
</div>

<div id="fullscreen-playlist-overlay" class="fs-playlist-overlay">
  <div class="fs-playlist-header">
    <h3 id="fs-playlist-title"></h3>
    <span id="fs-playlist-count" class="fs-playlist-count">0 Videos</span>
    <button id="fs-playlist-close-btn" class="fs-playlist-close-btn" aria-label="Close Playlist">&times;</button>
  </div>
  <div id="fs-playlist-content" class="fs-playlist-content"></div>
  <div id="fs-playlist-loader" class="fs-playlist-loader" style="display: none;">
    <div class="spinner"></div>
    <p>Initializing VIDU Fetcher...</p>
  </div>
</div>
<div id="player-loading-overlay" class="loading-popup-overlay">
  <div class="loading-popup-content">
    <p>Initializing VIDU Player</p>
    <div class="loading-bar-container">
      <div id="player-loading-bar-fill" class="loading-bar-fill"></div>
    </div>
  </div>
</div>
<div id="restoring-position-overlay" class="loading-popup-overlay">
  <div class="loading-popup-content">
    <p>Restoring Last Position</p>
    <div class="loading-bar-container">
      <div id="restoring-bar-fill" class="loading-bar-fill"></div>
    </div>
  </div>
</div>
<div id="popup-player-loading-overlay" class="loading-popup-overlay">
  <div class="loading-popup-content">
    <p>Initializing VIDU Popup Player</p>
    <div class="loading-bar-container">
      <div id="popup-player-loading-bar-fill" class="loading-bar-fill"></div>
    </div>
  </div>
</div>
<div id="playlist-video-loading-overlay" class="loading-popup-overlay">
  <div class="loading-popup-content">
    <p id="playlist-loading-message">Loading <span class="dots"></span></p>
    <div class="loading-bar-container">
      <div id="playlist-loading-bar-fill" class="loading-bar-fill"></div>
    </div>
  </div>
</div>
<div id="popup-notice-overlay" class="popup-notice">
  Playing in the VIDU Popup Player
</div>
<!-- UPDATED: "Play Last Video" button now contains a div for the CSS triangle -->
<button id="play-last-video-btn" title="Play Last Watched Video">
    <div class="play-icon-triangle"></div>
</button>

<!-- ============================================================= -->
<!-- == NEW AI ASSISTANT (REBUILT FROM THE GROUND UP) == -->
<!-- ============================================================= -->
<button id="ai-toggle-btn" class="fixed bottom-5 left-5 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-110 focus:outline-none flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
</button>

<div id="ai-assistant-overlay">
    <div id="ai-assistant-container">
        <header id="ai-header">
            <h3>VIDU AI 2.0 Pro</h3>
            <button id="ai-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </header>

        <main id="ai-history">
             <!-- Chat messages will be appended here -->
        </main>

        <footer id="ai-input-area">
            <div id="ai-input-box">
                <div id="ai-input-wrapper">
                    <span class="icon p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.1.6 3 2.9-.8 4.1 3.8-2 3.8 2-.8-4.1 3-2.9-4.1-.6Z"/></svg>
                    </span>
                    <input type="text" id="ai-input" placeholder="Ask me about this website or anything else...">
                    <span id="ai-switch-mode" title="Toggle website context (Tab)"></span>
                    <button id="ai-mic-btn" title="Ask with your voice">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                </div>
            </div>
        </footer>
    </div>
</div>
<!-- ============================================================= -->
<!-- == END OF NEW AI ASSISTANT == -->
<!-- ============================================================= -->


<script>
// Global utility function, accessible by all scripts.
function escapeHtml(s){ return (s||'').replace(/[&<>"'`]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[ch])); }
</script>

<script>
// PLAYER SCRIPT
(function(){
  if(window.__viduPlayerLoaded) return;
  window.__viduPlayerLoaded = true;

  const state = {
    player: null,
    animationFrameId: null,
    keyHandler: null,
    mo: null,
    host: null,
    mount: null,
    seekTrackEl: null,
    fsResizeHandler: null,
    fsListener: null,
    docClickHandler: null,
    inactivityTimer: null,
    lastActivity: Date.now(),
    desiredPlaying: null,
    lastVolume: (() => { try { const v = localStorage.getItem('vidu_player_volume'); return (v !== null && !isNaN(v)) ? parseFloat(v) : 100; } catch(e) { return 100; } })(),
    lastNonMuteVolume: 100,
    osdTimer: null,
    _menuOpenTs: 0,
    lastSaveTime: 0,
    videoId: null,
    lastTime: -1,
    lastDuration: -1,
    lastPlayerState: -1,
    lastVolumeLevel: -1,
    touch_lastTapTime: 0,
    touch_lastTapX: 0,
    touch_isSwiping: false,
    touch_startX: 0,
    touch_startY: 0,
    touch_swipeMode: null,
    touch_seekStartTime: 0,
    touch_startVolume: 0,
    popupCheckInterval: null,
    invertBtnEl: null,
  };

  function getFullscreenElement(){ return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null; }

  function getAdjacentVideoTitle(direction) {
      const playlistData = window.__viduGlobal?.lastOpenedPlaylist;
      if (!playlistData || !playlistData.videos || playlistData.videos.length <= 1) {
          return '';
      }
      const currentVideoId = state.videoId;
      const currentIndex = playlistData.videos.findIndex(v => v.videoId === currentVideoId);
      if (currentIndex === -1) {
          return '';
      }
      const newIndex = (currentIndex + direction + playlistData.videos.length) % playlistData.videos.length;
      const adjacentVideo = playlistData.videos[newIndex];
      return adjacentVideo ? escapeHtml(adjacentVideo.title) : '';
  }

  function updateNavTooltips() {
      const prevTooltip = document.getElementById('vidu_prev_tooltip');
      const nextTooltip = document.getElementById('vidu_next_tooltip');

      if (prevTooltip) {
          prevTooltip.textContent = getAdjacentVideoTitle(-1);
      }
      if (nextTooltip) {
          nextTooltip.textContent = getAdjacentVideoTitle(1);
      }
  }

  function loadVideoInPlayer(videoId, title, startTime = 0) {
    if (state.player && typeof state.player.loadVideoById === 'function' && videoId !== state.videoId) {
        state.videoId = videoId;
        
        state.player.loadVideoById({
            videoId: videoId,
            startSeconds: Math.floor(startTime)
        });

        state.desiredPlaying = true;
        
        const modalTitle = document.getElementById('modal-title');
        if (modalTitle) modalTitle.textContent = title;

        updatePlaylistHighlight();
        updateNavTooltips();
        
        if (typeof window.incrementWatchCount === 'function') {
            window.incrementWatchCount();
        }
        state.lastSaveTime = 0;
    }
  }

  function updatePlaylistHighlight() {
    const panel = document.getElementById('vidu_playlist_panel');
    const currentVideoId = state.videoId;
    if (!panel || !panel.classList.contains('show')) return;
    
    panel.querySelectorAll('.vidu-playlist-item').forEach(item => {
      item.classList.toggle('active', item.dataset.videoId === currentVideoId);
    });
  }
  
  function showLoadingPopupForNextVideo(startTime) {
      const isRestoring = startTime && startTime > 0;
      const loadingPopup = isRestoring ? document.getElementById('restoring-position-overlay') : document.getElementById('playlist-video-loading-overlay');
      const loadingBar = isRestoring ? document.getElementById('restoring-bar-fill') : document.getElementById('playlist-loading-bar-fill');
      
      if (loadingPopup && loadingBar) {
          if (!isRestoring) {
               const loadingMessage = document.getElementById('playlist-loading-message');
               if(loadingMessage) loadingMessage.innerHTML = 'Loading <span class="dots"></span>';
          }
          loadingPopup.classList.add('show');
          loadingBar.style.transition = 'none';
          loadingBar.style.width = '0%';

          setTimeout(() => {
              loadingBar.style.transition = 'width 1.5s cubic-bezier(0.25, 1, 0.5, 1)';
              loadingBar.style.width = '100%';
          }, 10);

          setTimeout(() => {
              loadingPopup.classList.remove('show');
              setTimeout(() => {
                  loadingBar.style.transition = 'none';
                  loadingBar.style.width = '0%';
              }, 300);
          }, 1500);
      }
  }

  function renderInPlayerPlaylist() {
      const panel = document.getElementById('vidu_playlist_panel');
      const playlistData = window.__viduGlobal?.lastOpenedPlaylist;
      if (!panel) return;
      if (!playlistData || !playlistData.videos || playlistData.videos.length === 0) {
          panel.innerHTML = `<div class="vidu-playlist-header"><h3>No playlist loaded</h3></div><div class="vidu-playlist-content" style="text-align:center;padding-top:20px;color:var(--muted);">Open a playlist from the main menu first.</div>`;
          return;
      }
      
      panel.innerHTML = `
          <div class="vidu-playlist-loader">
              <p>Loading<span class="dots"></span></p>
              <div class="spinner"></div>
          </div>`;
      
      setTimeout(() => {
          if (!panel || !panel.classList.contains('show')) {
              return;
          }

          let contentHTML = `<div class="vidu-playlist-header"><h3>${escapeHtml(playlistData.title)}</h3></div><div class="vidu-playlist-content">`;

          playlistData.videos.forEach((video, index) => {
              const isActive = video.videoId === state.videoId ? 'active' : '';
              contentHTML += `
                  <div class="vidu-playlist-item ${isActive}" data-video-id="${escapeHtml(video.videoId)}" data-video-title="${escapeHtml(video.title)}">
                      <div class="vidu-playlist-item-thumb-wrapper">
                          <img src="${escapeHtml(video.thumb)}" alt="">
                          <span class="vidu-playlist-item-number">${index + 1}</span>
                          <div class="vidu-playlist-item-playing-indicator">Playing<span class="playing-dots"></span></div>
                      </div>
                      <div class="title">${escapeHtml(video.title)}</div>
                  </div>
              `;
          });
          contentHTML += `</div>`;
          panel.innerHTML = contentHTML;

          panel.querySelectorAll('.vidu-playlist-item').forEach(item => {
              item.addEventListener('click', () => {
                  const videoId = item.dataset.videoId;
                  const videoTitle = item.dataset.videoTitle;

                  if (state.player && state.videoId && typeof state.player.getCurrentTime === 'function') {
                      const cur = state.player.getCurrentTime();
                      const dur = state.player.getDuration ? state.player.getDuration() : 0;
                      if (cur > 1 && dur > 0 && dur - cur > 5) {
                          window.saveVideoProgress(state.videoId, cur);
                      } else {
                          window.saveVideoProgress(state.videoId, 0);
                      }
                  }
                  
                  const startTime = window.getVideoProgress(videoId) || 0;
                  showLoadingPopupForNextVideo(startTime);

                  setTimeout(() => {
                      loadVideoInPlayer(videoId, videoTitle, startTime);
                  }, 50);
              });
          });
      }, 2000);
  }

  function toggleInPlayerPlaylist() {
      const panel = document.getElementById('vidu_playlist_panel');
      const btn = document.getElementById('vidu_playlist_toggle_btn');
      if (!panel || !btn) return;

      const shouldShow = !panel.classList.contains('show');
      if (shouldShow) {
          renderInPlayerPlaylist();
      }
      panel.classList.toggle('show', shouldShow);
      btn.classList.toggle('active', shouldShow);
  }

  function playNextOrPreviousVideo(direction) {
    if (state.player && state.videoId && typeof state.player.getCurrentTime === 'function') {
        const cur = state.player.getCurrentTime();
        const dur = state.player.getDuration ? state.player.getDuration() : 0;
        if (cur > 1 && dur > 0 && dur - cur > 5) {
            window.saveVideoProgress(state.videoId, cur);
        } else {
            window.saveVideoProgress(state.videoId, 0);
        }
    }

    const playlistData = window.__viduGlobal?.lastOpenedPlaylist;
    if (!playlistData || !playlistData.videos || playlistData.videos.length <= 1) {
        return;
    }
    const currentVideoId = state.videoId;
    const currentIndex = playlistData.videos.findIndex(v => v.videoId === currentVideoId);

    if (currentIndex === -1) {
        return;
    }

    const newIndex = (currentIndex + direction + playlistData.videos.length) % playlistData.videos.length;
    const nextVideo = playlistData.videos[newIndex];
      
    if (nextVideo) {
        const startTime = window.getVideoProgress(nextVideo.videoId) || 0;
        showLoadingPopupForNextVideo(startTime);
        setTimeout(() => {
            loadVideoInPlayer(nextVideo.videoId, nextVideo.title, startTime);
        }, 50);
    }
  }

  function throttle(func, limit) {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  }

  function loadYTApi(){
    if(window.YT && window.YT.Player) return Promise.resolve();
    if(window._vidu_loading_yt){
      return new Promise((res, rej)=>{
        const t = setInterval(()=>{ if(window.YT && window.YT.Player){ clearInterval(t); res(); } },80);
        setTimeout(()=>{ clearInterval(t); rej(new Error('YT load timeout')); },20000);
      });
    }
    window._vidu_loading_yt = true;
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://www.youtube.com/iframe_api';
      s.async=true;
      s.onerror = ()=> reject(new Error('YT API failed to load'));
      document.head.appendChild(s);
      window.onYouTubeIframeAPIReady = function(){ resolve(); };
      setTimeout(()=>{ if(window.YT && window.YT.Player) resolve(); },1200);
      setTimeout(()=>{ if(!(window.YT && window.YT.Player)) reject(new Error('YT API timed out')); },20000);
    });
  }
  try{ window.loadYTApi = loadYTApi; }catch(e){}

  function pad2(n){
    n = Math.max(0, Math.floor(n||0));
    return (n < 10 ? '0' + n : String(n));
  }
  function fmtHHMMSS(s){
    s = Math.max(0, Math.floor(s||0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) {
        return pad2(h) + ':' + pad2(m) + ':' + pad2(sec);
    }
    return pad2(m) + ':' + pad2(sec);
  }
  
  function playSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor" style="transform: translateX(1px);"><path d="M8 5v14l11-7z"/></svg>`; }
  function pauseSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`; }
  function speedometerSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12C2,15.86 4.47,19.17 8,20.41V18.33C5.76,17.2 4,14.76 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12C20,14.76 18.24,17.2 16,18.33V20.41C19.53,19.17 22,15.86 22,12A10,10 0 0,0 12,2M13.5,13.5A1.5,1.5 0 0,1 12,12A1.5,1.5 0 0,1 13.5,10.5L17,7L18.5,8.5L13.5,13.5Z" /></svg>`; }
  function fullscreenSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>`; }
  function exitFullscreenSVG(){ return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>`; }
  function volumeHighSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;}
  function volumeMidSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM3 9v6h4l5 5V4L7 9H3z"/></svg>`;}
  function volumeLowSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>`;}
  function volumeMuteSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`; }
  function rewindSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg>`; }
  function ffwdSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>`; }
  function skipPrevSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 l8.5 6V6z"/></svg>`; }
  function skipNextSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>`; }
  function speedSVG() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 8v8l6-4-6-4zm9-5H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>`;}

  function createHostElements(){
    let wrap = document.getElementById('player-wrap');
    if(!wrap){
      const root = document.getElementById('modal-root') || document.body;
      const modalEl = (root && root.querySelector && root.querySelector('.modal')) ? root.querySelector('.modal') : root;
      wrap = document.createElement('div');
      wrap.id = 'player-wrap';
      wrap.style.minWidth = '320px';
      try{ if(modalEl) modalEl.appendChild(wrap); else document.body.appendChild(wrap); }
      catch(e){ try{ document.body.appendChild(wrap); }catch(_){} }
    }
    const prev = wrap.querySelector('.vidu-player-host');
    if(prev) prev.remove();
    const host = document.createElement('div'); host.className = 'vidu-player-host';
    
    const mount = document.createElement('div'); mount.className = 'vidu-mount'; mount.id = 'vidu_mount_'+Math.floor(Math.random()*1e6);
    host.appendChild(mount);
    const loadingDiv = document.createElement('div'); loadingDiv.className = 'vidu-loading'; loadingDiv.id = 'vidu_loading';
    loadingDiv.innerHTML = `<div class="vidu-loading-spinner"></div>`;
    host.appendChild(loadingDiv);
    const ctrlBg = document.createElement('div'); ctrlBg.className = 'vidu-controls-bg';
    host.appendChild(ctrlBg);
    const overlay = document.createElement('div'); overlay.className = 'vidu-overlay';
    
    overlay.innerHTML = `
      <div class="vidu-controls-grid">
        <div class="vidu-seek-container">
          <div id="vidu_seek_preview" class="seek-preview">
             <div class="seek-preview-box">
                <div class="seeking-text-inner">Seeking<span class="seeking-dots"></span></div>
                <span id="vidu_seek_preview_time" class="seek-preview-time">00:00</span>
            </div>
          </div>
          <div class="seek-track">
            <div id="vidu_seek_progress" class="seek-progress"></div>
          </div>
          <div id="vidu_seek_thumb" class="seek-thumb"></div>
          <input id="vidu_seek" class="vidu-range" type="range" min="0" max="100" step="0.1" value="0" aria-label="Video progress"/>
        </div>
        <div class="vidu-controls-left">
          <div class="vidu-volume-container">
            <button class="vidu-btn" id="vidu_volumebtn" title="Volume" aria-label="Volume">${volumeHighSVG()}</button>
            <div class="vidu-volume-panel" id="vidu_volume_panel">
              <input type="range" min="0" max="100" value="100" class="vidu-volume-slider" id="vidu_volume_slider" />
            </div>
          </div>
          <div class="vidu-time-container">
            <span id="vidu_cur" class="vidu-time">${fmtHHMMSS(0)}</span>
            <span class="vidu-time-separator">/</span>
            <span id="vidu_dur" class="vidu-time">${fmtHHMMSS(0)}</span>
          </div>
        </div>
        <div class="vidu-controls-center">
            <button class="vidu-btn" id="vidu_prevbtn" aria-label="Previous (,)">${skipPrevSVG()}<span id="vidu_prev_tooltip" class="vidu-custom-tooltip"></span></button>
            <button class="vidu-btn" id="vidu_playbtn" aria-label="Play">${playSVG()}</button>
            <button class="vidu-btn" id="vidu_nextbtn" aria-label="Next (.)">${skipNextSVG()}<span id="vidu_next_tooltip" class="vidu-custom-tooltip"></span></button>
        </div>
        <div class="vidu-controls-right">
          <div class="vidu-playback-menu-container">
            <button class="vidu-btn" id="vidu_playbackbtn" title="Playback speed" aria-label="Playback speed">${speedometerSVG()}</button>
            <div class="vidu-playback-menu" id="vidu_playback_menu">
                <div class="speed-selector">
                    <div class="speed-selector-indicator" id="vidu_speed_indicator"></div>
                    <button class="speed-option" data-speed="2">2×</button>
                    <button class="speed-option" data-speed="1.75">1.75×</button>
                    <button class="speed-option" data-speed="1.5">1.5×</button>
                    <button class="speed-option" data-speed="1.25">1.25×</button>
                    <button class="speed-option" data-speed="1" class="active">1×</button>
                </div>
            </div>
          </div>
          <button class="vidu-btn" id="vidu_fullbtn" title="Fullscreen" aria-label="Fullscreen">${fullscreenSVG()}</button>
        </div>
      </div>`;
    host.appendChild(overlay);
    
    const closeBtn = document.createElement('button'); closeBtn.className = 'vidu-close-btn'; closeBtn.id = 'vidu_closebtn'; closeBtn.title = 'Close'; closeBtn.type = 'button'; closeBtn.innerHTML = '✕';
    closeBtn.addEventListener('click', ()=> { try{ if(typeof window.closeModal === 'function') window.closeModal(); else { const root = document.getElementById('modal-root'); if(root) root.style.display='none'; if(window.destroyViduPlayer) window.destroyViduPlayer(); } }catch(e){} });
    host.appendChild(closeBtn);
    
    const popupBtn = document.createElement('button');
    popupBtn.className = 'vidu-popup-btn';
    popupBtn.id = 'vidu_popup_btn';
    popupBtn.title = 'Popup Player (P)';
    popupBtn.type = 'button';
    popupBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg>`;
    host.appendChild(popupBtn);
    
    const invertBtn = document.createElement('button');
    invertBtn.className = 'vidu-invert-btn';
    invertBtn.id = 'vidu_invert_btn';
    invertBtn.title = 'Invert Colors (N)';
    invertBtn.type = 'button';
    invertBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.5 5.5 0 0 1-1.9 1.26 6 6 0 0 1-8.05-5.15A5.5 5.5 0 0 1 13.36 4.1a9 9 0 0 0-1.36-1.1zM12 19a7 7 0 1 1 7-7 7 7 0 0 1-7 7z"/></svg>`;
    host.appendChild(invertBtn);

    const playlistToggleBtn = document.createElement('button');
    playlistToggleBtn.className = 'vidu-playlist-toggle-btn';
    playlistToggleBtn.id = 'vidu_playlist_toggle_btn';
    playlistToggleBtn.title = 'Toggle Playlist';
    playlistToggleBtn.type = 'button';
    playlistToggleBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h12v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3zm14 12 5-3.5-5-3.5v7z"/></svg>`;
    host.appendChild(playlistToggleBtn);

    const osdFeedback = document.createElement('div'); osdFeedback.id = 'vidu_osd_feedback'; osdFeedback.className = 'vidu-osd-feedback';
    host.appendChild(osdFeedback);
    const seekFeedbackLeft = document.createElement('div'); seekFeedbackLeft.id = 'vidu_seek_feedback_left'; seekFeedbackLeft.className = 'vidu-seek-feedback left'; seekFeedbackLeft.innerHTML = `${rewindSVG()}<span>10s</span>`;
    host.appendChild(seekFeedbackLeft);
    const seekFeedbackRight = document.createElement('div'); seekFeedbackRight.id = 'vidu_seek_feedback_right'; seekFeedbackRight.className = 'vidu-seek-feedback right'; seekFeedbackRight.innerHTML = `${ffwdSVG()}<span>10s</span>`;
    host.appendChild(seekFeedbackRight);
    
    wrap.appendChild(host);
    return { host, mount, overlay, ctrlBg, closeBtn, loadingDiv, popupBtn, invertBtn };
  }

  function disableIframeClicks(host){ try{ const ifr = host.querySelector('iframe'); if(ifr){ ifr.style.pointerEvents = 'none'; ifr.setAttribute('allow','autoplay; encrypted-media; fullscreen'); ifr.setAttribute('allowfullscreen',''); ifr.setAttribute('tabindex','-1'); } }catch(e){} }

  function createPlayer(videoId, startTime = 0){
    const { host, mount, overlay, ctrlBg, closeBtn, loadingDiv, popupBtn, invertBtn } = createHostElements();
    state.host = host; state.mount = mount;
    state.videoId = videoId;
    const playBtn = overlay.querySelector('#vidu_playbtn');
    const curEl = overlay.querySelector('#vidu_cur');
    const durEl = overlay.querySelector('#vidu_dur');
    const seekEl = overlay.querySelector('#vidu_seek');
    const fullBtn = overlay.querySelector('#vidu_fullbtn');
    const osdFeedbackEl = host.querySelector('#vidu_osd_feedback');
    const seekProgressEl = overlay.querySelector('#vidu_seek_progress');
    const seekThumbEl = overlay.querySelector('#vidu_seek_thumb');
    const seekContainer = overlay.querySelector('.vidu-seek-container');
    const seekTrackEl = overlay.querySelector('.seek-track');
    const seekPreview = overlay.querySelector('#vidu_seek_preview');
    const seekPreviewTime = overlay.querySelector('#vidu_seek_preview_time');
    const volumeBtn = overlay.querySelector('#vidu_volumebtn');
    const volumePanel = overlay.querySelector('#vidu_volume_panel');
    const volumeSlider = overlay.querySelector('#vidu_volume_slider');
    const seekFeedbackLeft = host.querySelector('#vidu_seek_feedback_left');
    const seekFeedbackRight = host.querySelector('#vidu_seek_feedback_right');
    const popupBtnEl = host.querySelector('#vidu_popup_btn');
    const invertBtnEl = host.querySelector('#vidu_invert_btn');
    const playlistToggleBtnEl = host.querySelector('#vidu_playlist_toggle_btn');
    const prevBtn = host.querySelector('#vidu_prevbtn');
    const nextBtn = host.querySelector('#vidu_nextbtn');
    
    // NEW Playback Speed Menu elements
    const playbackBtn = overlay.querySelector('#vidu_playbackbtn');
    const playbackMenu = overlay.querySelector('#vidu_playback_menu');
    const speedOptions = playbackMenu.querySelectorAll('.speed-option');
    const speedIndicator = playbackMenu.querySelector('#vidu_speed_indicator');

    state.invertBtnEl = invertBtnEl;
    state.seekTrackEl = seekTrackEl;

    if (playlistToggleBtnEl) {
      playlistToggleBtnEl.addEventListener('click', () => {
        toggleInPlayerPlaylist();
        resetInactivityTimer();
      });
    }

    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            playNextOrPreviousVideo(-1);
            resetInactivityTimer();
        });
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            playNextOrPreviousVideo(1);
            resetInactivityTimer();
        });
    }

    // --- REWORKED: Playback speed menu logic ---
function updateSpeedIndicator(activeButton) {
    if (!activeButton || !speedIndicator) return;

    // --- START OF EDIT ---

    const buttonHeight = activeButton.offsetHeight;
    const indicatorHeight = 30; // <-- You can adjust this value! Lower it to make the rectangle shorter.

    // This calculates the correct top position to keep it centered
    const newTop = activeButton.offsetTop + (buttonHeight - indicatorHeight) / 2;

    speedIndicator.style.top = `${newTop}px`;
    speedIndicator.style.height = `${indicatorHeight}px`;

    // --- END OF EDIT ---
}

    playbackBtn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        playbackMenu.classList.toggle('open');
        volumePanel.classList.remove('open');
        // Set initial position of indicator
        const activeButton = playbackMenu.querySelector('.speed-option.active');
        updateSpeedIndicator(activeButton);
    });

    speedOptions.forEach(button => {
        button.addEventListener('click', (e) => {
            const speed = parseFloat(e.target.dataset.speed);
            setPlaybackRate(speed);
            speedOptions.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            updateSpeedIndicator(e.target);
            setTimeout(() => playbackMenu.classList.remove('open'), 250);
        });
    });
    
    volumeBtn.addEventListener('click', (e) => { e.stopPropagation(); volumePanel.classList.toggle('open'); playbackMenu.classList.remove('open'); });
    volumeSlider.addEventListener('input', () => {
        const newVolume = parseFloat(volumeSlider.value);
        setVolume(newVolume, false, true);
    });
    volumeSlider.addEventListener('change', () => {
        const newVolume = parseFloat(volumeSlider.value);
        setVolume(newVolume, true, true);
    });

    state.docClickHandler = (e) => {
      if (playbackMenu.classList.contains('open') && !playbackMenu.contains(e.target) && !playbackBtn.contains(e.target)) {
        playbackMenu.classList.remove('open');
      }
      if (volumePanel.classList.contains('open') && !volumePanel.contains(e.target) && !volumeBtn.contains(e.target)) {
        volumePanel.classList.remove('open');
      }
    };
    document.addEventListener('click', state.docClickHandler);
    
    function toggleFullscreen() {
        const fs = getFullscreenElement();
        if (fs === host) {
            const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
            if (exit) {
                exit.call(document);
                if (screen.orientation && typeof screen.orientation.unlock === 'function') {
                    screen.orientation.unlock();
                }
            }
        } else {
            const req = host.requestFullscreen || host.webkitRequestFullscreen || host.mozRequestFullScreen || host.msRequestFullscreen;
            if (req) {
                req.call(host).then(() => {
                    if (window.screen && screen.orientation && typeof screen.orientation.lock === 'function') {
                        if (window.innerWidth < 1024) { 
                            screen.orientation.lock('landscape').catch(err => {});
                        }
                    }
                }).catch(err => {});
            }
        }
    }
    fullBtn.addEventListener('click', toggleFullscreen);

    state.fsListener = function() {
      const fullBtn = document.getElementById('vidu_fullbtn');
      if (!fullBtn) return;
      const isFullscreen = !!getFullscreenElement();
      if (isFullscreen) {
        fullBtn.innerHTML = exitFullscreenSVG();
        fullBtn.title = 'Exit Fullscreen';
        fullBtn.setAttribute('aria-label', 'Exit Fullscreen');
      } else {
        fullBtn.innerHTML = fullscreenSVG();
        fullBtn.title = 'Fullscreen';
        fullBtn.setAttribute('aria-label', 'Fullscreen');
      }
    };
    document.addEventListener('fullscreenchange', state.fsListener);
    document.addEventListener('webkitfullscreenchange', state.fsListener);
    document.addEventListener('mozfullscreenchange', state.fsListener);
    document.addEventListener('MSFullscreenChange', state.fsListener);

    if (popupBtnEl) {
        popupBtnEl.addEventListener('click', () => {
            if (!state.player || !state.videoId) return;

            const currentTime = state.player.getCurrentTime ? state.player.getCurrentTime() : 0;
            const title = document.getElementById('modal-title') ? document.getElementById('modal-title').textContent : 'VIDU Video';
            
            const url = `${window.location.origin}${window.location.pathname}?popup=true&videoId=${state.videoId}&time=${currentTime}&title=${encodeURIComponent(title)}`;
            
            const popWidth = 400; const popHeight = 225;
            const popTop = window.screen.height - popHeight - 40; const popLeft = window.screen.width - popWidth - 40;
            const features = `width=${popWidth},height=${popHeight},top=${popTop},left=${popLeft},resizable=yes`;
            
            const popupWindow = window.open(url, 'VIDU_Popup_Player', features);

            if (popupWindow) {
                closeModal();
                const loadingOverlay = document.getElementById('popup-player-loading-overlay');
                if (loadingOverlay) loadingOverlay.classList.add('show');
                setTimeout(() => {
                    if (loadingOverlay) loadingOverlay.classList.remove('show');
                    const noticeOverlay = document.getElementById('popup-notice-overlay');
                    if (noticeOverlay) noticeOverlay.classList.add('show');
                    setTimeout(() => { if (noticeOverlay) noticeOverlay.classList.remove('show'); }, 2500);
                }, 1500);
            } else {
                console.warn('Popup blocked by browser or an issue occurred.');
            }
        });
    }

    if (invertBtnEl) {
        invertBtnEl.addEventListener('click', () => {
            if (state.host) {
                state.host.classList.toggle('vidu-player-inverted');
            }
            resetInactivityTimer(false);
        });
    }

    if (document.body.classList.contains('popup-mode')) {
        if(closeBtn) closeBtn.style.display = 'none';
        if(popupBtnEl) popupBtnEl.style.display = 'none';
        if(invertBtnEl) invertBtnEl.style.display = 'none';
        if(playlistToggleBtnEl) playlistToggleBtnEl.style.display = 'none';
        if(prevBtn) prevBtn.style.display = 'none';
        if(nextBtn) nextBtn.style.display = 'none';
    }

    function setOverlayHidden(hidden){ 
        const playlistBtn = document.getElementById('vidu_playlist_toggle_btn');
        if(hidden){ 
            overlay.classList.add('hidden'); ctrlBg.classList.add('hidden'); 
            if(closeBtn) closeBtn.classList.add('hidden'); 
            if(popupBtnEl) popupBtnEl.classList.add('hidden');
            if(state.invertBtnEl) state.invertBtnEl.classList.add('hidden');
            if(playlistBtn) playlistBtn.classList.add('hidden');
            if(playbackMenu) playbackMenu.classList.remove('open');
            if(volumePanel) volumePanel.classList.remove('open');
            if(state.host) state.host.style.cursor = 'none';
        } else { 
            overlay.classList.remove('hidden'); ctrlBg.classList.remove('hidden'); 
            if(closeBtn && !document.body.classList.contains('popup-mode')) closeBtn.classList.remove('hidden'); 
            if(popupBtnEl && !document.body.classList.contains('popup-mode')) popupBtnEl.classList.remove('hidden'); 
            if(state.invertBtnEl && !document.body.classList.contains('popup-mode')) state.invertBtnEl.classList.remove('hidden'); 
            if(playlistBtn && !document.body.classList.contains('popup-mode')) playlistBtn.classList.remove('hidden');
            if(state.host) state.host.style.cursor = '';
        } 
    }
    function showLoading(){ try{ if(loadingDiv){ loadingDiv.classList.remove('hidden'); loadingDiv.style.display = 'flex'; } }catch(e){} }
    function hideLoading(){ try{ if(loadingDiv){ loadingDiv.classList.add('hidden'); setTimeout(()=> { try{ loadingDiv.style.display = 'none'; }catch(e){} }, 320); } }catch(e){} }

    function showOSDFeedback({ icon, text, duration = 1500 }) {
        if (state.osdTimer) clearTimeout(state.osdTimer);
        osdFeedbackEl.innerHTML = `${icon}<span>${text}</span>`;
        osdFeedbackEl.classList.add('visible');
        state.osdTimer = setTimeout(() => {
            osdFeedbackEl.classList.remove('visible');
        }, duration);
    }
    
    function setVolume(newVolume, showOsd = true, showControls = true) {
        if (!state.player || typeof state.player.getVolume !== 'function') return;
        newVolume = Math.max(0, Math.min(100, newVolume));
        
        const currentVolume = state.player.getVolume();
        if (currentVolume > 0 && newVolume > 0) {
            state.lastNonMuteVolume = currentVolume;
        }

        state.player.setVolume(newVolume);
        state.lastVolume = newVolume;
        try { localStorage.setItem('vidu_player_volume', newVolume); } catch(e){}
        if (newVolume > 0 && typeof state.player.unMute === 'function') state.player.unMute();
        if (newVolume === 0 && typeof state.player.mute === 'function') state.player.mute();
        if (showOsd) showOSDFeedback({ icon: newVolume > 0 ? volumeHighSVG() : volumeMuteSVG(), text: `${Math.round(newVolume)}%` });
        resetInactivityTimer(showControls);
    }
    
    function setPlaybackRate(speed) {
        if (state.player && typeof state.player.setPlaybackRate === 'function') {
            state.player.setPlaybackRate(speed);
            showOSDFeedback({ icon: '', text: `${speed}x` });
        }
    }

    state.keyHandler = function(e){
      const active = document.activeElement; const seekIsActive = (active && active.id === 'vidu_seek');
      if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable) && !seekIsActive && active.id !== 'chat-input') return;
      
      const root = document.getElementById('modal-root'); 
      if(!root || (root.style.display === 'none' && !document.body.classList.contains('popup-mode'))) return;
      
      const key = e.key.toLowerCase();
      switch (key) {
        case ' ': e.preventDefault(); if(state.player){ let st = -1; try{ st = state.player.getPlayerState ? state.player.getPlayerState() : -1; }catch(e){} state.desiredPlaying = !(st === 1); resetInactivityTimer(); } break;
        case 'f': if (!document.body.classList.contains('popup-mode')) { e.preventDefault(); toggleFullscreen(); } break;
        case 'm':
            e.preventDefault();
            if (state.player && typeof state.player.getVolume === 'function') {
                const currentVolume = state.player.getVolume();
                if (currentVolume > 0) {
                    state.lastNonMuteVolume = currentVolume;
                    setVolume(0, true, false);
                } else {
                    setVolume(state.lastNonMuteVolume > 0 ? state.lastNonMuteVolume : 100, true, false);
                }
            }
            break;
        case 'n':
          e.preventDefault();
          if (state.host) { state.host.classList.toggle('vidu-player-inverted'); }
          resetInactivityTimer(false);
          break;
        case 'p':
          e.preventDefault();
          const popupBtn = document.getElementById('vidu_popup_btn');
          if (popupBtn) { popupBtn.click(); }
          resetInactivityTimer(false);
          break;
        case 'l':
          e.preventDefault();
          toggleInPlayerPlaylist();
          resetInactivityTimer(false);
          break;
        case 'arrowright': e.preventDefault(); try{ if(state.player && typeof state.player.getCurrentTime === 'function'){ const cur = Number(state.player.getCurrentTime() || 0); const dur = (typeof state.player.getDuration === 'function') ? Number(state.player.getDuration() || 0) : NaN; const target = Number.isFinite(dur) ? Math.min(dur, cur + 10) : cur + 10; if(typeof state.player.seekTo === 'function') state.player.seekTo(target, true); resetInactivityTimer(); if (seekFeedbackRight) { seekFeedbackRight.classList.remove('show'); void seekFeedbackRight.offsetWidth; seekFeedbackRight.classList.add('show'); } } }catch(err){} break;
        case 'arrowleft': e.preventDefault(); try{ if(state.player && typeof state.player.getCurrentTime === 'function'){ const cur = Number(state.player.getCurrentTime() || 0); const target = Math.max(0, cur - 10); if(typeof state.player.seekTo === 'function') state.player.seekTo(target, true); resetInactivityTimer(); if (seekFeedbackLeft) { seekFeedbackLeft.classList.remove('show'); void seekFeedbackLeft.offsetWidth; seekFeedbackLeft.classList.add('show'); }} }catch(err){} break;
        case 'arrowup':
          e.preventDefault();
          const upAmount = e.ctrlKey ? 1 : 5;
          setVolume((state.player.getVolume() || 0) + upAmount, true, false);
          break;
        case 'arrowdown':
          e.preventDefault();
          const downAmount = e.ctrlKey ? 1 : 5;
          setVolume((state.player.getVolume() || 0) - downAmount, true, false);
          break;
        case 'q':
        case 'e':
        case 'w':
          e.preventDefault();
          if(!playbackMenu) break;
          const buttons = Array.from(playbackMenu.querySelectorAll('button[data-speed]'));
          const speeds = buttons.map(b => parseFloat(b.dataset.speed)).sort((a, b) => a - b);
          
          if (key === 'w') {
            const normalSpeedBtn = playbackMenu.querySelector('button[data-speed="1"]');
            if(normalSpeedBtn) normalSpeedBtn.click();
            resetInactivityTimer(false); 
            break; 
          }
          
          const currentRate = state.player.getPlaybackRate();
          let currentIndex = -1;
          for(let i=0; i<buttons.length; i++) {
              if (buttons[i].classList.contains('active')) {
                  currentIndex = i;
                  break;
              }
          }
          if (currentIndex === -1) currentIndex = buttons.findIndex(b => b.dataset.speed === "1");

          let nextIndex;
          if (key === 'e') {
             nextIndex = (currentIndex + 1) % buttons.length;
          } else {
             nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
          }
          if (buttons[nextIndex]) {
            buttons[nextIndex].click();
          }
          resetInactivityTimer(false);
          break;
        case ',':
            e.preventDefault();
            playNextOrPreviousVideo(-1);
            resetInactivityTimer();
            break;
        case '.':
            e.preventDefault();
            playNextOrPreviousVideo(1);
            resetInactivityTimer();
            break;
      }
    };
    document.addEventListener('keydown', state.keyHandler);

    seekEl.addEventListener('pointerdown', ()=> seekEl._drag=true, {passive:true});
    seekEl.addEventListener('pointerup', ()=>{ seekEl._drag=false; }, {passive:true});
    seekEl.addEventListener('change', ()=>{ 
      if(!state.player) return; 
      const dur = state.player.getDuration ? state.player.getDuration() : 0; 
      if(dur) state.player.seekTo(dur * (parseFloat(seekEl.value)/100), true);
      seekEl._drag=false; 
    }, {passive:true});

    function updateSeekUI(el){
      try{
        const v = Math.max(0, Math.min(100, parseFloat(el.value) || 0));
        if(seekProgressEl) seekProgressEl.style.width = `${v}%`;
        if(seekThumbEl) seekThumbEl.style.left = `${v}%`;
      }catch(e){}
    }
    
    seekEl.addEventListener('input', () => {
        if (seekEl._drag) {
            updateSeekUI(seekEl);
            if (state.player) {
                const dur = state.player.getDuration ? state.player.getDuration() : 0;
                if (dur && seekPreviewTime) {
                    const time = dur * (parseFloat(seekEl.value) / 100);
                    seekPreviewTime.textContent = fmtHHMMSS(time);
                }
            }
        }
    }, { passive: true });
    updateSeekUI(seekEl);

    seekContainer.addEventListener('pointermove', (e) => {
        if (!state.player || typeof state.player.getDuration !== 'function' || !seekPreview) return;
        const duration = state.player.getDuration();
        if (!duration || !isFinite(duration)) return;

        const rect = seekContainer.getBoundingClientRect();
        const hoverX = e.clientX - rect.left;
        
        const hoverFraction = Math.max(0, Math.min(1, hoverX / rect.width));
        const time = hoverFraction * duration;
        if (seekPreviewTime) {
            seekPreviewTime.textContent = fmtHHMMSS(time);
        }

        const previewWidth = seekPreview.offsetWidth;
        let previewLeft = hoverX - (previewWidth / 2);
        
        previewLeft = Math.max(0, previewLeft);
        previewLeft = Math.min(rect.width - previewWidth, previewLeft);
        
        seekPreview.style.setProperty('--preview-x', `${previewLeft}px`);
    });

    playBtn.addEventListener('click', ()=>{
      if(!state.player) return;
      let st = -1;
      try { st = state.player.getPlayerState ? state.player.getPlayerState() : -1; } catch(e){}
      state.desiredPlaying = !(st === 1);
      resetInactivityTimer();
    });

    function resetInactivityTimer(showControls = true){
        state.lastActivity = Date.now();
        if (showControls) {
          setOverlayHidden(false);
        }
    
        if(state.inactivityTimer) { clearTimeout(state.inactivityTimer); }
    
        const hideInactiveControls = () => {
            try {
                const isMenuOpen = playbackMenu.classList.contains('open') || volumePanel.classList.contains('open');
                const isDragging = seekEl._drag;
    
                if (isMenuOpen || isDragging) {
                    state.inactivityTimer = setTimeout(hideInactiveControls, 3000);
                    return;
                }
    
                // Always hide top shortcut controls
                if(closeBtn) closeBtn.classList.add('hidden');
                if(popupBtnEl) popupBtnEl.classList.add('hidden');
                if(state.invertBtnEl) state.invertBtnEl.classList.add('hidden');
                if(playlistToggleBtnEl) playlistToggleBtnEl.classList.add('hidden');
    
                let isBuffering = false;
                if (state.player && typeof state.player.getPlayerState === 'function') {
                    isBuffering = (state.player.getPlayerState() === 3);
                }
    
                if (!isBuffering) {
                    // Hide bottom controls if not buffering
                    overlay.classList.add('hidden');
                    ctrlBg.classList.add('hidden');
                    if(state.host) state.host.style.cursor = 'none';
                } else {
                    // If buffering, reschedule the check to keep controls visible
                    state.inactivityTimer = setTimeout(hideInactiveControls, 3000);
                }
    
                if(playbackMenu) playbackMenu.classList.remove('open');
                if(volumePanel) volumePanel.classList.remove('open');
    
            } catch(e) {
                console.error("Error in hideInactiveControls:", e);
            }
        };
    
        state.inactivityTimer = setTimeout(hideInactiveControls, 3000);
    }
    
    function attachActivityListeners(){ 
        ['mousemove','pointermove','touchstart','touchmove','mousedown'].forEach(ev=>{ host.addEventListener(ev, resetInactivityTimer, {passive:true}); document.addEventListener(ev, resetInactivityTimer, {passive:true}); });
        
        const throttledWheelHandler = throttle((e) => {
            const delta = e.deltaY > 0 ? -5 : 5;
            setVolume(state.player.getVolume() + delta, true, false);
        }, 50);
        host.addEventListener('wheel', (e) => {
            e.preventDefault();
            throttledWheelHandler(e);
        }, { passive: false });
        
        const throttledTouchMoveHandler = throttle((e) => {
            if (!state.touch_isSwiping || state.touch_swipeMode !== 'seek') return;
            const touch = e.touches[0];
            const rect = host.getBoundingClientRect();
            
            const deltaX = touch.clientX - state.touch_startX;
            const duration = state.player.getDuration();
            const seekChange = (deltaX / rect.width) * (duration / 2);
            const targetTime = Math.max(0, Math.min(duration, state.touch_seekStartTime + seekChange));
            const seekText = fmtHHMMSS(targetTime) + " / " + fmtHHMMSS(duration);
            showOSDFeedback({ icon: (seekChange > 0 ? ffwdSVG() : rewindSVG()), text: seekText, duration: 500 });
            
        }, 50);

        host.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) return;
            const now = Date.now();
            const touch = e.touches[0];
            const rect = host.getBoundingClientRect();
            const tapX = touch.clientX - rect.left;
            
            if (now - state.touch_lastTapTime < 300 && Math.abs(tapX - state.touch_lastTapX) < 50) {
                if (getFullscreenElement() || document.body.classList.contains('popup-mode')) {
                    if (!state.player) return;
                    const isRightSide = tapX > rect.width / 2;
                    const currentTime = state.player.getCurrentTime();
                    const duration = state.player.getDuration();
                    if (isRightSide) {
                        state.player.seekTo(Math.min(duration, currentTime + 10), true);
                        seekFeedbackRight.classList.remove('show'); void seekFeedbackRight.offsetWidth; seekFeedbackRight.classList.add('show');
                    } else {
                        state.player.seekTo(Math.max(0, currentTime - 10), true);
                        seekFeedbackLeft.classList.remove('show'); void seekFeedbackLeft.offsetWidth; seekFeedbackLeft.classList.add('show');
                    }
                }
            }
            
            state.touch_lastTapTime = now;
            state.touch_lastTapX = tapX;
            state.touch_startX = touch.clientX;
            state.touch_startY = touch.clientY;
            state.touch_isSwiping = false;
            state.touch_swipeMode = null;
            if (state.player) {
                state.touch_seekStartTime = state.player.getCurrentTime();
                state.touch_startVolume = state.player.getVolume();
            }
            resetInactivityTimer();
        }, { passive: true });
        
        host.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) return;
            if (!state.touch_isSwiping) {
                const deltaX = e.touches[0].clientX - state.touch_startX;
                const deltaY = e.touches[0].clientY - state.touch_startY;
                if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                    state.touch_isSwiping = true;
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        state.touch_swipeMode = 'seek';
                    } else {
                        state.touch_swipeMode = null;
                    }
                }
            }
            if(state.touch_isSwiping){
              e.preventDefault();
              setOverlayHidden(true);
              throttledTouchMoveHandler(e);
            }
        }, { passive: false });

        host.addEventListener('touchend', (e) => {
            if (state.touch_isSwiping && state.touch_swipeMode === 'seek') {
                const rect = host.getBoundingClientRect();
                const deltaX = e.changedTouches[0].clientX - state.touch_startX;
                const duration = state.player.getDuration();
                const seekChange = (deltaX / rect.width) * (duration / 2);
                const targetTime = Math.max(0, Math.min(duration, state.touch_seekStartTime + seekChange));
                state.player.seekTo(targetTime, true);
            }
            if (state.osdTimer) clearTimeout(state.osdTimer);
            state.osdTimer = setTimeout(() => { osdFeedbackEl.classList.remove('visible'); }, 500);
            
            state.touch_isSwiping = false;
            state.touch_swipeMode = null;
            resetInactivityTimer();
        }, { passive: true });
    }
    attachActivityListeners();

    function updatePlayerUI() {
        if (!state.player || !document.body.contains(state.host)) { destroyPlayer(); return; }
        try {
            const st = state.player.getPlayerState ? state.player.getPlayerState() : -1;
            const dur = state.player.getDuration ? state.player.getDuration() : 0;
            const cur = state.player.getCurrentTime ? state.player.getCurrentTime() : 0;
            const vol = state.player.getVolume ? Math.round(state.player.getVolume()) : state.lastVolume;

            if (vol !== state.lastVolumeLevel) {
                let icon;
                if (vol === 0 || state.player.isMuted()) icon = volumeMuteSVG();
                else if (vol <= 33) icon = volumeLowSVG();
                else if (vol <= 66) icon = volumeMidSVG();
                else icon = volumeHighSVG();
                volumeBtn.innerHTML = icon;
                volumeSlider.value = vol;
                state.lastVolumeLevel = vol;
            }

            const flooredCur = Math.floor(cur);
            if (flooredCur !== state.lastTime) {
                curEl.textContent = fmtHHMMSS(flooredCur);
                state.lastTime = flooredCur;
            }

            const flooredDur = Math.floor(dur);
            if (dur && isFinite(dur) && flooredDur !== state.lastDuration) {
                durEl.textContent = fmtHHMMSS(flooredDur);
                state.lastDuration = flooredDur;
            }

            if (!seekEl._drag && dur && isFinite(dur)) {
                seekEl.value = (cur / Math.max(1, dur)) * 100;
                updateSeekUI(seekEl);
            }
            
            if (state.desiredPlaying !== null) {
              if(state.desiredPlaying && st !== 1){
                try{ state.player.playVideo(); }catch(e){}
              } else if(!state.desiredPlaying && st === 1){
                try{ state.player.pauseVideo(); }catch(e){}
              }
            }

            if (st !== state.lastPlayerState) {
                const isPlaying = (st === 1);
                const currentIcon = isPlaying ? pauseSVG() : playSVG();
                playBtn.innerHTML = currentIcon;
                playBtn.setAttribute('aria-label', isPlaying ? 'Pause' : 'Play');
                state.lastPlayerState = st;
            }

            const now = Date.now();
            const isPlaying = (st === 1);
            if (state.videoId && isPlaying && now - (state.lastSaveTime || 0) > 60000) {
                if (cur > 1) {
                    window.saveVideoProgress(state.videoId, cur);
                    state.lastSaveTime = now;
                }
            }

        } catch (e) {}
        state.animationFrameId = requestAnimationFrame(updatePlayerUI);
    }

    return loadYTApi().then(()=> new Promise((resolve,reject)=>{
      if(state.player && typeof state.player.destroy === 'function'){ try{ state.player.destroy(); }catch(e){} state.player = null; }
      try{
        state.player = new YT.Player(mount.id, { 
          videoId: videoId, 
          width: '100%', 
          height: '100%', 
          playerVars: { 
            controls: 0, 
            disablekb: 1, 
            rel: 0, 
            modestbranding: 1, 
            playsinline: 1, 
            iv_load_policy: 3, 
            origin: location.origin,
            start: Math.floor(startTime)
          },
          events: {
            onReady: function(evt){
              disableIframeClicks(host); showLoading();
              setVolume(state.lastVolume, false);
              
              // Set initial active speed button
              const initialSpeed = state.player.getPlaybackRate();
              const initialActiveButton = playbackMenu.querySelector(`.speed-option[data-speed="${initialSpeed}"]`) || playbackMenu.querySelector('.speed-option[data-speed="1"]');
              if(initialActiveButton) {
                speedOptions.forEach(btn => btn.classList.remove('active'));
                initialActiveButton.classList.add('active');
              }

              updatePlaylistHighlight();
              updateNavTooltips();
              try{ if(typeof evt.target.setPlaybackQuality === 'function'){ evt.target.setPlaybackQuality('default'); } }catch(e){}
              try{ evt.target.playVideo(); }catch(e){}
              if(state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
              updatePlayerUI();
              if(state.mo) state.mo.disconnect();
              state.mo = new MutationObserver(()=> disableIframeClicks(host));
              state.mo.observe(host, { childList:true, subtree:true });
              resetInactivityTimer();
              resolve(evt.target);
            },
            onStateChange: function(e){
              try{
                if (state.host) {
                    if (e.data === 1) { 
                        state.host.classList.add('is-playing');
                    } else {
                        state.host.classList.remove('is-playing');
                    }
                }
                
                if (state.seekTrackEl) {
                    if (e.data === 3) {
                      state.seekTrackEl.classList.add('buffering'); 
                    } else { 
                      state.seekTrackEl.classList.remove('buffering'); 
                    }
                }
                if(e && e.data === 1){
                  try{ hideLoading(); }catch(e){} 
                }
                 if(e.data === 0) { // Video ended
                    playNextOrPreviousVideo(1);
                 }
              }catch(err){}
            },
            onError: function(err){
              if (state.seekTrackEl) { state.seekTrackEl.classList.remove('buffering'); }
              try{ const ld = document.getElementById('vidu_loading'); if(ld){ ld.classList.add('hidden'); ld.style.display='none'; } }catch(_){} console.error('YT player error', err);
            }
          }
        });
      }catch(err){ reject(err || new Error('YT player creation failed')); }
    })).catch(err=>{ throw err; }).then(p=>{ setTimeout(()=> resetInactivityTimer(), 40); return p; });
  }

  function destroyPlayer(){
    try{
      const panel = document.getElementById('vidu_playlist_panel');
      if (panel) { panel.classList.remove('show'); panel.innerHTML = ''; }
      const btn = document.getElementById('vidu_playlist_toggle_btn');
      if (btn) btn.classList.remove('active');

      if (state.seekTrackEl) { state.seekTrackEl.classList.remove('buffering'); }
      
      if (state.player && state.videoId && typeof state.player.getCurrentTime === 'function') {
        const cur = state.player.getCurrentTime();
        const dur = state.player.getDuration ? state.player.getDuration() : 0;
        if (cur > 1 && dur > 0 && dur - cur > 5) {
          window.saveVideoProgress(state.videoId, cur);
        } else {
          window.saveVideoProgress(state.videoId, 0);
        }
      }

      // CHANGE 2: Save the last played video's info to localStorage when the player is closed.
      if (state.videoId) {
        const videoTitle = document.getElementById('modal-title')?.textContent;
        if (videoTitle) { 
            const lastPlayedInfo = {
                videoId: state.videoId,
                title: videoTitle,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem('vidu_last_played_video', JSON.stringify(lastPlayedInfo));
                // Make the button visible now that there's a video to play
                const lastPlayedBtn = document.getElementById('play-last-video-btn');
                if (lastPlayedBtn) lastPlayedBtn.style.display = 'flex';
            } catch(e) { console.error("Failed to save last played video info", e); }
        }
      }

      if(state.animationFrameId){ cancelAnimationFrame(state.animationFrameId); state.animationFrameId = null; }
      if(state.keyHandler){ document.removeEventListener('keydown', state.keyHandler); state.keyHandler = null; }
      if(state.docClickHandler){ document.removeEventListener('click', state.docClickHandler); state.docClickHandler = null; }
      if(state.player){ try{ state.player.destroy(); }catch(e){} state.player = null; }
      if(state.mo){ try{ state.mo.disconnect(); }catch(e){} state.mo = null; }
      if(state.fsResizeHandler){ window.removeEventListener('resize', state.fsResizeHandler); state.fsResizeHandler = null; }
      if(state.fsListener){ document.removeEventListener('fullscreenchange', state.fsListener); document.removeEventListener('webkitfullscreenchange', state.fsListener); document.removeEventListener('mozfullscreenchange', state.fsListener); document.removeEventListener('MSFullscreenChange', state.fsListener); state.fsListener = null; }
      if(state.inactivityTimer){ clearTimeout(state.inactivityTimer); state.inactivityTimer = null; }
      if(state.osdTimer){ clearTimeout(state.osdTimer); state.osdTimer = null; }
      if(state.popupCheckInterval) { clearInterval(state.popupCheckInterval); state.popupCheckInterval = null; }
      
      state.invertBtnEl = null;

      if(state.host){ 
          state.host.classList.remove('is-playing');
          try{ 
              state.host.removeEventListener('wheel', null); state.host.removeEventListener('touchstart', null);
              state.host.removeEventListener('touchmove', null);
              state.host.removeEventListener('touchend', null);
          } catch(e){} 
      }
      if(state.host){ try{ state.host.remove(); }catch(e){} state.host = null; state.mount = null; }
      
      state.videoId = null;
      state.lastSaveTime = 0;
    }catch(e){}
  }

  window.showViduPlayer = function(videoId, startTime = 0){ if(typeof window.loadYTApi !== 'function') { window.loadYTApi = loadYTApi; } return createPlayer(videoId, startTime).catch(err => { console.error('createPlayer failed', err); throw err; }); };
  window.destroyViduPlayer = function(){ destroyPlayer(); const w = document.getElementById('player-wrap'); if(w) w.innerHTML = ''; };
  window.addEventListener('beforeunload', ()=> { try{ window.destroyViduPlayer(); }catch(e){} }, {passive:true});
})();
</script>
<script>
/*************************************************************************
 * Playlist data + UI + modal + YouTube playlist fetching
 *************************************************************************/
(function() {
    window.viduPopupWindow = null;
    let wrapperElement = null;

    // NEW: Function to apply zoom based on playlist depth
    function updateZoomLevel() {
        try {
            const contentSection = document.getElementById('home'); // This is our <section id="home" ...>
            if (!contentSection) return;

            // Get the depth from the playlist stack's length
            const depth = (window.__viduGlobal && window.__viduGlobal.playlistStack) ? window.__viduGlobal.playlistStack.length : 0;
            
            // Define how much to zoom per level. 0.15 = 15% zoom per level.
            const zoomPerLevel = 0.15; 
            const newScale = 1 + (depth * zoomPerLevel);

            // Apply the CSS transform
            contentSection.style.transform = `scale(${newScale})`;
        } catch (e) {
            console.error("Failed to update zoom level:", e);
        }
    }

    window.handlePlayerLaunch = function() {
        if (!wrapperElement) {
            const wrapper = document.getElementById('wrapper');
            if (wrapper) {
                wrapperElement = wrapper;
                wrapper.remove();
            }
        }
    };

    window.handlePlayerClose = function() {
        const modalRoot = document.getElementById('modal-root');
        const fsPlaylist = document.getElementById('fullscreen-playlist-overlay');
        
        const isPlayerActive = (modalRoot && modalRoot.style.display !== 'none') || (fsPlaylist && fsPlaylist.classList.contains('show'));

        if (!isPlayerActive && wrapperElement && !document.getElementById('wrapper')) {
            document.body.insertBefore(wrapperElement, document.getElementById('modal-root'));
            (function stagger(){ const cards=document.querySelectorAll('.list-item'); cards.forEach((c,i)=> c.style.animationDelay=(i*60)+'ms'); })();
            wrapperElement = null;
        }
    };

    const playlists = [ { id: 0, name: 'SUBJECTS', thumbnail: 'https://i.pinimg.com/736x/71/82/6e/71826ec9ece9f33d9034bb0acd3b8d1f.jpg', videos: [ { id: 1, name: 'ET', thumbnail: 'https://i.pinimg.com/736x/19/b2/42/19b2424009813fc558e8a785c794cbdf.jpg', videos: [ { name:'', thumbnail:'https://i.pinimg.com/736x/19/b2/42/19b2424009813fc558e8a785c794cbdf.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82enZEX0A4SQVvRzEEFj8eAEZGAlA/WkIGNk4VIgs9WWlhent5Pl81JjhB", passEnc: "" }, { name:'', thumbnail:'https://i.pinimg.com/736x/ea/60/d8/ea60d83595332fe2a7d11f1844072251.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dFNrdjcTAhYmOlUACF0XEFRJZVkiCkIGNk4LOUBXQDRCQnRSMi4wMmYp", passEnc: "" } ] }, { id: 2, name: 'SFT', thumbnail: 'https://i.pinimg.com/736x/b8/de/57/b8de57f639bb30fd9f48cda542dd96d2.jpg', videos: [ { name:'', thumbnail:'https://i.pinimg.com/736x/2d/9d/1a/2d9d1a4affd566269879267ca70b74b8.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dQkGUzsDJUIpXlMNBVBBN0ZnWAM6IUIGNk41NioUP21FXHtcGDYQIAUe", passEnc: "" }, { name:'', thumbnail:'https://i.pinimg.com/736x/42/9d/84/429d847241cfba744292224956707f45.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82d11cAxxZK01oQz06HiMmPkFpc3cyW0IGNk4TCT08RCt5AHdYQyU+AywV", passEnc: "" }, { name:'', thumbnail:'https://i.pinimg.com/736x/1f/24/4e/1f244ec99cab31c5d72348a736d361df.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dUQDDD4zXQIlOhIgXzMlAHN+Ak9PIkIGNk5VCTgGQRdmUQQNIQwVTWpC", passEnc: "" } ] }, { id: 3, name: 'ICT', thumbnail: 'https://i.pinimg.com/736x/81/f4/0d/81f40de2906f0c61f2f17d6db61d7271.jpg', videos: [ { name:'', thumbnail:'https://i.pinimg.com/736x/81/f4/0d/81f40de2906f0c61f2f17d6db61d7271.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dGVabCUtAhwaJTMuBycWPABxW0IGKkIGNk5UBEpVGytfan1tEhlVHRos", passEnc: "" } ] } ] } ];
    function b64decode(s){ try{ return atob(s); }catch(e){ return s; } }
    const decodeEnc = (function(){ const key = new TextEncoder().encode('vidu_secret_2025'); function xorDecode(bytes){ const out = new Uint8Array(bytes.length); for(let i=0;i<bytes.length;i++) out[i] = bytes[i] ^ key[i % key.length]; return out; } return function(encStr){ try{ if(!encStr) return ''; const raw = atob(encStr); const bytes = new Uint8Array(raw.split('').map(c=>c.charCodeAt(0))); const dec = xorDecode(bytes); return new TextDecoder().decode(dec); }catch(e){ return ''; } }; })();
    
    window.getVideoProgress = function(videoId) {
        if (!videoId) return 0;
        try {
            const progress = JSON.parse(localStorage.getItem('vidu_video_progress') || '{}');
            return progress[videoId] || 0;
        } catch (e) {
            console.warn('Could not get video progress', e);
            return 0;
        }
    }

    window.saveVideoProgress = function(videoId, time) {
        if (!videoId) return;
        try {
            const progress = JSON.parse(localStorage.getItem('vidu_video_progress') || '{}');
            if (time > 1) {
                progress[videoId] = time;
            } else {
                delete progress[videoId];
            }
            localStorage.setItem('vidu_video_progress', JSON.stringify(progress));
        } catch (e) {
            console.error("Failed to save video progress", e);
        }
    }

    function renderPlaylists(){
      const ul = document.getElementById('playlist-list');
      if(!ul) return;
      ul.innerHTML = '';
      if(!playlists || playlists.length === 0){ ul.innerHTML = '<li class="muted">No playlists available.</li>'; return; }
      playlists.forEach(pl=>{
        const li = document.createElement('li'); li.className='list-item ripple';
        li.innerHTML = `<img src="${escapeHtml(pl.thumbnail)}" alt="${escapeHtml(pl.name)}" /><span class="title">${escapeHtml(pl.name)}</span>`;
        li.addEventListener('click', (ev)=>{ spawnRipple(ev, li); showPlaylistVideos(pl); });
        ul.appendChild(li);
      });
      ul.style.display = 'flex';
    }

    function showPlaylistVideos(pl, skipPush){
      const ul = document.getElementById('playlist-list');
      const container = document.getElementById('playlist-videos');
      if(!container || !ul) return;
      if(!window.__viduGlobal) window.__viduGlobal = {};
      if(!window.__viduGlobal.playlistStack) window.__viduGlobal.playlistStack = [];
      if(!skipPush){ window.__viduGlobal.playlistStack.push(window.__viduGlobal.currentPl || null); }
      window.__viduGlobal.currentPl = pl;

      updateZoomLevel(); // NEW: Call the zoom function

      ul.style.display = 'none';
      container.style.display = 'block';
      container.innerHTML = `<h3 style="text-align:center;color:#fff;">${escapeHtml(pl.name)}</h3>`;
      const vids = document.createElement('ul'); vids.className='list-container';
      (pl.videos||[]).forEach(v=>{
        const vli = document.createElement('li'); vli.className='list-item ripple';
        const thumb = v.thumbnail || '';
        vli.innerHTML = `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(v.name)}" /><span class="title">${escapeHtml(v.name)}</span>`;
        if(v && Array.isArray(v.videos)){
          vli.addEventListener('click',(ev)=>{ spawnRipple(ev, vli); showPlaylistVideos(v); });
        } else {
          vli.addEventListener('click',(ev)=>{
            spawnRipple(ev, vli);
            const expectedPassword = b64decode(v.passEnc || '');
            if (expectedPassword === '') {
              currentItem = v;
              showUnlockedItem(v);
            } else {
              openPasswordModal(v);
            }
          });
        }
        vids.appendChild(vli);
      });
      const back = document.createElement('div'); back.style.textAlign='center'; back.style.marginTop='16px';
      back.innerHTML = `<button id="back-to-playlists" class="btn secondary">Back</button>`;
      container.appendChild(vids); container.appendChild(back);
      document.getElementById('back-to-playlists').onclick = ()=>{
        const prev = (window.__viduGlobal.playlistStack && window.__viduGlobal.playlistStack.length) ? window.__viduGlobal.playlistStack.pop() : null;
        
        updateZoomLevel(); // NEW: Call the zoom function after popping

        if(prev === null){ ul.style.display='flex'; container.style.display='none'; window.__viduGlobal.currentPl = null; }
        else { showPlaylistVideos(prev, true); }
      };
    }

    function spawnRipple(ev,target){ const rect = target.getBoundingClientRect(); const drop = document.createElement('div'); drop.className = 'drop'; drop.style.left = (ev.clientX - rect.left) + 'px'; drop.style.top = (ev.clientY - rect.top) + 'px'; target.appendChild(drop); setTimeout(()=> drop.remove(),700); }

    let currentItem = null;
    let currentPlaylistCache = {};

    window.createModal = function(){
      const root = document.getElementById('modal-root');
      root.innerHTML = `<div class="modal-backdrop" id="modal-backdrop">
        <div class="player-context">
            <div class="modal" role="dialog" aria-modal="true">
                <div class="controls">
                    <div><strong id="modal-title">Locked</strong><div class="muted" id="modal-subtitle" style="color:#bbb;font-size:12px;"></div></div>
                    <div><button id="modal-close" class="btn secondary">Close</button></div>
                </div>
                <div id="modal-body">
                    <div id="password-block">
                        <div style="color:#bbb;margin-bottom:8px;">This item is password-protected.</div>
                        <div class="password-row">
                            <input id="password-input" type="password" placeholder="Enter password" />
                            <button id="password-submit" class="btn">Unlock</button>
                        </div>
                        <div id="password-error" style="margin-top:8px;color:#f66;display:none;"></div>
                    </div>
                    <div id="player-block" style="display:none;margin-top:12px;"><div id="player-wrap"></div></div>
                </div>
            </div>
            <div id="vidu_playlist_panel" class="vidu-playlist-panel"></div>
        </div>
      </div>`;
      document.getElementById('modal-close').onclick = closeModal;
      document.getElementById('password-submit').onclick = onPasswordSubmit;
      document.getElementById('password-input').onkeydown = (e)=>{ if(e.key === 'Enter') onPasswordSubmit(); };
      document.getElementById('modal-backdrop').onclick = function(e){ if(e.target === this) closeModal(); };
    }

    function showUnlockedItem(item) {
      if (item.type === 'playlist') {
        openFullScreenPlaylist(item);
      } else {
        const id = decodeEnc(item.idEnc || '');
        playVideoWithLoading({ videoId: id, title: item.name || 'Video' });
      }
    }

    function openPasswordModal(item){
      window.handlePlayerLaunch();
      currentItem = item;
      const root = document.getElementById('modal-root');
      root.style.display = 'block';
      document.getElementById('modal-title').textContent = item.name || 'Protected';
      document.getElementById('modal-subtitle').textContent = (item.type || 'video') + ' — password required';
      document.getElementById('password-input').value = '';
      document.getElementById('password-error').style.display = 'none';
      document.getElementById('password-block').style.display = 'block';
      document.getElementById('player-block').style.display = 'none';
      setTimeout(()=>document.getElementById('password-input').focus(), 50);
    }

    window.closeModal = function(){
      const root = document.getElementById('modal-root');
      if(root) {
        root.style.display = 'none';
        root.style.visibility = 'visible';
      }
      if(window.destroyViduPlayer) try{ window.destroyViduPlayer(); }catch(e){}
      if (currentItem && currentItem.type === 'playlist') {
        const fsPlaylist = document.getElementById('fullscreen-playlist-overlay');
        if (fsPlaylist) fsPlaylist.classList.add('show');
      } else {
        currentItem = null;
      }
      window.handlePlayerClose();
    }

    function onPasswordSubmit(){
      const val = (document.getElementById('password-input').value || '').trim();
      if(!currentItem) return;
      const expected = b64decode(currentItem.passEnc || '');
      if(val === expected){
        const root = document.getElementById('modal-root');
        if(root) root.style.display = 'none';
        showUnlockedItem(currentItem);
      } else {
        const err = document.getElementById('password-error'); err.style.display = 'block'; err.textContent = 'Incorrect password — try again.';
      }
    }
    
    // NEW: Function to parse ISO 8601 duration from YouTube API
    function parseISO8601Duration(isoString) {
        const regex = /P(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)W)?(?:(\d+)D)?T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?/;
        const matches = isoString.match(regex);
        if (!matches) return '00:00:00';

        const hours = parseInt(matches[5] || 0);
        const minutes = parseInt(matches[6] || 0);
        const seconds = parseInt(matches[7] || 0);

        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    const YT_API_KEY = 'AIzaSyB8UVKOZOnUnYdqbFGOtlg6BPfR9HpD35c';
    
    // UPDATED: Fetches playlist videos with their durations
    async function fetchPlaylistVideos(playlistId) {
        if (!YT_API_KEY || YT_API_KEY === 'YOUR_API_KEY_HERE') throw new Error('No API key configured.');
        if (currentPlaylistCache[playlistId]) return currentPlaylistCache[playlistId];

        const videoIds = [];
        let pageToken = '';
        do {
            const playlistItemsUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${encodeURIComponent(playlistId)}&key=${encodeURIComponent(YT_API_KEY)}` + (pageToken ? `&pageToken=${pageToken}` : '');
            const res = await fetch(playlistItemsUrl);
            if (!res.ok) { const txt = await res.text().catch(() => null); throw new Error(`YouTube API error: ${res.status} ${txt || ''}`); }
            const data = await res.json();
            (data.items || []).forEach(it => {
                if (it.snippet && it.snippet.resourceId && it.snippet.resourceId.videoId && it.snippet.title !== 'Private video' && it.snippet.title !== 'Deleted video') {
                    videoIds.push(it.snippet.resourceId.videoId);
                }
            });
            pageToken = data.nextPageToken || '';
        } while (pageToken);

        if (videoIds.length === 0) return [];

        const videoDetails = {};
        for (let i = 0; i < videoIds.length; i += 50) {
            const chunk = videoIds.slice(i, i + 50);
            const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${chunk.join(',')}&key=${encodeURIComponent(YT_API_KEY)}`;
            const res = await fetch(videosUrl);
            if (!res.ok) { const txt = await res.text().catch(() => null); throw new Error(`YouTube API error: ${res.status} ${txt || ''}`); }
            const data = await res.json();
            (data.items || []).forEach(item => {
                videoDetails[item.id] = item;
            });
        }

        const finalItems = videoIds.map(id => {
            const detail = videoDetails[id];
            if (!detail) return null;
            const sn = detail.snippet || {};
            const thumb = (sn.thumbnails && (sn.thumbnails.high || sn.thumbnails.medium || sn.thumbnails.default)) || {};
            const duration = detail.contentDetails ? parseISO8601Duration(detail.contentDetails.duration) : '00:00:00';
            return {
                videoId: id,
                title: sn.title || 'Untitled',
                thumb: thumb.url || `https://img.youtube.com/vi/${id}/hqdefault.jpg`,
                duration: duration
            };
        }).filter(Boolean);

        currentPlaylistCache[playlistId] = finalItems;
        return finalItems;
    }

    async function openFullScreenPlaylist(item) {
      window.handlePlayerLaunch();
      const overlay = document.getElementById('fullscreen-playlist-overlay');
      const titleEl = document.getElementById('fs-playlist-title');
      const countEl = document.getElementById('fs-playlist-count');
      const contentEl = document.getElementById('fs-playlist-content');
      const loaderEl = document.getElementById('fs-playlist-loader');
      titleEl.textContent = item.name || 'Playlist';
      countEl.textContent = '... Videos';
      contentEl.innerHTML = '';
      loaderEl.style.display = 'flex';
      overlay.classList.add('show');
      const rawId = decodeEnc(item.idEnc);
      const playlistId = rawId.split('&')[0];
      try {
        const videos = await fetchPlaylistVideos(playlistId);
        if (!window.__viduGlobal) window.__viduGlobal = {};
        window.__viduGlobal.lastOpenedPlaylist = { videos, title: item.name };
        renderFullScreenPlaylist(videos, item.name);
      } catch (err) {
        console.error('Playlist fetch error', err);
        contentEl.innerHTML = `<p style="text-align:center; color: var(--muted);">Failed to load playlist: ${escapeHtml(err.message)}</p>`;
      } finally {
        loaderEl.style.display = 'none';
      }
    }
    
    // UPDATED: Renders playlist items with duration
    function renderFullScreenPlaylist(videos, title) {
      const titleEl = document.getElementById('fs-playlist-title');
      const countEl = document.getElementById('fs-playlist-count');
      const contentEl = document.getElementById('fs-playlist-content');
      titleEl.textContent = title || 'Playlist';
      countEl.textContent = `${videos.length} Videos`;
      contentEl.innerHTML = '';
      const fragment = document.createDocumentFragment();
      videos.forEach((video, index) => {
        const li = document.createElement('div');
        li.className = 'fs-playlist-item';
        li.innerHTML = `
            <div class="fs-video-thumbnail">
                <img src="${escapeHtml(video.thumb)}" alt="">
                <span class="fs-video-number">${index + 1}</span>
                <span class="fs-video-duration">${escapeHtml(video.duration)}</span>
            </div>
            <div class="title">${escapeHtml(video.title)}</div>
        `;
        li.onclick = () => playVideoWithLoading({ videoId: video.videoId, title: video.title });
        fragment.appendChild(li);
      });
      contentEl.appendChild(fragment);
    }

    window.playVideoWithLoading = function(videoInfo) {
      if (typeof window.incrementWatchCount === 'function') {
        window.incrementWatchCount();
      }
      if (window.viduPopupWindow && !window.viduPopupWindow.closed) {
          window.__vidu_prevent_popup_restore = true;
          window.viduPopupWindow.close();
          window.viduPopupWindow = null;
          const noticeOverlay = document.getElementById('popup-notice-overlay');
          if (noticeOverlay) noticeOverlay.classList.remove('show');
      }

      window.handlePlayerLaunch();
      const fsPlaylist = document.getElementById('fullscreen-playlist-overlay');
      const loadingPopup = document.getElementById('player-loading-overlay');
      const loadingBar = document.getElementById('player-loading-bar-fill');
      const root = document.getElementById('modal-root');

      fsPlaylist.classList.remove('show');
      
      const savedTime = videoInfo.startTime || getVideoProgress(videoInfo.videoId) || 0;
      const isRestoring = savedTime > 0;
      
      const restoringPopup = isRestoring ? document.getElementById('restoring-position-overlay') : null;
      const restoringBar = isRestoring ? document.getElementById('restoring-bar-fill') : null;

      if (isRestoring && restoringPopup) {
        restoringPopup.classList.add('show');
        restoringBar.style.transition = 'none';
        restoringBar.style.width = '0%';
        setTimeout(() => {
          restoringBar.style.transition = 'width 1.5s cubic-bezier(0.25, 1, 0.5, 1)';
          restoringBar.style.width = '100%';
        }, 10);
        setTimeout(() => {
          restoringPopup.classList.remove('show');
        }, 1500);
      } else {
          loadingPopup.classList.add('show');
          loadingBar.style.transition = 'none';
          loadingBar.style.width = '0%';
          setTimeout(() => {
            loadingBar.style.transition = 'width 2s cubic-bezier(0.25, 0.1, 0.25, 1)';
            loadingBar.style.width = '90%';
          }, 50);
      }

      root.style.display = 'block';
      root.style.visibility = 'hidden';
      document.getElementById('modal-title').textContent = videoInfo.title;
      document.getElementById('modal-subtitle').textContent = 'Now Playing';
      document.getElementById('password-block').style.display = 'none';
      document.getElementById('player-block').style.display = 'block';

      if (window.showViduPlayer) {
        window.showViduPlayer(videoInfo.videoId, savedTime)
          .then(player => {
            if (!isRestoring) {
              loadingBar.style.transition = 'width 0.3s ease-out';
              loadingBar.style.width = '100%';
            }

            setTimeout(() => {
              if (!isRestoring) loadingPopup.classList.remove('show');
              root.style.visibility = 'visible';
              setTimeout(() => {
                loadingBar.style.transition = 'none';
                loadingBar.style.width = '0%';
              }, 300);
            }, isRestoring ? 50 : 300);
          })
          .catch(err => {
            console.error('showViduPlayer failed', err);
            loadingPopup.classList.remove('show');
            if(restoringPopup) restoringPopup.classList.remove('show');
            root.style.visibility = 'visible';
            window.handlePlayerClose();
            const wrap = document.getElementById('player-wrap');
            if (wrap) wrap.innerHTML = `<div class="muted">Failed to load player: ${escapeHtml(err.message || '')}</div>`;
          });
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      if (!document.body.classList.contains('popup-mode')) {
        createModal();
        renderPlaylists();
        (function stagger(){ const cards=document.querySelectorAll('.list-item'); cards.forEach((c,i)=> c.style.animationDelay=(i*60)+'ms'); })();
      }
      document.getElementById('fs-playlist-close-btn').addEventListener('click', () => {
        document.getElementById('fullscreen-playlist-overlay').classList.remove('show');
        currentItem = null;
        window.handlePlayerClose();
      });
    });

    document.addEventListener('contextmenu', e => e.preventDefault(), false);
    document.addEventListener('keydown', e => { if ((e.ctrlKey && e.shiftKey && (e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j')) || (e.ctrlKey && (e.key==='U'||e.key==='u')) || (e.key==='F12')) e.preventDefault(); });
    document.addEventListener('keydown', e => { 
        if (e.key === 'Escape') { 
            const aiOverlay = document.getElementById('ai-assistant-overlay');
            if (aiOverlay && aiOverlay.classList.contains('visible')) {
                aiOverlay.classList.remove('visible');
                return;
            }

            const root = document.getElementById('modal-root'); 
            const fsPlaylist = document.getElementById('fullscreen-playlist-overlay');
            if (root && root.style.display !== 'none' && !document.body.classList.contains('popup-mode')) closeModal();
            else if (fsPlaylist && fsPlaylist.classList.contains('show')) {
                fsPlaylist.classList.remove('show');
                currentItem = null;
                window.handlePlayerClose();
            }
        } 
    });
})();
</script>
<script>
/*************************************************************************
 * REWRITTEN: Personalized User Watch Counter
 *************************************************************************/
(function() {
    // A unique key to store the user's personal watch count in their browser's local storage.
    const USER_WATCH_COUNT_KEY = 'vidu_user_watch_count';

    // Safely retrieves the current watch count from localStorage.
    // It returns a number, defaulting to 0 if the value isn't found or is invalid.
    function getWatchCount() {
        try {
            const count = localStorage.getItem(USER_WATCH_COUNT_KEY);
            // We use parseInt to make sure we're working with a number, not a string.
            // The `|| 0` handles cases where the stored value is null or not a number.
            return parseInt(count, 10) || 0;
        } catch (e) {
            console.error("Failed to read user watch count from localStorage:", e);
            return 0; // Default to 0 if any error occurs.
        }
    }

    // Safely saves the new watch count to localStorage.
    function saveWatchCount(count) {
        try {
            localStorage.setItem(USER_WATCH_COUNT_KEY, count);
        } catch (e) {
            console.error("Failed to save user watch count to localStorage:", e);
        }
    }
    
    // This is the single function responsible for updating the number in the notification panel.
    // It will be called on page load and every time the count is incremented.
    function updateUserWatchCountUI() {
        const count = getWatchCount();
        const countElement = document.getElementById('user-watch-count');
        if (countElement) {
            countElement.textContent = count;
        }
    }

    // This global function is called by the video player script whenever a video starts playing.
    // It replaces the old, complex site-wide analytics function with this simple, personal one.
    window.incrementWatchCount = function() {
        let currentCount = getWatchCount();
        currentCount++; // Increment the count
        saveWatchCount(currentCount); // Save the new value
        updateUserWatchCountUI(); // Update the display immediately
    };

    // We make the UI update function globally available as 'updateStatsUI'.
    // This ensures the other scripts that open the notification panel can refresh the count.
    window.updateStatsUI = updateUserWatchCountUI;
    
    // When the web page's content is fully loaded, we immediately display the stored count.
    document.addEventListener('DOMContentLoaded', () => {
        updateUserWatchCountUI();
    });
})();
</script>

<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>

<script>
// **REWRITTEN & FIXED**: Panel UI logic
document.addEventListener('DOMContentLoaded', function() {
    
    // --- GROUND UP REWORK ---
    // REASONING: The original issue was that the function to render the downloads (`renderDownloads`)
    // was being passed as a callback to set up the button's click event, but it was `undefined` at the time
    // of setup. This is a classic JavaScript execution order problem.
    // SOLUTION: Define all data and functions FIRST, then get DOM elements, then wire up the event listeners.
    // This guarantees that when an event listener is created, the function it needs to call already exists.

    // 1. DEFINE DATA AND RENDERER
    // This data needs to be accessible to the rendering function.
    const downloadsData = [
        { title: "💻 VIDU For Windows ", link: "https://www.dropbox.com/scl/fi/ee6mud15hr2gxa310hn1q/VIDU-Installer.exe?rlkey=uvuap1tneo4rtdjihycsjlgzz&st=vwjz1yfp&dl=1" },
        { title: "📱 VIDU For Android ", link: "https://www.dropbox.com/scl/fi/arye1591eur13qhk0azwq/VIDU-6.0.apk?rlkey=jxgaz5g86xa5u11e4cuggmuvn&st=6y8tocm8&dl=1" },
        { title: "📱 VIDU YT For Android(For YT Packs) ", link: "https://www.dropbox.com/scl/fi/rfgqgxkxtb23tor0h7e71/VIDU-YT-3.0.apk?rlkey=b704gjqzbyrmkor452o8i2drm&st=7qnwrb1v&dl=1" },
        // You can easily add more items here in the future. For example:
        // { title: "Another File (e.g., PDF)", link: "https://example.com/file.pdf" },
    ];

    // This function builds the HTML for the download list. It's now defined before it's ever needed.
    window.renderDownloads = function() {
        const contentEl = document.getElementById('download-content');
        if (!contentEl) {
            console.error("Download content element not found!");
            return;
        }

        const downloadSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>`;
        
        const listHtml = downloadsData.map(item => `
            <li class="download-item">
                <span class="download-item-title">${escapeHtml(item.title)}</span>
                <a href="${escapeHtml(item.link)}" target="_blank" rel="noopener noreferrer" class="download-item-btn" aria-label="Download ${escapeHtml(item.title)}" title="Download">
                    ${downloadSVG}
                </a>
            </li>
        `).join('');
        
        contentEl.innerHTML = `<ul class="download-list">${listHtml}</ul>`;
    };

    // 2. GET DOM ELEMENTS
    const notificationBtn = document.getElementById('notification-btn');
    const notificationPanel = document.getElementById('notification-panel');
    const notificationCloseBtn = document.getElementById('notification-close-btn');

    const downloadBtn = document.getElementById('download-btn-header');
    const downloadPanel = document.getElementById('download-panel');
    const downloadCloseBtn = document.getElementById('download-close-btn');

    // 3. DEFINE PANEL CONTROL LOGIC
    function hideAllPanels() {
        if (notificationPanel) notificationPanel.classList.remove('show');
        if (downloadPanel) downloadPanel.classList.remove('show');
    }

    function setupPanel(btn, panel, closeBtn, renderCallback) {
        if (!btn || !panel || !closeBtn) return;

        btn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isAlreadyOpen = panel.classList.contains('show');
            hideAllPanels(); // Close all panels first to avoid overlap
            if (!isAlreadyOpen) {
                if (renderCallback) {
                    renderCallback(); // This will now correctly call the pre-defined function
                }
                panel.classList.add('show');
                panel.setAttribute('aria-hidden', 'false');
            } else {
                panel.setAttribute('aria-hidden', 'true');
            }
        });

        closeBtn.addEventListener('click', () => {
            panel.classList.remove('show');
            panel.setAttribute('aria-hidden', 'true');
        });
    }

    // 4. INITIALIZE PANELS
    // Now we call setupPanel, passing the functions that are guaranteed to exist.
    setupPanel(notificationBtn, notificationPanel, notificationCloseBtn, window.updateStatsUI);
    setupPanel(downloadBtn, downloadPanel, downloadCloseBtn, window.renderDownloads);

    // 5. INITIALIZE GLOBAL LISTENERS
    // These listeners handle closing the panels when clicking outside or pressing Escape.
    document.addEventListener('click', (event) => {
        if (notificationPanel && notificationPanel.classList.contains('show') && !notificationPanel.contains(event.target) && !notificationBtn.contains(event.target)) {
            hideAllPanels();
        }
        if (downloadPanel && downloadPanel.classList.contains('show') && !downloadPanel.contains(event.target) && !downloadBtn.contains(event.target)) {
            hideAllPanels();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && (notificationPanel.classList.contains('show') || downloadPanel.classList.contains('show'))) {
            hideAllPanels();
        }
    });
});
</script>

<script>
// This script rotates the background image on each page load.
document.addEventListener('DOMContentLoaded', function() {
    // --- CONFIGURATION ---
    // IMPORTANT: Set this to the total number of background images you have in the assets/images/ folder.
    // For example, if you have 1.png, 2.png, 3.png, 4.png, 5.png, set this value to 5.
    const totalBackgroundImages = 22; // <<-- CHANGE THIS NUMBER
    const imagePath = 'assets/images/';
    const imageExtension = '.png';
    const localStorageKey = 'vidu_background_index';

    try {
        // Get the last used index from localStorage.
        let lastIndex = localStorage.getItem(localStorageKey);

        // If it's the first visit, lastIndex will be null. Start with -1 so the first image is 0+1=1.png.
        // We parse it as an integer.
        lastIndex = (lastIndex === null) ? -1 : parseInt(lastIndex, 10);

        // Calculate the next index, cycling through the images.
        // The modulo operator (%) ensures the index wraps around to 0 when it reaches the total.
        let nextIndex = (lastIndex + 1) % totalBackgroundImages;

        // Save the new index back to localStorage for the next refresh.
        localStorage.setItem(localStorageKey, nextIndex);

        // Construct the full image URL. We add 1 because the files are 1-based (1.png, 2.png, etc.)
        const imageUrl = `${imagePath}${nextIndex + 1}${imageExtension}`;

        // Apply the new background image to the body element.
        document.body.style.backgroundImage = `url('${imageUrl}')`;

    } catch (error) {
        // If there's an error (e.g., localStorage is disabled), fall back to a default image.
        console.error("Could not set rotating background:", error);
        document.body.style.backgroundImage = `url('${imagePath}1${imageExtension}')`;
    }
});
</script>
<!-- CHANGE 2: New script to manage the "Play Last Video" button functionality -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const lastPlayedBtn = document.getElementById('play-last-video-btn');
    if (!lastPlayedBtn) return;

    try {
        const lastVideoJSON = localStorage.getItem('vidu_last_played_video');
        if (lastVideoJSON) {
            // If we found a last-played video in storage, show the button
            lastPlayedBtn.style.display = 'flex';
        }
    } catch(e) {
        console.error("Failed to read last played video info:", e);
    }

    lastPlayedBtn.addEventListener('click', () => {
        try {
            const lastVideoData = JSON.parse(localStorage.getItem('vidu_last_played_video') || '{}');
            if (lastVideoData.videoId && typeof window.playVideoWithLoading === 'function') {
                // The `playVideoWithLoading` function already handles finding the saved timecode
                window.playVideoWithLoading({
                    videoId: lastVideoData.videoId,
                    title: lastVideoData.title
                });
            }
        } catch(e) {
            console.error("Failed to play last video:", e);
        }
    });
});
</script>


<!-- ============================================================= -->
<!-- == NEW SELF-HOSTED AI ASSISTANT SCRIPT == -->
<!-- ============================================================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. STATE & CONFIGURATION ---
    let state = {
        isAssistantVisible: false,
        isRecognizing: false,
        isLoading: false,
        promptHistory: [],
        promptHistoryIndex: -1,
    };

    // --- 2. DOM ELEMENT REFERENCES ---
    const DOMElements = {
        toggleBtn: document.getElementById('ai-toggle-btn'),
        overlay: document.getElementById('ai-assistant-overlay'),
        container: document.getElementById('ai-assistant-container'),
        closeBtn: document.getElementById('ai-close-btn'),
        historyContainer: document.getElementById('ai-history'),
        input: document.getElementById('ai-input'),
        micBtn: document.getElementById('ai-mic-btn'),
    };

    // --- 3. SPEECH RECOGNITION SETUP ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = handleSpeechResult;
        recognition.onend = () => {
            state.isRecognizing = false;
            DOMElements.micBtn.classList.remove('recording');
        };
    }

    // --- 4. THE AI's "BRAIN" - KNOWLEDGE BASE ---
    const knowledgeBase = {
        // Keywords are lowercase for case-insensitive matching
        keywords: {
            // Identity
            'my name': "My name is VIDU AI 2.0 Pro. It's a pleasure to assist you.",
            'your name': "My name is VIDU AI 2.0 Pro. It's a pleasure to assist you.",
            'who are you': "I am VIDU AI 2.0 Pro, a self-hosted assistant integrated into this website.",
            'creator': "I was created by the talented developer VIDU. He's the architect of this entire website!",
            'who made you': "I was created by the talented developer VIDU. He's the architect of this entire website!",
            'vidu': "VIDU is the creator of this website and me, VIDU AI 2.0 Pro. He's a skilled developer who built everything you see here from the ground up.",

            // Website Features
            'how does this site work': "This website is a personal hub for watching private and public video playlists. It features a custom-built video player with advanced controls, playlist management tools, and some handy utilities for YouTube links. Everything is designed for a smooth and premium user experience.",
            'features': `This website has a ton of custom features built by VIDU! Here are the highlights:
* **The VIDU Player™️:** A completely custom-built player interface with advanced keyboard shortcuts, playback speed controls, and a "Never Lose Your Spot" feature that saves your progress.
* **Secure Playlists:** It includes password-protection for exclusive content and a system to manage access to different playlists.
* **YT Playlist Importer:** You can paste a YouTube playlist link into the Tools section to fetch all its videos and watch them in a sleek, fullscreen interface.
* **VIDU Tool Shed:** A collection of handy utilities like a YouTube video downloader (the "Video Yoinker") and a link shortener.
* **Premium UI/UX:** The whole site uses modern design principles like the "glassy" blur effect and buttery smooth animations.`,
            'player': `The video player is a core feature and was custom-coded by VIDU. It's not the standard YouTube player! It has:
* **Custom Controls:** A slick, modern interface built with HTML, CSS, and JavaScript.
* **Keyboard Shortcuts:** Full control without a mouse.
* **Playback Speed Settings:** To watch content at your own pace.
* **Progress Saving:** It automatically saves your position in a video so you can pick up where you left off.`,
            'shortcuts': `You can control the video player like a pro with these keyboard shortcuts:
* **Spacebar:** Play or Pause the video.
* **Right Arrow:** Skip forward 10 seconds.
* **Left Arrow:** Skip backward 10 seconds.
* **Up Arrow:** Increase volume.
* **Down Arrow:** Decrease volume.
* **'F' Key:** Toggle fullscreen mode.
* **'M' Key:** Mute or unmute the audio.`,
            'security': "Security is handled cleverly on this site. For exclusive content, there's a password protection system. VIDU also built a client-side login system for the private page, which uses a JavaScript object as a simple user database to control who can see which playlists.",
            'password': "For exclusive content, the site uses a password check. It's a simple but effective system that verifies your password before granting access to protected videos or playlists.",
            'tools': `The "Tools" page has some powerful utilities built by VIDU:
* **YT Playlist Importer:** Lets you fetch and view any public YouTube playlist.
* **The Video Yoinker:** A YouTube downloader. Just paste one or more video links to get download options.
* **Link Glo-Up:** A YouTube link converter that shortens long, messy youtube.com links into clean youtu.be links for easy sharing.`,
            'downloader': 'The YouTube downloader, nicknamed "The Video Yoinker", is on the Tools page. You can paste one or multiple YouTube video links there to generate download links for offline viewing.',
        },
        // General knowledge for non-website questions
        general: {
            'hello': 'Hello! How can I help you today?',
            'how are you': "I'm just a set of code, but I'm operating perfectly! Thanks for asking. How can I assist you?",
            'what is the time': `I don't have a direct connection to a live clock, but your device's time is currently: ${new Date().toLocaleTimeString()}`,
            'what is your purpose': 'My purpose is to assist you by providing information about this website and answering your general questions.',
            'thank you': "You're welcome! Let me know if you need anything else.",
            'thanks': "You're welcome! Let me know if you need anything else.",
            'capital of france': 'The capital of France is Paris.',
            'who is the president of the united states': 'As of my last update, the President of the United States is Joe Biden.',
            'what is html': 'HTML stands for HyperText Markup Language. It is the standard markup language for documents designed to be displayed in a web browser.'
        }
    };

    function getAIResponse(prompt) {
        const lowerCasePrompt = prompt.toLowerCase();

        // 1. Check for exact matches in the general knowledge base
        if (knowledgeBase.general[lowerCasePrompt]) {
            return knowledgeBase.general[lowerCasePrompt];
        }

        // 2. Search for keywords related to the website
        for (const keyword in knowledgeBase.keywords) {
            if (lowerCasePrompt.includes(keyword)) {
                return knowledgeBase.keywords[keyword];
            }
        }
        
        // 3. Fallback for general questions not in the knowledge base
        // This simulates a web search by providing a generic but helpful response.
        return "That's an interesting question! While I'm an expert on this website, my general knowledge is pre-loaded. For the most up-to-date and detailed information on that topic, I'd recommend a quick search on Google or your favorite search engine.";
    }


    // --- 5. INITIALIZATION & EVENT LISTENERS ---
    function init() {
        setupEventListeners();
        addMessage('model', "Hi there! I'm VIDU AI 2.0 Pro. Ask me anything about this website's features, or any other general questions you might have.");
    }

    function setupEventListeners() {
        DOMElements.toggleBtn.addEventListener('click', toggleAssistant);
        DOMElements.closeBtn.addEventListener('click', toggleAssistant);
        DOMElements.overlay.addEventListener('click', (e) => {
            if (e.target === DOMElements.overlay) toggleAssistant();
        });
        DOMElements.input.addEventListener('keydown', handleInputKeydown);
        if (recognition) {
            DOMElements.micBtn.addEventListener('click', toggleSpeechRecognition);
        }
    }

    // --- 6. CORE FUNCTIONS ---
    function toggleAssistant() {
        state.isAssistantVisible = !state.isAssistantVisible;
        DOMElements.overlay.classList.toggle('visible', state.isAssistantVisible);
        if (state.isAssistantVisible) {
            DOMElements.input.focus();
        }
    }

    function handleSendMessage() {
        const promptText = DOMElements.input.value.trim();
        if (!promptText || state.isLoading) return;

        DOMElements.input.value = '';
        if (promptText !== state.promptHistory[state.promptHistory.length - 1]) {
           state.promptHistory.push(promptText);
        }
        state.promptHistoryIndex = state.promptHistory.length;

        addMessage('user', promptText);
        
        // --- The New AI Logic ---
        state.isLoading = true;
        const thinkingMessage = addMessage('model', '<div class="typing-indicator"><span></span><span></span><span></span></div>');
        
        // Simulate thinking time for a more natural feel
        setTimeout(() => {
            const responseText = getAIResponse(promptText);
            const contentDiv = thinkingMessage.querySelector('.content');
            if (contentDiv) {
                contentDiv.innerHTML = marked.parse(responseText);
            }
            state.isLoading = false;
            hljs.highlightAll(); // Apply syntax highlighting if any code is in the response
            DOMElements.historyContainer.scrollTop = DOMElements.historyContainer.scrollHeight;
        }, 700 + Math.random() * 500); // Respond in 0.7-1.2 seconds
    }

    // --- 7. UI & HELPER FUNCTIONS ---
    function addMessage(role, text) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `ai-message ${role === 'user' ? 'user-message' : 'model-message'}`;

        const iconHtml = role === 'user' 
            ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.1.6 3 2.9-.8 4.1 3.8-2 3.8 2-.8-4.1 3-2.9-4.1-.6Z"/></svg>`;

        messageWrapper.innerHTML = `
            <div class="icon text-white">${iconHtml}</div>
            <div class="content">${marked.parse(text)}</div>
        `;
        
        DOMElements.historyContainer.appendChild(messageWrapper);
        DOMElements.historyContainer.scrollTop = DOMElements.historyContainer.scrollHeight;

        return messageWrapper;
    }

    function handleInputKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
        if (e.key === 'ArrowUp') {
            if (state.promptHistoryIndex > 0) {
                state.promptHistoryIndex--;
                DOMElements.input.value = state.promptHistory[state.promptHistoryIndex];
                e.preventDefault();
            }
        }
        if (e.key === 'ArrowDown') {
             if (state.promptHistoryIndex < state.promptHistory.length - 1) {
                state.promptHistoryIndex++;
                DOMElements.input.value = state.promptHistory[state.promptHistoryIndex];
             } else {
                state.promptHistoryIndex = state.promptHistory.length;
                DOMElements.input.value = "";
             }
        }
    }
    
    // --- 8. SPEECH RECOGNITION FUNCTIONS ---
    function toggleSpeechRecognition() {
        if (!recognition) return;
        if (state.isRecognizing) {
            recognition.stop();
        } else {
            state.isRecognizing = true;
            DOMElements.micBtn.classList.add('recording');
            recognition.start();
        }
    }
    
    function handleSpeechResult(event) {
        let interim_transcript = '';
        let final_transcript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                final_transcript += event.results[i][0].transcript;
            } else {
                interim_transcript += event.results[i][0].transcript;
            }
        }

        DOMElements.input.value = final_transcript + interim_transcript;
        if (final_transcript) {
            handleSendMessage();
        }
    }

    // --- Let's go! ---
    init();
});
</script>

<script>
(function() {
    'use strict';

    // This function is the core of the detection logic.
    const detectDevTools = () => {
        // We set a threshold for how much the window dimensions can differ.
        // If the developer tools are docked to the side or bottom, the inner dimensions
        // of the window will be smaller than the outer dimensions.
        const threshold = 160;

        const widthDifference = window.outerWidth - window.innerWidth > threshold;
        const heightDifference = window.outerHeight - window.innerHeight > threshold;

        // If either dimension has a significant difference, it's a strong sign.
        if (widthDifference || heightDifference) {
            return true;
        }
        
        // This is a more advanced trick. When developer tools are open, the browser
        // will pause execution on the `debugger` line. We can measure the time it
        // takes to execute the code immediately before and after this line.
        // A long delay indicates that the tools are open and paused execution.
        const startTime = new Date().getTime();
        // The 'debugger' keyword is a command that pauses code execution if dev tools are open.
        // If they are not open, this line is ignored by the browser.
        debugger; 
        const endTime = new Date().getTime();

        // If the time elapsed is more than 100 milliseconds, it's very likely
        // that the developer tools paused the script.
        if (endTime - startTime > 100) {
            return true;
        }

        // If none of the checks above were triggered, we assume the tools are closed.
        return false;
    };

    // This function is what we'll run repeatedly to check for the dev tools.
    const checkAndReload = () => {
        if (detectDevTools()) {
            // If the dev tools are detected, we force the page to reload.
            // This prevents the user from inspecting the page content or network requests.
            window.location.reload();
        }
    };

    // We use `setInterval` to run our check function repeatedly.
    // Here, it runs every 1000 milliseconds (1 second). This ensures that even if
    // a user opens the tools after the page loads, they will be detected quickly.
    setInterval(checkAndReload, 1000);

    // Additionally, we can add an event listener for the 'resize' event on the window.
    // Docking or undocking the developer tools often triggers a resize event,
    // which allows for an even faster detection in some cases.
    window.addEventListener('resize', checkAndReload);

})();
</script>
</body>
</html>
