<!DOCTYPE HTML>
<html>
<head>
  <title>VIDU</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-overlay: rgba(4,6,12,0.46);
      --glass: rgba(255,255,255,0.04);
      --glass-strong: rgba(255,255,255,0.06);
      --accent-1: #7b61ff;
      --accent-2: #39ff14; /* green for seek/volume fill / thumb */
      --accent-3: #ff6b6b;
      --muted: #bfc8dd;
      --text: #f2f6ff;
      --card-radius: 10px;
      --ease: cubic-bezier(.16,.84,.24,1);
    }

    body{
      background:url('assets/images/background.gif') no-repeat center center fixed;
      background-size:cover;
      font-family:"Inter","Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      margin:0;
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    body::before{
      content:'';
      position:fixed;
      inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.38));
      pointer-events:none;
      z-index:0;
      mix-blend-mode:multiply;
    }

    #wrapper{position:relative;z-index:3;padding-bottom:48px;}

    header#header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 22px;
      backdrop-filter: blur(8px) saturate(130%);
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom: none;
      border-radius:0 0 10px 10px;
      z-index:4;
      position:relative;
      box-shadow:0 8px 40px rgba(2,4,12,0.6);
    }

    .header-right-controls {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);user-select:none;position:relative;}
    .logo-circle{width: clamp(72px, 9vw, 120px);aspect-ratio:1/1;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border: 10px solid rgba(255,255,255,0.06);box-shadow: 0 10px 28px rgba(0,0,0,0.55);backdrop-filter: blur(6px) saturate(120%);transform: translateZ(0);flex-shrink:0;}
    .logo-circle img{width:100%;height:100%;object-fit:cover;object-position:center center;display:block;transform: translateZ(0);}

    nav ul{list-style:none;margin:0;padding:0;display:flex;gap:10px;align-items:center;}
    nav ul li a{font-weight:700;font-size:14px;position:relative;padding:8px 12px;color:var(--muted);text-decoration:none;border-radius:8px;transition:all .18s var(--ease);display:inline-block;border: none;box-shadow: none;outline: none;background: transparent;}
    nav ul li a:hover{color:var(--text);transform: translateY(-3px) scale(1.02);box-shadow:0 10px 30px rgba(66,44,145,0.12);}

    /* Neon green effect for header nav items & logo */
    header nav ul li a::before,
    .logo::before{
      content: "";
      position: absolute;
      inset: -10px;
      border-radius: 14px;
      background: linear-gradient(90deg,
        rgba(57,190,60,0.06) 0%,
        rgba(57,190,60,0.20) 25%,
        rgba(57,190,60,0.45) 50%,
        rgba(57,190,60,0.20) 75%,
        rgba(57,190,60,0.06) 100%);
      background-size: 300% 100%;
      filter: blur(8px) saturate(120%);
      opacity: 0.88;
      z-index: -1;
      transition: opacity .22s ease, transform .22s ease;
      pointer-events: none;
      background-position: var(--neon-x, 0%) 50%;
    }
    header nav ul li a::after,
    .logo::after{
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 12px;
      border: 1px solid rgba(57,190,60,0.22);
      opacity: 0.75;
      z-index: -1;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      backdrop-filter: blur(2px);
    }
    header nav ul li a:hover::before,
    .logo:hover::before{
      filter: blur(12px) saturate(180%);
      transform: scale(1.03);
      opacity: 1;
    }
    header nav ul li a:hover::after,
    .logo:hover::after{
      border-color: rgba(57,190,60,0.38);
      opacity: 1;
      transform: translateY(-2px);
    }

    .wrapper.style1{padding-top:24px;}
    .inner{max-width:1100px;margin:0 auto;padding:20px;position:relative;z-index:3;}

    .list-container{list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;align-items:flex-start;margin-top:6px;}
    .list-item{width:150px;cursor:pointer;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:10px;transition:transform .28s var(--ease),box-shadow .28s var(--ease),filter .28s var(--ease); border:1px solid rgba(255,255,255,0.04); box-shadow:0 8px 30px rgba(6,8,16,0.6);position:relative;overflow:visible;transform-style:preserve-3d;will-change:transform;backdrop-filter:blur(6px) saturate(120%);}

    .list-item::after{content:'';position:absolute;left:8px;right:8px;bottom:8px;height:4px;border-radius:4px;background:linear-gradient(90deg, rgba(123,97,255,0.25), rgba(57,255,20,0.18), rgba(255,107,107,0.12));opacity:0;transform:translateY(6px);transition:opacity .25s var(--ease),transform .25s var(--ease);pointer-events:none;}
    .list-item:hover::after{opacity:1;transform:translateY(0);}
    .list-item:hover{transform: translateY(-10px) rotateX(6deg) scale(1.03); box-shadow:0 28px 60px rgba(6,8,16,0.75); filter:saturate(1.08);}
    .list-item img{width:100%;border-radius:6px;display:block;transition:transform .6s var(--ease),box-shadow .4s var(--ease);transform-origin:center;box-shadow:0 8px 24px rgba(0,0,0,0.45), inset 0 -6px 16px rgba(0,0,0,0.08);will-change:transform;background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02));}
    .list-item:hover img{transform:scale(1.06) translateZ(18px);}

    .list-item .title{display:block;margin-top:0.45rem;color:var(--text);font-weight:700;font-size:14px;text-shadow:0 1px 0 rgba(0,0,0,0.45);}

    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,3,8,0.6), rgba(0,0,0,0.75));display:flex;align-items:center;justify-content:center;z-index:9999;}
    .modal{width:min(960px,95%);background:linear-gradient(180deg, rgba(12,12,12,0.96), rgba(6,6,8,0.98));border-radius:14px;padding:18px;color:#fff;border:1px solid rgba(255,255,255,0.035);box-shadow:0 40px 100px rgba(2,6,18,0.9);}

    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;}
    .btn{background:linear-gradient(90deg, var(--accent-1), var(--accent-3));color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none;}

    .password-row{display:flex;gap:8px;margin-top:8px;}
    .password-row input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);outline:none;transition:box-shadow .15s;}
    .password-row input:focus{box-shadow:0 8px 30px rgba(123,97,255,0.12);}
    .muted{color:var(--muted);font-size:13px;}

    @media (max-width:720px){ .list-item{width:calc(50% - 12px);} .modal iframe{height:320px;} }

    .list-item{opacity:0;transform-origin:center;animation:floatIn .5s forwards;}
    @keyframes floatIn{from{opacity:0;transform:translateY(12px) scale(.995);}to{opacity:1;transform:translateY(0) scale(1);} }

    .ripple{position:relative;overflow:hidden;}
    .ripple .drop{position:absolute;border-radius:50%;transform:scale(0);background:rgba(255,255,255,0.10);animation:rip .6s ease-out;pointer-events:none;}
    @keyframes rip{to{transform:scale(6);opacity:0;}}

    header nav ul li a.touch-active, .logo.touch-active{transform:scale(0.985);transition:transform .08s linear;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
    header nav ul li a.pulse, .logo.pulse{animation:btnPulse .5s ease-out;}
    @keyframes btnPulse{0%{box-shadow:0 0 0 rgba(57,255,20,0.28);}50%{box-shadow:0 0 30px rgba(57,255,20,0.22);}100%{box-shadow:0 0 0 rgba(57,255,20,0);} }

    .playlist-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;max-height:320px;overflow:auto;padding-top:6px;}
    .playlist-list .list-item{width:100%;display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;}
    .playlist-list .list-item img{width:140px;height:78px;object-fit:cover;border-radius:6px;}

    /* Player CSS */
    .vidu-player-host { position: relative; width:100%; overflow:hidden; border-radius:8px; background:#000; }
    .vidu-mount { width:100%; height:520px; background:#000; display:block; }
    .vidu-mount iframe{ width:100%; height:100%; display:block; border:0; pointer-events:none; }

    /* Loading overlay (shows header.png until the video actually starts playing) */
    .vidu-loading {
      position:absolute;
      inset:0;
      z-index:9995;
      display:flex;
      align-items:center;
      justify-content:center;
      background-image: url('assets/images/header.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: cover;
      transition: opacity .28s ease, transform .28s ease;
      pointer-events:none;
    }
    .vidu-loading.hidden {
      opacity:0;
      transform: scale(1.02);
      pointer-events:none;
    }

    .vidu-controls-bg {
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:64px;
      background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));
      pointer-events:none;
      z-index:9996;
      opacity:1;
      transition:opacity .22s ease, transform .22s ease;
      backdrop-filter: blur(4px);
      will-change:opacity;
    }
    .vidu-controls-bg.hidden { opacity:0; transform: translateY(6px); }

    /* IMPORTANT: allow wrap so controls don't overflow on narrow devices */
    .vidu-overlay { position:absolute; left:12px; right:12px; bottom:12px; z-index:9999; display:flex; gap:12px; align-items:center;
                    padding:8px 12px; border-radius:10px; box-sizing:border-box; transition:opacity .18s ease,transform .18s ease;
                    /* make controls wrap when there's not enough horizontal space */
                    flex-wrap:wrap; justify-content:flex-start; }
    .vidu-overlay.hidden { opacity:0; transform: translateY(6px); pointer-events:none; }

    .vidu-overlay .inner-bg{ position:absolute; inset:0; border-radius:10px; pointer-events:none; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); z-index:-1; }

    /* More rounded control buttons */
    .vidu-btn { background: rgba(255,255,255,0.06); color:#fff; padding:8px; border-radius:22px; cursor:pointer; font-weight:700;
               user-select:none; border:1px solid rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center;
               width:46px; height:46px; transition:transform .12s ease; }
    .vidu-btn:active{ transform: scale(.96); }

    /* Seek slider styles (green fill via inline background updates) */
    .vidu-range { flex:1; -webkit-appearance:none; height:8px; border-radius:8px; background: rgba(255,255,255,0.06); min-width:120px; }
    .vidu-range::-webkit-slider-thumb{ -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent-2); box-shadow:0 2px 8px rgba(0,0,0,0.5); border:2px solid rgba(0,0,0,0.18); margin-top:-4px; }
    .vidu-range::-moz-range-thumb{ width:16px; height:16px; border-radius:50%; background:var(--accent-2); border:2px solid rgba(0,0,0,0.18); }

    .vidu-time { min-width:90px; font-size:14px; font-weight:800; color:#cbd5ff; text-align:center; letter-spacing:1px; }

    /* QUALITY menu (internal; hidden from visible UI) */
    .vidu-quality-menu {
      position:absolute;
      z-index:10004;
      min-width:140px;
      background:linear-gradient(180deg, rgba(10,10,10,0.98), rgba(8,8,8,0.95));
      border-radius:8px;
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.04);
      overflow:hidden;
      display:none;
      padding:6px;
      user-select:none;
    }
    .vidu-quality-menu.open { display:block; }
    .vidu-quality-menu button { display:block; width:100%; text-align:left; border:none; background:transparent; color:#ddd; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:700; }
    .vidu-quality-menu button:hover { background:rgba(255,255,255,0.02); color:#fff; }
    .vidu-quality-menu button.active { color: var(--accent-2); background: rgba(255,255,255,0.02); }

    /* close button inside player (top-right) */
    .vidu-close-btn {
      position:absolute;
      top:10px;
      right:10px;
      z-index:10002;
      width:36px;
      height:36px;
      padding:6px;
      border-radius:8px;
      background:rgba(0,0,0,0.46);
      border:1px solid rgba(255,255,255,0.06);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      transition: opacity .18s ease, transform .18s ease;
    }

    /* when hidden, fade out and disable pointer events */
    .vidu-close-btn.hidden { opacity:0; transform: translateY(-6px); pointer-events:none; }

    #close-player { display:none !important; }

    .vidu-player-host:-webkit-full-screen .vidu-mount,
    .vidu-player-host:-moz-full-screen .vidu-mount,
    .vidu-player-host:fullscreen .vidu-mount { height:100vh !important; width:100% !important; }

    .vidu-player-host:-webkit-full-screen .vidu-mount iframe,
    .vidu-player-host:-moz-full-screen .vidu-mount iframe,
    .vidu-player-host:fullscreen .vidu-mount iframe,
    :-webkit-full-screen .vidu-mount iframe,
    :-moz-full-screen .vidu-mount iframe,
    :fullscreen .vidu-mount iframe {
      height:100vh !important;
      width:100% !important;
      max-height:none !important;
    }

    .vidu-player-host:-webkit-full-screen .vidu-overlay,
    .vidu-player-host:-moz-full-screen .vidu-overlay,
    .vidu-player-host:fullscreen .vidu-overlay {
      left:0 !important; right:0 !important; bottom:18px !important; width:100% !important; justify-content:center !important; padding:18px !important;
    }

    /* mobile adjustments so controls never overflow */
    @media (max-width:720px){
      .vidu-mount{ height:320px; }
      .vidu-overlay{ left:8px; right:8px; bottom:8px; gap:8px; padding:8px; }
      .vidu-controls-bg { height:56px; }
      .vidu-time { min-width:76px; font-size:12px; }
      .vidu-range { min-width:100px; }
    }

    @media (max-width:540px){
      .vidu-overlay{ flex-wrap:wrap; justify-content:flex-start; }
      .vidu-time{ min-width:68px; font-size:12px; }
      .vidu-range{ min-width:86px; }
      .vidu-btn{ width:38px; height:38px; }
      .vidu-close-btn{ top:8px; right:8px; }
    }

    @media (max-width:420px){
      .vidu-time{ min-width:60px; font-size:12px; }
      .vidu-range{ min-width:72px; }
      .vidu-btn{ width:36px; height:36px; }
    }

    /* Playback menu styling (added for gear button) */
    .vidu-playback-menu {
      position:absolute;
      z-index:10005;
      background:linear-gradient(180deg,#111,#0b0b0b);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:8px;
      padding:6px;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      min-width:88px;
    }
    .vidu-playback-item {
      display:block;
      padding:8px 10px;
      color:#e6f7e6;
      text-align:center;
      font-weight:800;
      cursor:pointer;
      border-radius:6px;
      margin:4px 0;
      background:transparent;
      font-size:13px;
    }
    .vidu-playback-item:hover { background:rgba(255,255,255,0.03); }
    .vidu-playback-item.active { background:rgba(57,255,20,0.12); color:#dfffd6; }
    /* Volume feedback centered in player */
    .vidu-vol-feedback{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      z-index:10003;
      padding:12px 18px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(0,0,0,0.72), rgba(0,0,0,0.5));
      border:1px solid rgba(255,255,255,0.06);
      font-weight:800;
      font-size:18px;
      color:var(--text);
      backdrop-filter: blur(6px) saturate(120%);
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      pointer-events:none;
      opacity:0;
      transition:opacity .28s ease;
      display:none;
      min-width:72px;
      text-align:center;
    }
    
    /* Notification Button & Panel Styles */
    .notification-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .18s var(--ease);
      position: relative;
    }
    .notification-btn:hover {
      color: var(--text);
      background: var(--glass);
      transform: scale(1.1);
    }

    .notification-panel {
      position: fixed;
      top: 80px; /* Adjusted for header height */
      right: 22px;
      width: 340px;
      max-width: 90vw;
      background: linear-gradient(180deg, rgba(20, 20, 22, 0.97), rgba(12, 12, 14, 0.98));
      backdrop-filter: blur(12px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--card-radius);
      box-shadow: 0 16px 60px rgba(2, 4, 12, 0.75);
      z-index: 10000;
      color: var(--text);
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
      transition: opacity .25s var(--ease), transform .25s var(--ease);
      pointer-events: none; /* Hidden by default */
    }
    .notification-panel.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
    }
    .notification-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }
    .notification-close-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 26px;
      line-height: 1;
      cursor: pointer;
      padding: 0 4px;
      transition: color .18s ease, transform .18s ease;
    }
    .notification-close-btn:hover {
      color: var(--text);
      transform: scale(1.1);
    }
    .notification-content {
      padding: 18px;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .notification-content p {
      margin: 0;
      line-height: 1.6;
    }
  </style>
</head>
<body class="landing is-preload">

 <div id="wrapper">
  <header id="header">
    <a href="index.html" class="logo" aria-label="VIDU home" title="VIDU home">
      <div class="logo-circle" aria-hidden="true">
        <img src="https://i.pinimg.com/736x/4d/fa/7b/4dfa7b57656b556f257b4a2e4f8fc8fa.jpg" alt="VIDU Logo" />
      </div>
    </a>
    
    <div class="header-right-controls">
        <nav>
          <ul>
            <li><a href="videos.html">üîíPrivate</a></li>
            <li>
              <a href="Tools.html" id="nav-tools" title="Tools" aria-label="Tools" style="display:flex;align-items:center;gap:8px;">
                ü§ñTools
              </a>
            </li>
            <li><a href="about.html">‚ÑπÔ∏èAbout</a></li>
          </ul>
        </nav>

        <button id="notification-btn" class="notification-btn" aria-label="Notifications" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
        </button>
    </div>
  </header>

  <section id="home" class="wrapper style1 fade-up">
    <div class="inner">
      <h2></h2>
      <ul id="playlist-list" class="list-container"></ul>
      <div id="playlist-videos" style="margin-top:2rem; display:none;"></div>
    </div>
  </section>

  <footer id="footer">
    <p>&copy; VIDU. 2025 All rights reserved.</p>
  </footer>
 </div>

 <div id="modal-root" style="display:none;"></div>

 <div id="notification-panel" class="notification-panel" role="dialog" aria-labelledby="notification-title" aria-hidden="true">
    <div class="notification-header">
        <h3 id="notification-title">Notifications</h3>
        <button id="notification-close-btn" class="notification-close-btn" aria-label="Close notifications">&times;</button>
    </div>
    <div class="notification-content">
        <p>Welcome to <strong>VIDU</strong>! We're constantly working on new features. Stay tuned for exciting updates coming soon! üöÄ</p>
        <p style="margin-top:12px; font-size:12px; color: var(--muted);"><em>September 15, 2025</em></p>
    </div>
 </div>

 <script>
(function(){
  if(window.__viduPlayerLoaded) return;
  window.__viduPlayerLoaded = true;

  const state = {
    player: null,
    updateInterval: null,
    keyHandler: null,
    mo: null,
    host: null,
    mount: null,
    fsResizeHandler: null,
    fsListener: null,
    docClickHandler: null,
    inactivityTimer: null,
    lastActivity: Date.now(),
    desiredPlaying: null,
    lastVolume: 100,
    _menuOpenTs: 0
  };

  function loadYTApi(){
    if(window.YT && window.YT.Player) return Promise.resolve();
    if(window._vidu_loading_yt){
      return new Promise((res, rej)=>{
        const t = setInterval(()=>{ if(window.YT && window.YT.Player){ clearInterval(t); res(); } },80);
        setTimeout(()=>{ clearInterval(t); rej(new Error('YT load timeout')); },20000);
      });
    }
    window._vidu_loading_yt = true;
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://www.youtube.com/iframe_api';
      s.async=true;
      s.onerror = ()=> reject(new Error('YT API failed to load'));
      document.head.appendChild(s);
      window.onYouTubeIframeAPIReady = function(){ resolve(); };
      setTimeout(()=>{ if(window.YT && window.YT.Player) resolve(); },1200);
      setTimeout(()=>{ if(!(window.YT && window.YT.Player)) reject(new Error('YT API timed out')); },20000);
    });
  }
  try{ window.loadYTApi = loadYTApi; }catch(e){}

  function pad2(n){
    n = Math.max(0, Math.floor(n||0));
    return (n < 10 ? '0' + n : String(n));
  }
  function fmtHHMMSS(s){
    s = Math.max(0, Math.floor(s||0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    return pad2(h) + ' : ' + pad2(m) + ' : ' + pad2(sec);
  }

  function playSVG(){ return `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4.5v15l12-7.5L6 4.5z" fill="#fff"/></svg>`; }
  function pauseSVG(){ return `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="4" width="4" height="16" rx="1.2" fill="#fff"/><rect x="15" y="4" width="4" height="16" rx="1.2" fill="#fff"/></svg>`; }
  function gearSVG(){ return `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.4-3.5c0-.4-.03-.78-.09-1.15l1.86-1.44a.5.5 0 0 0 .12-.65l-1.76-3.05a.5.5 0 0 0-.6-.22l-2.2.88a7.72 7.72 0 0 0-1.9-1.1l-.33-2.33A.5.5 0 0 0 13.9 2h-3.8a.5.5 0 0 0-.5.42l-.33 2.33c-.69.25-1.35.6-1.95 1.02l-2.2-.88a.5.5 0 0 0-.6.22L2.7 6.96a.5.5 0 0 0 .12.65l1.86 1.44c-.06.37-.09.75-.09 1.15s.03.78.09 1.15L2.82 14.95a.5.5 0 0 0-.12.65l1.76 3.05c.14.24.4.34.64.28l2.2-.88c.6.42 1.26.77 1.95 1.02l.33 2.33c.03.25.25.42.5.42h3.8c.25 0 .47-.17.5-.42l.33-2.33c.69-.25 1.35-.6 1.95-1.02l2.2.88c.24.09.5-.04.64-.28l1.76-3.05a.5.5 0 0 0-.12-.65l-1.86-1.44c.06-.37.09-.75.09-1.15z" fill="#fff"/></svg>`; }

  function createHostElements(){
    // Small robustness fix: some page states can call player creation before the #player-wrap exists.
    // Instead of throwing, fall back to creating #player-wrap inside modal-root or document.body.
    let wrap = document.getElementById('player-wrap');
    if(!wrap){
      const root = document.getElementById('modal-root') || document.body;
      const modalEl = (root && root.querySelector && root.querySelector('.modal')) ? root.querySelector('.modal') : root;
      wrap = document.createElement('div');
      wrap.id = 'player-wrap';
      wrap.style.minWidth = '320px';
      try{
        if(modalEl) modalEl.appendChild(wrap);
        else document.body.appendChild(wrap);
      }catch(e){
        try{ document.body.appendChild(wrap); }catch(_){}
      }
    }

    const prev = wrap.querySelector('.vidu-player-host');
    if(prev) prev.remove();

    const host = document.createElement('div'); host.className = 'vidu-player-host';
    const mount = document.createElement('div'); mount.className = 'vidu-mount'; mount.id = 'vidu_mount_'+Math.floor(Math.random()*1e6);
    mount.style.height = '520px';
    mount.style.background = '#000';
    host.appendChild(mount);

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'vidu-loading';
    loadingDiv.id = 'vidu_loading';
    host.appendChild(loadingDiv);

    const ctrlBg = document.createElement('div'); ctrlBg.className = 'vidu-controls-bg';
    host.appendChild(ctrlBg);

    const overlay = document.createElement('div'); overlay.className = 'vidu-overlay';
    overlay.innerHTML = `
      <div class="inner-bg" aria-hidden="true"></div>
      <button class="vidu-btn" id="vidu_playbtn">${playSVG()}</button>
      <div class="vidu-time" id="vidu_cur">` + fmtHHMMSS(0) + `</div>
      <input id="vidu_seek" class="vidu-range" type="range" min="0" max="100" step="0.1" value="0" />
      <div class="vidu-time" id="vidu_dur">` + fmtHHMMSS(0) + `</div>

      <button class="vidu-btn" id="vidu_playbackbtn" title="Playback speed" aria-label="Playback speed">` + gearSVG() + `</button>
      <button class="vidu-btn" id="vidu_fullbtn">‚§¢</button>
    `;
    host.appendChild(overlay);

    const qmenu = document.createElement('div');
    qmenu.className = 'vidu-quality-menu';
    qmenu.id = 'vidu_quality_menu';
    host.appendChild(qmenu);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'vidu-close-btn';
    closeBtn.id = 'vidu_closebtn';
    closeBtn.title = 'Close';
    closeBtn.type = 'button';
    closeBtn.innerHTML = '‚úï';
    closeBtn.addEventListener('click', ()=> {
      try{
        if(typeof window.closeModal === 'function') window.closeModal();
        else {
          const root = document.getElementById('modal-root'); if(root) root.style.display='none';
          if(window.destroyViduPlayer) window.destroyViduPlayer();
        }
      }catch(e){ console.warn('closeBtn error', e); }
    });
    host.appendChild(closeBtn);

    

    // volume feedback element (shown briefly when volume changes)
    const volFeedback = document.createElement('div');
    volFeedback.id = 'vidu_vol_feedback';
    volFeedback.className = 'vidu-vol-feedback';
    volFeedback.style.display = 'none';
    host.appendChild(volFeedback);

wrap.appendChild(host);
    return { host, mount, overlay, ctrlBg, closeBtn, qmenu, loadingDiv };
  }

  function disableIframeClicks(host){
    try{
      const ifr = host.querySelector('iframe');
      if(ifr){
        ifr.style.pointerEvents = 'none';
        ifr.setAttribute('allow','autoplay; encrypted-media; fullscreen');
        ifr.setAttribute('allowfullscreen','');
        ifr.setAttribute('tabindex','-1');
      }
    }catch(e){ console.warn('disableIframeClicks', e); }
  }

  function mapYTQualityToLabel(q){
    if(!q) return '';
    const map = { small:'144p', medium:'360p', large:'480p', hd720:'720p', hd1080:'1080p', highres:'Highres', default:'Auto' };
    return map[q] || q;
  }

  function populateQualityMenu(qmenu, availableLevels, currentQuality, player){
    if(!qmenu) return;
    qmenu.innerHTML = '';
    const addOption = (key, label, active)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.qualityKey = key;
      btn.textContent = label;
      if(active) btn.classList.add('active');
      btn.onclick = (ev)=>{
        ev.stopPropagation();
        try{
          if(player && typeof player.setPlaybackQuality === 'function'){
            player.setPlaybackQuality(key === 'default' ? 'default' : key);
          }
          qmenu.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          qmenu.classList.remove('open');
        }catch(e){ console.warn('failed to set quality',e); }
      };
      qmenu.appendChild(btn);
    };

    addOption('default','Auto', currentQuality === 'default');

    const avail = Array.isArray(availableLevels) ? availableLevels.slice() : [];
    const ordered = ['highres','hd1080','hd720','large','medium','small'];
    const uniq = ordered.filter(k => avail.indexOf(k) !== -1);
    uniq.forEach(k => addOption(k, mapYTQualityToLabel(k), currentQuality === k));

    if(uniq.length === 0){
      const fallbacks = ['small','medium','large','hd720','hd1080','highres'];
      fallbacks.forEach(k=>{ addOption(k, mapYTQualityToLabel(k), currentQuality === k); });
    }
  }

  function createPlayer(videoId){
    const { host, mount, overlay, ctrlBg, closeBtn, qmenu, loadingDiv } = createHostElements();
    state.host = host; state.mount = mount;

    const playBtn = overlay.querySelector('#vidu_playbtn');
    const curEl = overlay.querySelector('#vidu_cur');
    const durEl = overlay.querySelector('#vidu_dur');
    const seekEl = overlay.querySelector('#vidu_seek');
    const fullBtn = overlay.querySelector('#vidu_fullbtn');
    const playbackBtn = overlay.querySelector('#vidu_playbackbtn');

    // volume feedback helper (attached to host earlier as #vidu_vol_feedback)
    const volFeedbackEl = host.querySelector('#vidu_vol_feedback');
    function showVolumeFeedback(pct){
      try{
        if(!volFeedbackEl) return;
        const n = Math.max(0, Math.min(100, Math.round(pct||0)));
        volFeedbackEl.textContent = n + '%';
        volFeedbackEl.style.display = 'block';
        // force visible
        volFeedbackEl.style.opacity = '1';
        if(host._volFeedbackTimeout) clearTimeout(host._volFeedbackTimeout);
        host._volFeedbackTimeout = setTimeout(()=>{
          try{
            volFeedbackEl.style.opacity = '0';
            setTimeout(()=>{ try{ volFeedbackEl.style.display = 'none'; }catch(e){} }, 320);
          }catch(e){}
        }, 3000);
      }catch(e){ console.warn('showVolumeFeedback err', e); }
    }

    

    function getFullscreenElement(){
      return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
    }

    const saved = { stored:false, host:{}, mount:{}, iframe:{} };

    function toggleFullscreen(){
      const fs = getFullscreenElement();
      if(fs === host){
        const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
        if(exit) exit.call(document);
      } else {
        const req = host.requestFullscreen || host.webkitRequestFullscreen || host.mozRequestFullScreen || host.msRequestFullscreen;
        if(req) req.call(host);
      }
    }
    fullBtn.addEventListener('click', toggleFullscreen);

    function setOverlayHidden(hidden){
      if(hidden){
        overlay.classList.add('hidden');
        ctrlBg.classList.add('hidden');
        if(closeBtn) closeBtn.classList.add('hidden');
        if(qmenu) qmenu.classList.remove('open');
      } else {
        overlay.classList.remove('hidden');
        ctrlBg.classList.remove('hidden');
        if(closeBtn) closeBtn.classList.remove('hidden');
      }
    }

    function showLoading(){
      try{
        if(loadingDiv){
          loadingDiv.classList.remove('hidden');
          loadingDiv.style.display = 'flex';
        }
      }catch(e){}
    }
    function hideLoading(){
      try{
        if(loadingDiv){
          loadingDiv.classList.add('hidden');
          setTimeout(()=> { try{ loadingDiv.style.display = 'none'; }catch(e){} }, 320);
        }
      }catch(e){}
    }

    let qualityMenuOpen = false;

    document.addEventListener('click', function docClick(e){
      const now = Date.now();
      if(now - state._menuOpenTs < 250) return;
      if(qualityMenuOpen){
        if(!qmenu) return;
        if(qmenu.contains(e.target)) return;
        qmenu.classList.remove('open'); qualityMenuOpen = false;
      }
      if(playbackMenuOpen){
        if(playbackMenu && (playbackMenu.contains(e.target) || (playbackBtn && playbackBtn.contains(e.target)))) return;
        closePlaybackMenu();
      }
    }, {passive:true});

    // *** UPDATED keyHandler: ensure spacebar toggles update the same desiredPlaying state the play button uses
    state.keyHandler = function(e){
      const active = document.activeElement;
      // allow handling when focus is on seek slider (so space/arrow keys still control playback)
      const seekIsActive = (active && active.id === 'vidu_seek');
      if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable) && !seekIsActive) return;
      const root = document.getElementById('modal-root');
      if(!root || root.style.display === 'none') return;

      // SPACE: toggle play/pause
      if(e.code === 'Space' || e.key === ' '){
        e.preventDefault();
        if(state.player){
          let st = -1;
          try{ st = state.player.getPlayerState ? state.player.getPlayerState() : -1; }catch(e){}
          const wantPlay = !(st === 1);
          state.desiredPlaying = wantPlay;
          try{ playBtn.innerHTML = wantPlay ? pauseSVG() : playSVG(); }catch(e){}
          try{
            if(wantPlay){
              if(typeof state.player.playVideo === 'function') state.player.playVideo();
            } else {
              if(typeof state.player.pauseVideo === 'function') state.player.pauseVideo();
            }
          }catch(err){ console.warn('space toggle err', err); }
          resetInactivityTimer();
        }
        return;
      }

      // Fullscreen shortcut (F)
      if(e.code === 'KeyF' || e.key === 'f' || e.key === 'F'){
        e.preventDefault();
        toggleFullscreen();
        return;
      }

      // Seek forward/back with arrows (10s)
      if(e.key === 'ArrowRight' || e.code === 'ArrowRight' || e.key === 'Right'){
        e.preventDefault();
        try{
          if(state.player && typeof state.player.getCurrentTime === 'function'){
            const cur = Number(state.player.getCurrentTime() || 0);
            const dur = (typeof state.player.getDuration === 'function') ? Number(state.player.getDuration() || 0) : NaN;
            const target = Number.isFinite(dur) ? Math.min(dur, cur + 10) : cur + 10;
            if(typeof state.player.seekTo === 'function') state.player.seekTo(target, true);
            resetInactivityTimer();
          }
        }catch(err){ console.warn('seek forward err', err); }
        return;
      }
      if(e.key === 'ArrowLeft' || e.code === 'ArrowLeft' || e.key === 'Left'){
        e.preventDefault();
        try{
          if(state.player && typeof state.player.getCurrentTime === 'function'){
            const cur = Number(state.player.getCurrentTime() || 0);
            const target = Math.max(0, cur - 10);
            if(typeof state.player.seekTo === 'function') state.player.seekTo(target, true);
            resetInactivityTimer();
          }
        }catch(err){ console.warn('seek back err', err); }
        return;
      }

      // Volume up/down with arrows (5% steps) and show feedback
      if(e.key === 'ArrowUp' || e.code === 'ArrowUp' || e.key === 'Up'){
        e.preventDefault();
        try{
          if(state.player && typeof state.player.getVolume === 'function' && typeof state.player.setVolume === 'function'){
            let v = Number(state.player.getVolume() || 0);
            v = Math.min(100, Math.round(v + 5));
            state.player.setVolume(v);
            if(v > 0 && typeof state.player.unMute === 'function') state.player.unMute();
            showVolumeFeedback && showVolumeFeedback(v);
          }
        }catch(err){ console.warn('volume up err', err); }
        return;
      }
      if(e.key === 'ArrowDown' || e.code === 'ArrowDown' || e.key === 'Down'){
        e.preventDefault();
        try{
          if(state.player && typeof state.player.getVolume === 'function' && typeof state.player.setVolume === 'function'){
            let v = Number(state.player.getVolume() || 0);
            v = Math.max(0, Math.round(v - 5));
            state.player.setVolume(v);
            if(v === 0 && typeof state.player.mute === 'function') state.player.mute();
            showVolumeFeedback && showVolumeFeedback(v);
          }
        }catch(err){ console.warn('volume down err', err); }
        return;
      }
    };
    document.addEventListener('keydown', state.keyHandler);

    // seek handling
    seekEl.addEventListener('pointerdown', ()=> seekEl._drag=true, {passive:true});
    seekEl.addEventListener('pointerup', ()=>{ 
      seekEl._drag=false;
      if(!state.player) return;
      const dur = state.player.getDuration ? state.player.getDuration() : 0;
      if(dur) state.player.seekTo(dur * (parseFloat(seekEl.value)/100), true);
    }, {passive:true});
    seekEl.addEventListener('input', ()=>{ 
      if(seekEl._drag && state.player){
        const dur = state.player.getDuration ? state.player.getDuration() : 0;
        if(dur) curEl.textContent = fmtHHMMSS(Math.floor(dur * (parseFloat(seekEl.value)/100)));
        updateSeekBackground(seekEl);
      }
    }, {passive:true});

    function updateSeekBackground(el){
      try{
        const v = Math.max(0, Math.min(100, parseFloat(el.value) || 0));
        el.style.background = `linear-gradient(90deg, var(--accent-2) ${v}%, rgba(255,255,255,0.06) ${v}%)`;
      }catch(e){}
    }
    updateSeekBackground(seekEl);

    // play/pause with immediate UI response
    playBtn.addEventListener('click', ()=>{
      if(!state.player) return;
      let st = -1;
      try{ st = state.player.getPlayerState ? state.player.getPlayerState() : -1; }catch(e){}
      const wantPlay = !(st === 1);
      state.desiredPlaying = wantPlay;
      playBtn.innerHTML = wantPlay ? pauseSVG() : playSVG();
      try{
        if(wantPlay){
          if(typeof state.player.playVideo === 'function') state.player.playVideo();
        } else {
          if(typeof state.player.pauseVideo === 'function') state.player.pauseVideo();
        }
      }catch(e){ console.warn('play/pause toggle err', e); }
      resetInactivityTimer();
    });

    function onFSChange(){
      const fs = getFullscreenElement();
      const isOurFullscreen = !!(fs && (fs === host || host.contains(fs) || (fs.contains && fs.contains(host))));
      if(isOurFullscreen){
        if(!saved.stored){
          saved.host.position = host.style.position || '';
          saved.host.top = host.style.top || '';
          saved.host.left = host.style.left || '';
          saved.host.width = host.style.width || '';
          saved.host.height = host.style.height || '';
          saved.host.zIndex = host.style.zIndex || '';
          saved.host.borderRadius = host.style.borderRadius || '';

          saved.mount.height = mount.style.height || '';
          saved.mount.width = mount.style.width || '';
          saved.mount.maxHeight = mount.style.maxHeight || '';
          saved.mount.maxWidth = mount.style.maxWidth || '';

          const ifr = host.querySelector('iframe');
          if(ifr){
            saved.iframe.height = ifr.style.height || '';
            saved.iframe.width = ifr.style.width || '';
            saved.iframe.pointerEvents = ifr.style.pointerEvents || '';
            saved.iframe.maxHeight = ifr.style.maxHeight || '';
            saved.iframe.maxWidth = ifr.style.maxWidth || '';
          } else saved.iframe = {};

          saved.stored = true;
        }

        try{
          host.style.position = 'fixed';
          host.style.top = '0';
          host.style.left = '0';
          host.style.width = '100vw';
          host.style.height = '100vh';
          host.style.zIndex = '2147483647';
          host.style.borderRadius = '0';
        }catch(e){}

        try{
          mount.style.width = '100%';
          mount.style.height = '100%';
          mount.style.maxHeight = 'none';
          mount.style.maxWidth = 'none';
        }catch(e){}

        try{
          const ifr = host.querySelector('iframe');
          if(ifr){
            ifr.style.width = '100%';
            ifr.style.height = '100%';
            ifr.style.maxHeight = 'none';
            ifr.style.maxWidth = 'none';
            ifr.style.pointerEvents = 'auto';
          }
        }catch(e){}

        ctrlBg.classList.remove('hidden');
        overlay.classList.remove('hidden');
        if(closeBtn) closeBtn.classList.remove('hidden');

        if(!state.fsResizeHandler){
          state.fsResizeHandler = ()=> {
            const curFS = getFullscreenElement();
            const stillOurFS = !!(curFS && (curFS === host || host.contains(curFS) || (curFS.contains && curFS.contains(host))));
            if(stillOurFS){
              try{ host.style.width = window.innerWidth + 'px'; host.style.height = window.innerHeight + 'px'; }catch(e){}
              try{ mount.style.height = window.innerHeight + 'px'; }catch(e){}
              try{
                const ifr = host.querySelector('iframe');
                if(ifr) ifr.style.height = window.innerHeight + 'px';
              }catch(e){}
            }
          };
          window.addEventListener('resize', state.fsResizeHandler);
        }

      } else {
        if(saved.stored){
          try{
            host.style.position = saved.host.position;
            host.style.top = saved.host.top;
            host.style.left = saved.host.left;
            host.style.width = saved.host.width;
            host.style.height = saved.host.height;
            host.style.zIndex = saved.host.zIndex;
            host.style.borderRadius = saved.host.borderRadius;
          }catch(e){}

          try{
            mount.style.height = saved.mount.height;
            mount.style.width = saved.mount.width;
            mount.style.maxHeight = saved.mount.maxHeight;
            mount.style.maxWidth = saved.mount.maxWidth;
          }catch(e){}

          try{
            const ifr = host.querySelector('iframe');
            if(ifr){
              ifr.style.height = saved.iframe.height;
              ifr.style.width = saved.iframe.width;
              ifr.style.pointerEvents = saved.iframe.pointerEvents;
              ifr.style.maxHeight = saved.iframe.maxHeight;
              ifr.style.maxWidth = saved.iframe.maxWidth;
            }
          }catch(e){}

          saved.stored = false;
        } else {
          try{ mount.style.height = '520px'; mount.style.width = '100%'; }catch(e){}
          try{
            const ifr = host.querySelector('iframe');
            if(ifr) ifr.style.pointerEvents = 'none';
          }catch(e){}
        }

        if(state.fsResizeHandler){
          window.removeEventListener('resize', state.fsResizeHandler);
          state.fsResizeHandler = null;
        }

        if(overlay.classList.contains('hidden')){
          ctrlBg.classList.add('hidden');
          if(closeBtn) closeBtn.classList.add('hidden');
        } else {
          ctrlBg.classList.remove('hidden');
          if(closeBtn) closeBtn.classList.remove('hidden');
        }
      }
    }

    state.fsListener = onFSChange;
    document.addEventListener('fullscreenchange', state.fsListener);
    document.addEventListener('webkitfullscreenchange', state.fsListener);
    document.addEventListener('mozfullscreenchange', state.fsListener);
    document.addEventListener('MSFullscreenChange', state.fsListener);

    function resetInactivityTimer(){
      state.lastActivity = Date.now();
      setOverlayHidden(false);
      if(state.inactivityTimer) { clearTimeout(state.inactivityTimer); state.inactivityTimer = null; }
      state.inactivityTimer = setTimeout(()=>{
        try{
          const st = state.player && typeof state.player.getPlayerState === 'function' ? state.player.getPlayerState() : -1;
          if(st === 1 || st === 3 || st === -1 || st === 0 || st === 5){
            setOverlayHidden(true);
            if(qmenu) { qmenu.classList.remove('open'); }
          }
        }catch(e){}
      }, 5000);
    }

    function attachActivityListeners(){
      try{
        ['mousemove','pointermove','touchstart','touchmove','keydown','mousedown'].forEach(ev=>{
          host.addEventListener(ev, resetInactivityTimer, {passive:true});
          document.addEventListener(ev, resetInactivityTimer, {passive:true});
        });
      }catch(e){}
    }
    function detachActivityListeners(){
      try{
        ['mousemove','pointermove','touchstart','touchmove','keydown','mousedown'].forEach(ev=>{
          host.removeEventListener(ev, resetInactivityTimer);
          document.removeEventListener(ev, resetInactivityTimer);
        });
      }catch(e){}
    }
    attachActivityListeners();

    //
    // Playback menu implementation (robust & fixed)
    //
    let playbackMenu = null;
    let playbackMenuOpen = false;
    let docClickPlaybackCloseHandler = null;

    function closePlaybackMenu(){
      if(!playbackMenu) return;
      try{ playbackMenu.remove(); }catch(e){}
      playbackMenu = null;
      playbackMenuOpen = false;
      if(docClickPlaybackCloseHandler) { document.removeEventListener('click', docClickPlaybackCloseHandler); docClickPlaybackCloseHandler = null; }
    }
    function docClickPlaybackClose(e){
      if(!playbackMenu) return;
      if(playbackMenu.contains(e.target) || (playbackBtn && playbackBtn.contains(e.target))) return;
      closePlaybackMenu();
    }

    function formatRateLabel(r){ return (Math.round(r*100)/100) + '√ó'; }

    function openPlaybackMenu(){
      if(playbackMenuOpen){ closePlaybackMenu(); return; }

      playbackMenu = document.createElement('div');
      playbackMenu.className = 'vidu-playback-menu';
      playbackMenu.setAttribute('role','menu');
      playbackMenu.setAttribute('aria-label','Playback speed menu');

      let rates = [0.25,0.5,0.75,1,1.25,1.5,1.75,2];
      try{
        if(state.player && typeof state.player.getAvailablePlaybackRates === 'function'){
          const avail = state.player.getAvailablePlaybackRates() || [];
          if(Array.isArray(avail) && avail.length) rates = avail.slice();
        }
      }catch(e){}
      const set = {};
      rates.forEach(r=> set[Number(r)] = true);
      if(!set[1]) rates.push(1);
      rates = Object.keys(set).map(Number).sort((a,b)=>a-b);

      const curRate = (state.player && typeof state.player.getPlaybackRate === 'function') ? (state.player.getPlaybackRate()||1) : 1;

      rates.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'vidu-playback-item' + (Math.abs(r - curRate) < 0.0001 ? ' active' : '');
        btn.setAttribute('role','menuitem');
        btn.textContent = formatRateLabel(r);
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          try{
            if(state.player && typeof state.player.setPlaybackRate === 'function'){
              state.player.setPlaybackRate(Number(r));
            }
            try{ playbackBtn.title = 'Playback speed: ' + formatRateLabel(r); playbackBtn.setAttribute('aria-label','Playback speed ' + formatRateLabel(r)); }catch(e){}
            closePlaybackMenu();
          }catch(e){ console.warn('setPlaybackRate err', e); }
        });
        playbackMenu.appendChild(btn);
      });

      overlay.appendChild(playbackMenu);

      try{
        const overlayRect = overlay.getBoundingClientRect();
        const btnRect = playbackBtn.getBoundingClientRect();
        const left = Math.max(6, (btnRect.left - overlayRect.left) + (btnRect.width/2) - (playbackMenu.offsetWidth/2 || 44));
        playbackMenu.style.left = left + 'px';
        playbackMenu.style.bottom = (overlayRect.bottom - overlayRect.top + 8) + 'px';
      }catch(e){
        playbackMenu.style.right = '72px';
        playbackMenu.style.bottom = '72px';
        try{ host.appendChild(playbackMenu); }catch(e){}
      }

      playbackMenuOpen = true;
      state._menuOpenTs = Date.now();

      docClickPlaybackCloseHandler = function(e){ docClickPlaybackClose(e); };
      setTimeout(()=> document.addEventListener('click', docClickPlaybackCloseHandler));
    }

    if(playbackBtn){
      playbackBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openPlaybackMenu();
      });
    }

    const playbackMenuObserver = new MutationObserver(()=> {
      if(playbackMenuOpen && (!document.body.contains(playbackBtn) || !document.body.contains(host))) closePlaybackMenu();
    });
    playbackMenuObserver.observe(document.body, { childList: true, subtree: true });

    // load YT and mount player
    return loadYTApi().then(()=> new Promise((resolve,reject)=>{
      if(state.player && typeof state.player.destroy === 'function'){ try{ state.player.destroy(); }catch(e){} state.player = null; }

      try{
        state.player = new YT.Player(mount.id, {
          videoId: videoId,
          width: '100%',
          height: '100%',
          playerVars: {
            controls: 0,
            disablekb: 1,
            rel: 0,
            modestbranding: 1,
            playsinline: 1,
            iv_load_policy: 3,
            origin: location.origin
          },
          events: {
            onReady: function(evt){
              disableIframeClicks(host);

              showLoading();

              try{
                if(typeof evt.target.setVolume === 'function'){
                  const v = Math.max(0, Math.min(100, state.lastVolume || 100));
                  evt.target.setVolume(v);
                  if(v === 0 && typeof evt.target.mute === 'function') evt.target.mute();
                  else if(v > 0 && typeof evt.target.unMute === 'function') evt.target.unMute();
                }
              }catch(e){}

              try{
                let avail = [];
                if(typeof evt.target.getAvailableQualityLevels === 'function') avail = evt.target.getAvailableQualityLevels() || [];
                const curQ = (typeof evt.target.getPlaybackQuality === 'function') ? evt.target.getPlaybackQuality() : 'default';
                populateQualityMenu(qmenu, avail, curQ, evt.target);
                if(typeof evt.target.setPlaybackQuality === 'function'){ evt.target.setPlaybackQuality('default'); setTimeout(()=> { try{ evt.target.setPlaybackQuality('default'); }catch(e){} }, 800); }
              }catch(e){}

              try{ evt.target.playVideo(); }catch(e){}

              mount.style.height = mount.style.height || '520px';

              if(state.updateInterval) clearInterval(state.updateInterval);
              state.updateInterval = setInterval(()=>{
                try{
                  if(!state.player) return;
                  const dur = state.player.getDuration ? state.player.getDuration() : 0;
                  const cur = state.player.getCurrentTime ? state.player.getCurrentTime() : 0;
                  curEl.textContent = fmtHHMMSS(Math.floor(cur));
                  durEl.textContent = (dur && isFinite(dur)) ? fmtHHMMSS(Math.floor(dur)) : fmtHHMMSS(0);
                  if(!seekEl._drag && dur && isFinite(dur)) {
                    seekEl.value = (cur / Math.max(1,dur)) * 100;
                    updateSeekBackground(seekEl);
                  }
                  const st = state.player.getPlayerState ? state.player.getPlayerState() : -1;
                  if(state.desiredPlaying !== null){
                    if(state.desiredPlaying && st !== 1){
                      try{ state.player.playVideo(); }catch(e){}
                    } else if(!state.desiredPlaying && st === 1){
                      try{ state.player.pauseVideo(); }catch(e){}
                    }
                  }
                  const currentIcon = (st === 1) ? pauseSVG() : playSVG();
                  if(Date.now() - state.lastActivity > 300) {
                    playBtn.innerHTML = currentIcon;
                  } else {
                    setTimeout(()=> {
                      try{
                        const check = state.player.getPlayerState ? state.player.getPlayerState() : -1;
                        if(check === 1) playBtn.innerHTML = pauseSVG(); else playBtn.innerHTML = playSVG();
                      }catch(e){}
                    }, 600);
                  }

                  try{
                    if(typeof state.player.getAvailableQualityLevels === 'function'){
                      const levels = state.player.getAvailableQualityLevels() || [];
                      const curQ = typeof state.player.getPlaybackQuality === 'function' ? state.player.getPlaybackQuality() : 'default';
                      populateQualityMenu(qmenu, levels, curQ, state.player);
                    }
                  }catch(e){}

                  try{
                    if(playbackBtn && state.player && typeof state.player.getPlaybackRate === 'function'){
                      const curRate = state.player.getPlaybackRate ? state.player.getPlaybackRate() : 1;
                      playbackBtn.title = 'Playback speed: ' + (Math.round(curRate*100)/100) + '√ó';
                      playbackBtn.setAttribute('aria-label', 'Playback speed ' + (Math.round(curRate*100)/100) + '√ó');
                    }
                  }catch(e){}
                }catch(e){}
              }, 160);

              if(state.mo) state.mo.disconnect();
              state.mo = new MutationObserver(()=> disableIframeClicks(host));
              state.mo.observe(host, { childList:true, subtree:true });

              resetInactivityTimer();

              resolve(state.player);
            },
            onStateChange: function(e){
              try{
                if(e && e.data === 1){
                  try{ hideLoading(); }catch(e){/*ignore*/ }
                }
              }catch(err){}
            },
            onError: function(err){
              try{ const ld = document.getElementById('vidu_loading'); if(ld){ ld.classList.add('hidden'); ld.style.display='none'; } }catch(_){}
              console.error('YT player error', err);
            }
          }
        });
      }catch(err){
        reject(err || new Error('YT player creation failed'));
      }
    })).catch(err=>{ throw err; }).then(p=>{
      setTimeout(()=> resetInactivityTimer(), 40);
      return p;
    });
  }

  function destroyPlayer(){
    try{
      if(state.updateInterval){ clearInterval(state.updateInterval); state.updateInterval = null; }
      if(state.keyHandler){ document.removeEventListener('keydown', state.keyHandler); state.keyHandler = null; }
      if(state.docClickHandler){ document.removeEventListener('click', state.docClickHandler); state.docClickHandler = null; }
      if(state.player){ try{ state.player.destroy(); }catch(e){} state.player = null; }
      if(state.mo){ try{ state.mo.disconnect(); }catch(e){} state.mo = null; }
      if(state.fsResizeHandler){ window.removeEventListener('resize', state.fsResizeHandler); state.fsResizeHandler = null; }
      if(state.fsListener){
        document.removeEventListener('fullscreenchange', state.fsListener);
        document.removeEventListener('webkitfullscreenchange', state.fsListener);
        document.removeEventListener('mozfullscreenchange', state.fsListener);
        document.removeEventListener('MSFullscreenChange', state.fsListener);
        state.fsListener = null;
      }
      if(state.inactivityTimer){ clearTimeout(state.inactivityTimer); state.inactivityTimer = null; }
      if(state.host){
        try{
          ['mousemove','pointermove','touchstart','touchmove','keydown','mousedown'].forEach(ev=>{
            state.host.removeEventListener(ev, resetInactivityTimer);
            document.removeEventListener(ev, resetInactivityTimer);
          });
        }catch(e){}
      }
      if(state.host){ try{ state.host.remove(); }catch(e){} state.host = null; state.mount = null; }
    }catch(e){ console.warn('destroyPlayer err', e); }
  }

  window.showViduPlayer = function(videoId){
    if(typeof window.loadYTApi !== 'function') {
      window.loadYTApi = loadYTApi;
    }
    return createPlayer(videoId).catch(err => { console.error('createPlayer failed', err); throw err; });
  };
  window.destroyViduPlayer = function(){
    destroyPlayer();
    const w = document.getElementById('player-wrap'); if(w) w.innerHTML = '';
  };

  window.addEventListener('beforeunload', ()=> { try{ window.destroyViduPlayer(); }catch(e){} }, {passive:true});
})();

</script>

<script>
/*************************************************************************
 * Playlist data + UI + modal + YouTube playlist fetching
 *************************************************************************/
const playlists = [
  {
    id: 0,
    name: 'SUBJECTS',
    thumbnail: 'https://i.pinimg.com/736x/71/82/6e/71826ec9ece9f33d9034bb0acd3b8d1f.jpg',
    videos: [
      {
        id: 1,
        name: 'ET',
        thumbnail: 'https://i.pinimg.com/736x/19/b2/42/19b2424009813fc558e8a785c794cbdf.jpg',
        videos: [
          { name:'', thumbnail:'https://i.pinimg.com/736x/19/b2/42/19b2424009813fc558e8a785c794cbdf.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82enZEX0A4SQVvRzEEFj8eAEZGAlA/WkIGNk4VIgs9WWlhent5Pl81JjhB", passEnc: "" },
          { name:'', thumbnail:'https://i.pinimg.com/736x/ea/60/d8/ea60d83595332fe2a7d11f1844072251.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dFNrdjcTAhYmOlUACF0XEFRJZVkiCkIGNk4LOUBXQDRCQnRSMi4wMmYp", passEnc: "" }
        ]
      },
      {
        id: 2,
        name: 'SFT',
        thumbnail: 'https://i.pinimg.com/736x/b8/de/57/b8de57f639bb30fd9f48cda542dd96d2.jpg',
        videos: [
          { name:'', thumbnail:'https://i.pinimg.com/736x/2d/9d/1a/2d9d1a4affd566269879267ca70b74b8.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dQkGUzsDJUIpXlMNBVBBN0ZnWAM6IUIGNk41NioUP21FXHtcGDYQIAUe", passEnc: "" },
          { name:'', thumbnail:'https://i.pinimg.com/736x/42/9d/84/429d847241cfba744292224956707f45.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82d11cAxxZK01oQz06HiMmPkFpc3cyW0IGNk4TCT08RCt5AHdYQyU+AywV", passEnc: "" },
          { name:'', thumbnail:'https://i.pinimg.com/736x/1f/24/4e/1f244ec99cab31c5d72348a736d361df.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dUQDDD4zXQIlOhIgXzMlAHN+Ak9PIkIGNk5VCTgGQRdmUQQNIQwVTWpC", passEnc: "" } 
        ]
      },
      {
        id: 3,
        name: 'ICT',
        thumbnail: 'https://i.pinimg.com/736x/81/f4/0d/81f40de2906f0c61f2f17d6db61d7271.jpg',
        videos: [
          { name:'', thumbnail:'https://i.pinimg.com/736x/81/f4/0d/81f40de2906f0c61f2f17d6db61d7271.jpg', type:'playlist', idEnc: "JiVdDwdDMwE8CD82dGVabCUtAhwaJTMuBycWPABxW0IGKkIGNk5UBEpVGytfan1tEhlVHRos", passEnc: "" }
        ]
      }
    ]
  }
];

function b64decode(s){ try{ return atob(s); }catch(e){ return s; } }

// Decryption helper ‚Äî obfuscated IDs (keeps key inside closure)
const decodeEnc = (function(){
  const key = new TextEncoder().encode('vidu_secret_2025'); // small XOR key stored only inside this closure
  function xorDecode(bytes){
    const out = new Uint8Array(bytes.length);
    for(let i=0;i<bytes.length;i++) out[i] = bytes[i] ^ key[i % key.length];
    return out;
  }
  return function(encStr){
    try{
      if(!encStr) return '';
      const raw = atob(encStr);
      // convert raw string to bytes
      const bytes = new Uint8Array(raw.split('').map(c=>c.charCodeAt(0)));
      const dec = xorDecode(bytes);
      // convert bytes to string
      return new TextDecoder().decode(dec);
    }catch(e){
      return '';
    }
  };
})();

function escapeHtml(s){ return (s||'').replace(/[&<>"'`]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[ch])); }

function renderPlaylists(){
  const ul = document.getElementById('playlist-list');
  if(!ul) return;
  ul.innerHTML = '';
  if(!playlists || playlists.length === 0){ ul.innerHTML = '<li class="muted">No playlists available.</li>'; return; }
  playlists.forEach(pl=>{
    const li = document.createElement('li'); li.className='list-item ripple';
    li.innerHTML = `<img src="${escapeHtml(pl.thumbnail)}" alt="${escapeHtml(pl.name)}" /><span class="title">${escapeHtml(pl.name)}</span>`;
    li.addEventListener('click', (ev)=>{ spawnRipple(ev, li); showPlaylistVideos(pl); });
    attachTilt(li);
    ul.appendChild(li);
  });
  ul.style.display = 'flex';
}

function showPlaylistVideos(pl, skipPush){
  const ul = document.getElementById('playlist-list');
  const container = document.getElementById('playlist-videos');
  if(!container || !ul) return;
  if(!window.__viduGlobal) window.__viduGlobal = {};
  if(!window.__viduGlobal.playlistStack) window.__viduGlobal.playlistStack = [];
  if(!skipPush){ window.__viduGlobal.playlistStack.push(window.__viduGlobal.currentPl || null); }
  window.__viduGlobal.currentPl = pl;
  ul.style.display = 'none';
  container.style.display = 'block';
  container.innerHTML = `<h3 style="text-align:center;color:#fff;">${escapeHtml(pl.name)}</h3>`;
  const vids = document.createElement('ul'); vids.className='list-container';
  (pl.videos||[]).forEach(v=>{
    const vli = document.createElement('li'); vli.className='list-item ripple';
    const thumb = v.thumbnail || '';
    vli.innerHTML = `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(v.name)}" /><span class="title">${escapeHtml(v.name)}</span>`;
    if(v && Array.isArray(v.videos)){
      vli.addEventListener('click',(ev)=>{ spawnRipple(ev, vli); showPlaylistVideos(v); });
    } else {
      vli.addEventListener('click',(ev)=>{
        spawnRipple(ev, vli);
        const expectedPassword = b64decode(v.passEnc || '');
        if (expectedPassword === '') {
          // No password, open player directly
          currentItem = v;
          showUnlockedItem(v);
        } else {
          // Password required, show modal
          openPasswordModal(v);
        }
      });
    }
    attachTilt(vli); vids.appendChild(vli);
  });
  const back = document.createElement('div'); back.style.textAlign='center'; back.style.marginTop='16px';
  back.innerHTML = `<button id="back-to-playlists" class="btn secondary">Back</button>`;
  container.appendChild(vids); container.appendChild(back);
  document.getElementById('back-to-playlists').onclick = ()=>{
    const prev = (window.__viduGlobal.playlistStack && window.__viduGlobal.playlistStack.length) ? window.__viduGlobal.playlistStack.pop() : null;
    if(prev === null){ ul.style.display='flex'; container.style.display='none'; window.__viduGlobal.currentPl = null; }
    else { showPlaylistVideos(prev, true); }
  };
}

function spawnRipple(ev,target){ const rect = target.getBoundingClientRect(); const drop = document.createElement('div'); drop.className = 'drop'; drop.style.left = (ev.clientX - rect.left) + 'px'; drop.style.top = (ev.clientY - rect.top) + 'px'; target.appendChild(drop); setTimeout(()=> drop.remove(),700); }
function attachTilt(card){ if(!card) return; const img = card.querySelector('img'); function onMove(e){ if(window.__viduGlobal && window.__viduGlobal.visualsPaused) return; const r = card.getBoundingClientRect(); const px = (e.clientX - r.left) / r.width; const py = (e.clientY - r.top) / r.height; const rx = (py - 0.5) * 10; const ry = (px - 0.5) * -10; card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(6px)`; if(img) img.style.transform = `translateZ(26px) scale(1.06) translateY(${(0.5-py)*6}px)`; } function onLeave(){ card.style.transform = ''; if(img) img.style.transform = ''; } card.addEventListener('pointermove', onMove, {passive:true}); card.addEventListener('pointerleave', onLeave, {passive:true}); }

 // Modal + password + player mount logic
let currentItem = null;
function createModal(){
  const root = document.getElementById('modal-root');
  root.innerHTML = `
    <div class="modal-backdrop" id="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="controls">
          <div>
            <strong id="modal-title">Locked</strong>
            <div class="muted" id="modal-subtitle" style="color:#bbb;font-size:12px;"></div>
          </div>
          <div>
            <button id="modal-close" class="btn secondary">Close</button>
          </div>
        </div>

        <div id="modal-body">
          <div id="password-block">
            <div style="color:#bbb;margin-bottom:8px;">This item is password-protected. Enter password to unlock and play.</div>
            <div class="password-row">
              <input id="password-input" type="password" placeholder="Enter password" />
              <button id="password-submit" class="btn">Unlock</button>
            </div>
            <div id="password-error" style="margin-top:8px;color:#f66;display:none;"></div>
          </div>

          <div id="player-block" style="display:none;margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <div style="color:#bbb" id="now-playing-label">Now playing</div>
              <div>
                <button id="close-player" class="btn">Close</button>
              </div>
            </div>

            <div id="player-wrap"></div>

            <div id="playlist-list-wrap" style="display:none;margin-top:12px;">
              <div class="muted">Playlist contents</div>
              <div class="playlist-list" id="playlist-video-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modal-close').onclick = closeModal;
  document.getElementById('close-player').onclick = closeModal;
  document.getElementById('password-submit').onclick = onPasswordSubmit;
  document.getElementById('password-input').onkeydown = (e)=>{ if(e.key === 'Enter') onPasswordSubmit(); };
  document.getElementById('modal-backdrop').onclick = function(e){ if(e.target === this) closeModal(); };
}

function showUnlockedItem(item) {
  const root = document.getElementById('modal-root');
  root.style.display = 'block';
  document.getElementById('modal-title').textContent = item.name || 'Player';
  document.getElementById('modal-subtitle').textContent = (item.type || 'video');

  document.getElementById('password-block').style.display = 'none';
  document.getElementById('password-error').style.display = 'none';
  document.getElementById('player-block').style.display = 'block';
  const plwrap = document.getElementById('playlist-list-wrap');
  if(plwrap) plwrap.style.display = 'none';

  if(!window.__viduGlobal) window.__viduGlobal = {};
  window.__viduGlobal.visualsPaused = true;
  window.dispatchEvent(new CustomEvent('vidu:visuals:pause', { detail:{ reason:'modal-open' } }));

  if (item.type === 'playlist') {
    showPlaylistInsideModal(item);
  } else {
    const id = decodeEnc(item.idEnc || '');
    document.getElementById('now-playing-label').textContent = item.name || 'Now playing';
    if (window.showViduPlayer) {
      window.showViduPlayer(id).catch(err => {
        console.error('showViduPlayer failed', err);
        const wrap = document.getElementById('player-wrap');
        if (wrap) wrap.innerHTML = `<div class="muted">Failed to load player: ${escapeHtml(err.message || '')}</div>`;
      });
    }
  }
}

function openPasswordModal(item){
  currentItem = item;
  const root = document.getElementById('modal-root');
  root.style.display = 'block';
  document.getElementById('modal-title').textContent = item.name || 'Protected';
  document.getElementById('modal-subtitle').textContent = (item.type || 'video') + ' ‚Äî password required';
  document.getElementById('password-input').value = '';
  document.getElementById('password-error').style.display = 'none';
  document.getElementById('password-block').style.display = 'block';
  document.getElementById('player-block').style.display = 'none';
  const plwrap = document.getElementById('playlist-list-wrap'); if(plwrap) plwrap.style.display = 'none';
  setTimeout(()=>document.getElementById('password-input').focus(), 50);
  if(!window.__viduGlobal) window.__viduGlobal = {};
  window.__viduGlobal.visualsPaused = true;
  window.dispatchEvent(new CustomEvent('vidu:visuals:pause', { detail:{ reason:'modal-open' } }));
}

function closeModal(){
  const root = document.getElementById('modal-root'); if(root) root.style.display = 'none';
  const wrap = document.getElementById('player-wrap'); if(wrap) wrap.innerHTML = '';
  const plwrap = document.getElementById('playlist-video-list'); if(plwrap) plwrap.innerHTML = '';
  currentItem = null;
  if(window.destroyViduPlayer) try{ window.destroyViduPlayer(); }catch(e){}
  window.__viduGlobal.visualsPaused = false;
  window.dispatchEvent(new CustomEvent('vidu:visuals:resume', { detail:{ reason:'modal-closed' } }));
}

function onPasswordSubmit(){
  const val = (document.getElementById('password-input').value || '').trim();
  if(!currentItem) return;
  const expected = b64decode(currentItem.passEnc || '');
  if(val === expected){
    showUnlockedItem(currentItem);
  } else {
    const err = document.getElementById('password-error'); err.style.display = 'block'; err.textContent = 'Incorrect password ‚Äî try again.';
  }
}

// YouTube playlist fetching
// <<-- RESTORED: API key re-added from your original uploaded file -- this fixes playlist loading.
const YT_API_KEY = 'AIzaSyB8UVKOZOnUnYdqbFGOtlg6BPfR9HpD35c';
async function fetchPlaylistVideos(playlistId){
  if(!YT_API_KEY || YT_API_KEY === 'YOUR_API_KEY_HERE') throw new Error('No API key configured.');
  const items=[]; let pageToken='';
  do{
    const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${encodeURIComponent(playlistId)}&key=${encodeURIComponent(YT_API_KEY)}` + (pageToken?`&pageToken=${pageToken}`:'');
    const res = await fetch(url);
    if(!res.ok){ const txt = await res.text().catch(()=>null); throw new Error('YouTube API error: '+res.status+' '+res.statusText+' '+(txt||'')); }
    const data = await res.json();
    (data.items||[]).forEach(it=>{
      const sn = it.snippet || {};
      if(sn.resourceId && sn.resourceId.videoId){
        const thumb = (sn.thumbnails && (sn.thumbnails.high||sn.thumbnails.medium||sn.thumbnails.default))||{};
        items.push({ videoId: sn.resourceId.videoId, title: sn.title||'Untitled', thumb: thumb.url||`https://img.youtube.com/vi/${sn.resourceId.videoId}/hqdefault.jpg` });
      }
    });
    pageToken = data.nextPageToken || '';
  } while(pageToken);
  return items;
}

async function showPlaylistInsideModal(item){
  const rawId = decodeEnc(item.idEnc);
  const playlistId = rawId.split('&')[0];
  window.__viduGlobal.visualsPaused = true;
  window.dispatchEvent(new CustomEvent('vidu:visuals:pause', { detail:{ reason:'playlist-load' } }));

  try{
    const videos = await fetchPlaylistVideos(playlistId);
    if(!videos.length){
      const wrap = document.getElementById('player-wrap');
      if(wrap) wrap.innerHTML = `<div class="muted">No videos found or playlist is private.</div>`;
      document.getElementById('player-block').style.display='block';
      return;
    }

    let listWrap = document.getElementById('playlist-video-list');
    if(!listWrap){
      const wrapper = document.createElement('div');
      wrapper.id = 'playlist-list-wrap';
      wrapper.style.marginTop = '12px';
      wrapper.innerHTML = `<div class="muted">Playlist contents</div><div class="playlist-list" id="playlist-video-list"></div>`;
      const playerBlock = document.getElementById('player-block');
      if(playerBlock) playerBlock.appendChild(wrapper);
      listWrap = document.getElementById('playlist-video-list');
    }

    if(listWrap) listWrap.innerHTML = '';
    videos.forEach(v=>{
      const li = document.createElement('div'); li.className = 'list-item';
      
      li.style.display='flex'; li.style.alignItems='center'; li.style.gap='12px'; li.style.padding='8px';
      li.innerHTML = `<img src="${escapeHtml(v.thumb)}" alt="${escapeHtml(v.title)}" style="width:120px;height:68px;object-fit:cover;border-radius:6px;" /><div style="flex:1;"><div class="title" style="font-size:13px;">${escapeHtml(v.title)}</div></div>`;
      li.onclick = ()=> {
        document.getElementById('now-playing-label').textContent = v.title || 'Now playing';
        if(window.showViduPlayer) window.showViduPlayer(v.videoId).catch(err => {
          console.error('showViduPlayer failed', err);
          const wrap = document.getElementById('player-wrap'); if(wrap) wrap.innerHTML = `<div class="muted">Failed to load player: ${escapeHtml(err.message || '')}</div>`;
        });
      };
      listWrap.appendChild(li);
    });

    document.getElementById('player-block').style.display='block';
    const outer = document.getElementById('playlist-list-wrap'); if(outer) outer.style.display='block';
    document.getElementById('now-playing-label').textContent = videos[0].title || 'Now playing';
    if(window.showViduPlayer) window.showViduPlayer(videos[0].videoId).catch(err => {
      console.error('showViduPlayer failed', err);
      const wrap = document.getElementById('player-wrap'); if(wrap) wrap.innerHTML = `<div class="muted">Failed to load player: ${escapeHtml(err.message || '')}</div>`;
    });
  } catch(err){
    console.error('Playlist fetch error', err);
    const wrap = document.getElementById('player-wrap');
    if(wrap) wrap.innerHTML = `<div class="muted">Failed to load playlist: ${escapeHtml(err.message || '')}</div>`;
    document.getElementById('player-block').style.display='block';
  }
}

// Visual helpers & init
function pauseVisuals(reason){ if(!window.__viduGlobal) window.__viduGlobal = {}; window.__viduGlobal.visualsPaused = true; window.dispatchEvent(new CustomEvent('vidu:visuals:pause',{detail:{reason}})); }
function resumeVisuals(reason){ if(!window.__viduGlobal) window.__viduGlobal = {}; window.__viduGlobal.visualsPaused = false; window.dispatchEvent(new CustomEvent('vidu:visuals:resume',{detail:{reason}})); }

document.addEventListener('DOMContentLoaded', function(){
  createModal();
  renderPlaylists();
  const navHome = document.getElementById('nav-home');
  if(navHome) navHome.addEventListener('click', ()=>{ document.getElementById('playlist-list').style.display='flex'; document.getElementById('playlist-videos').style.display='none'; });
  document.querySelectorAll('.list-item').forEach(el=>attachTilt(el));
  (function stagger(){ const cards=document.querySelectorAll('.list-item'); cards.forEach((c,i)=> c.style.animationDelay=(i*60)+'ms'); })();
});


// deterrents
document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, false);
document.addEventListener('keydown', function(e){ if ((e.ctrlKey && e.shiftKey && (e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j')) || (e.ctrlKey && (e.key==='U'||e.key==='u')) || (e.key==='F12')) { e.preventDefault(); return false; } });
document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { const root=document.getElementById('modal-root'); if(root) root.style.display='none'; resumeVisuals('esc'); } });

(function modalWatcher(){ const root=document.getElementById('modal-root'); if(!root) return; const obs = new MutationObserver(()=>{ const isVisible = (root.style.display !== 'none' && root.style.display !== ''); if(!isVisible){ setTimeout(()=> { if(!document.querySelector('.modal-backdrop') || document.querySelectorAll('.modal-backdrop').length === 0) resumeVisuals('modalWatcher'); }, 60); } }); obs.observe(root, { attributes: true, attributeFilter: ['style', 'class'] }); window.addEventListener('beforeunload', ()=> obs.disconnect(), {passive:true}); })();
</script>

<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notificationBtn = document.getElementById('notification-btn');
    const notificationPanel = document.getElementById('notification-panel');
    const notificationCloseBtn = document.getElementById('notification-close-btn');

    if (!notificationBtn || !notificationPanel || !notificationCloseBtn) {
        console.error('Notification elements could not be found in the DOM.');
        return;
    }

    // Function to show the panel
    function showPanel() {
        notificationPanel.classList.add('show');
        notificationPanel.setAttribute('aria-hidden', 'false');
    }

    // Function to hide the panel
    function hidePanel() {
        notificationPanel.classList.remove('show');
        notificationPanel.setAttribute('aria-hidden', 'true');
    }

    // Toggle panel on bell icon click
    notificationBtn.addEventListener('click', function(event) {
        event.stopPropagation(); // Prevents the document click listener from firing immediately
        if (notificationPanel.classList.contains('show')) {
            hidePanel();
        } else {
            showPanel();
        }
    });

    // Hide panel on close button click
    notificationCloseBtn.addEventListener('click', function() {
        hidePanel();
    });

    // Hide panel when clicking outside of it
    document.addEventListener('click', function(event) {
        if (notificationPanel.classList.contains('show') && !notificationPanel.contains(event.target) && !notificationBtn.contains(event.target)) {
            hidePanel();
        }
    });

    // Hide panel on 'Escape' key press
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && notificationPanel.classList.contains('show')) {
            hidePanel();
        }
    });
});
</script>
</body>
</html>
