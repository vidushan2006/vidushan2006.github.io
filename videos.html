<!DOCTYPE HTML>
<html>
<head>
  <title>VIDU</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    /* --- preserve background + fonts --- */
    body {
      background: url('assets/images/background.gif') no-repeat center center fixed;
      background-size: cover;
      font-family: "Helvetica Neue", Arial, sans-serif;
      margin:0;
      color: #fff;
    }

    /* header/nav tweaks */
    header#header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      backdrop-filter: blur(6px) saturate(120%);
      border-bottom:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 40px rgba(2,4,12,0.6);
      z-index: 4;
    }

    /* Logo */
    header#header .logo { display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff; user-select:none; position:relative; }
    header#header .logo img { height:78px; width:auto; border-radius:0; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }

    nav ul { list-style:none; display:flex; gap:12px; margin:0; padding:0; align-items:center; }
    nav ul li a {
      color:#fff;
      text-decoration:none;
      padding:8px 12px;
      border-radius:8px;
      font-weight:700;
      font-size:14px;
      display:inline-block;
      position:relative;
      transition: transform .18s ease, color .18s ease;
    }
    nav ul li a:hover { transform: translateY(-3px); color:#fff; }

    /* --- main container --- */
    .inner { max-width:1080px; margin: 0 auto; padding: 32px; color:#fff; position:relative; z-index:3; }
    h2 { margin-top:0; }

    /* main list (thumbnails on page) */
    .list-container { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: 1rem; }
    .list-item {
      width: 220px; /* main gallery cards keep fixed width */
      cursor: pointer;
      text-align: center;
      background: rgba(0,0,0,0.45);
      border-radius:8px;
      padding:8px;
      transition:transform .12s, box-shadow .12s;
      position:relative;
      overflow:visible;
    }
    .list-item:hover { transform: translateY(-6px); box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
    .list-item img { width: 100%; border-radius: 6px; display:block; }
    .list-item .title { display:block; margin-top: 0.6rem; color:#fff; font-weight:600; font-size:14px; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { width: min(960px, 95%); background:#0b0b0b; border-radius:10px; padding:16px; color:#fff; }
    .modal .controls { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .modal iframe { width:100%; height:540px; border-radius:8px; border:0; background:#000; }

    .btn { background:#ff6b6b; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; display:inline-block; border:0; cursor:pointer; position:relative; z-index:1; }
    .btn.secondary { background:#333; color:#fff; }
    .password-row { display:flex; gap:8px; margin-top:8px; }
    .password-row input { flex:1; padding:8px; border-radius:6px; border:1px solid #222; background:#0f0f0f; color:#fff; }
    .muted { color:#bbb; font-size:13px; }

    footer#footer { text-align:center; padding:18px; color:#ddd; margin-top:30px; }

    @media (max-width:720px) {
      .list-item { width: calc(50% - 12px); }
      .modal iframe { height:300px; }
      header#header .logo img { height:56px; }
    }

    /* entrance animation */
    .list-item { opacity:0; transform-origin:center; animation: fadeIn .45s forwards; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    /* playlist rows */
    .playlist-list { display:block; max-height:260px; overflow:auto; margin-top:8px; padding:0; }
    .playlist-list .list-item {
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      background:transparent;
      color:#fff;
      margin-bottom:6px;
      transition:background .12s, transform .08s;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      overflow:visible;
      opacity:1;
      animation:none;
    }
    .playlist-list .list-item:hover { background: rgba(255,255,255,0.02); transform: translateY(-2px); }
    .playlist-list .list-item img { width:120px; height:68px; object-fit:cover; border-radius:6px; flex: 0 0 120px; }
    .playlist-list .title-wrap { flex:1; min-width:0; display:flex; align-items:flex-start; }
    .playlist-list .playlist-title {
      display:block;
      white-space:normal;
      overflow:visible;
      font-size:14px;
      font-weight:600;
      color:#fff;
      line-height:1.25;
      word-wrap:break-word;
      overflow-wrap: anywhere;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #playlist-list-wrap .muted { margin-bottom:6px; display:block; }

    /* ===========================
       NEW: overlay player styles
       =========================== */
    .yt-player-outer {
      position: relative;
      width: 100%;
      height: 520px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    /* IFrame will be absolute and intentionally not receive pointer events.
       All interactions must go through our overlay controls. */
    .yt-player-outer iframe,
    .yt-player-outer > iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      pointer-events: none; /* <- makes the iframe untouchable */
    }

    /* overlay sits on top and handles interactions */
    .yt-overlay {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      background: linear-gradient(to top, rgba(0,0,0,0.66), rgba(0,0,0,0.0));
      pointer-events: auto; /* overlay should capture clicks */
      z-index: 20;
    }
    .yt-overlay .play-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      min-width: 86px;
      font-weight: 700;
    }
    .yt-overlay .time {
      color: #ddd;
      font-size: 13px;
      min-width: 96px;
      text-align:center;
    }
    .yt-overlay .seek {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.08);
      border-radius: 6px;
      outline: none;
      cursor: pointer;
    }
    .yt-overlay .seek::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ff6b6b;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .yt-player-outer.responsive-compact { height: 320px; }
    @media (max-width:720px) {
      .yt-player-outer { height: 320px; }
    }
  </style>
</head>
<body class="landing is-preload">

  <div id="wrapper">
    <!-- Header: logo text removed, logo enlarged -->
    <header id="header">
      <a href="index.html" class="logo" aria-label="VIDU home">
        <img src="https://i.pinimg.com/736x/4d/fa/7b/4dfa7b57656b556f257b4a2e4f8fc8fa.jpg" alt="VIDU Logo" />
      </a>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="videos.html">Private</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>

      <!-- Auth area -->
      <div id="auth-area">
        <button id="signin-fallback" class="btn">Sign in with Google</button>
      </div>
    </header>

    <!-- Videos Section -->
    <section id="videos" class="wrapper style2 fade-up">
      <div class="inner">
        <h2>Private Videos</h2>
        <p class="muted">Click a thumbnail and enter the password to view the video/playlist.</p>
        <ul id="global-video-list" class="list-container"></ul>
      </div>
    </section>

    <!-- Footer -->
    <footer id="footer">
      <p>&copy; VIDU. All rights reserved.</p>
    </footer>
  </div>

  <!-- Password & Embed Modal (hidden until needed) -->
  <div id="modal-root" style="display:none;"></div>

  <!-- Server hint (shows when user tries file:// sign-in) -->
  <div id="serve-hint" style="display:none; position:fixed; left:50%; top:10%; transform:translateX(-50%); background:rgba(6,6,8,0.95); color:#fff; padding:14px; border-radius:10px; z-index:99999; max-width:720px; box-shadow:0 30px 80px rgba(0,0,0,0.6);">
    <div style="font-weight:700; margin-bottom:8px;">Google sign-in won't run from <code>file://</code></div>
    <div class="muted" style="margin-bottom:8px;">Open the site via <code>http://localhost:8000</code> — quick commands:</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <div style="flex:1; min-width:180px;"><div style="font-weight:700">Python</div><code>python -m http.server 8000</code></div>
      <div style="flex:1; min-width:180px;"><div style="font-weight:700">Node</div><code>npx http-server -p 8000</code></div>
    </div>
    <div style="text-align:right; margin-top:10px;"><button id="serve-close" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);">Close</button></div>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- YouTube IFrame API (we use it to control playback while iframe is not interactive) -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
  /*************************************************************************
   * CONFIG - replace with your values (unchanged)
   *************************************************************************/
  const OAUTH_CLIENT_ID = '342354359423-s42kqoigp8207erl9i88pmo324clf6ps.apps.googleusercontent.com'; // required for sign-in
  const YT_API_KEY = 'AIzaSyDFyNxJJ_LbTEwLZkcLZ0wT3bDNfGcHCAI';             // optional fallback for playlist fetch

  /*************************************************************************
   * SAMPLE DATA (replace with your actual playlists)
   *************************************************************************/
  const globalVideos = [
    { type: 'video', title: 'TEST', thumb: 'https://i.pinimg.com/736x/e9/f1/5d/e9f15d10baf0131ab65bdc35d620adce.jpg', idB64:btoa("Lexok6H2c2s"), passB64:btoa("vidu123")},
    { type: 'playlist', title: 'SFT - Theory + Revision', thumb: 'https://i.pinimg.com/736x/b8/de/57/b8de57f639bb30fd9f48cda542dd96d2.jpg', idB64:btoa("PL9zX0VbNmKiGt19HZ9wzIwC-VQ_AN0z9K&si=0jJc5HTa68Weq851"), passB64:btoa("12zx34cvvidu") },
    { type: 'playlist', title: 'ICT', thumb: 'https://i.pinimg.com/736x/81/f4/0d/81f40de2906f0c61f2f17d6db61d7271.jpg', idB64:btoa("PL9zX0VbNmKiFlxda5PCTn4_hA_7iKjEaA&si=9nF_7qpAzKt4cYZd"), passB64:btoa("6002vidu") },
    { type: 'playlist', title: 'ET', thumb: 'https://i.pinimg.com/736x/19/b2/42/19b2424009813fc558e8a785c794cbdf.jpg', idB64:btoa("PL9zX0VbNmKiF-Q7bnmM1v_DrT3_Ol-Of5&si=efJHPzWR-kZcGwYw"), passB64:btoa("12zx34cvvidu") }
  ];

  /*************************************************************************
   * STATE
   *************************************************************************/
  let oauthToken = null;
  let profileInfo = null;
  let tokenClient = null;
  let currentItemIndex = null;
  const isFileProtocol = (location.protocol === 'file:');

  // YT player state
  let ytPlayer = null;
  let ytPollInterval = null;
  let YT_API_READY = new Promise((resolve) => {
    if (window.YT && window.YT.Player) return resolve(window.YT);
    window.onYouTubeIframeAPIReady = () => resolve(window.YT);
  });

  /*************************************************************************
   * HELPERS
   *************************************************************************/
  function b64decode(s) { try { return atob(s); } catch(e) { return s; } }
  function escapeHtml(s){ return (s||'').replace(/[&<>\"'`]/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[ch]); }

  /*************************************************************************
   * Show serve hint for file:// testing
   *************************************************************************/
  function showServeHint(){
    const el = document.getElementById('serve-hint');
    if(!el) return;
    el.style.display = 'block';
    document.getElementById('serve-close').onclick = ()=> el.style.display='none';
  }

  /*************************************************************************
   * Modal creation
   *************************************************************************/
  function createModal() {
    const root = document.getElementById('modal-root');
    root.innerHTML = `
      <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
          <div class="controls">
            <div>
              <strong id="modal-title">Locked</strong>
              <div class="muted" id="modal-subtitle"></div>
            </div>
            <div><button id="modal-close" class="btn secondary">Close</button></div>
          </div>
          <div id="modal-content">
            <div id="password-block">
              <div class="muted">This item is password-protected. Enter the password to unlock and play.</div>
              <div class="password-row" style="margin-top:10px;">
                <input id="password-input" type="password" placeholder="Enter password" />
                <button id="password-submit" class="btn">Unlock</button>
              </div>
              <div id="password-error" class="muted" style="margin-top:8px;color:#f66;display:none;"></div>
            </div>

            <div id="player-block" style="display:none; margin-top:10px;">
              <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div id="now-playing-label" class="muted">Now playing</div>
                <div>
                  <button id="close-player" class="btn">Close Player</button>
                </div>
              </div>

              <div id="player-wrap"></div>

              <div id="playlist-list-wrap" style="display:none; margin-top:12px;">
                <div class="muted">Playlist contents</div>
                <div class="playlist-list" id="playlist-video-list" style="max-height:260px; overflow:auto;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    document.getElementById('modal-close').onclick = closeModal;
    document.getElementById('close-player').onclick = closeModal;
    document.getElementById('password-submit').onclick = onPasswordSubmit;
    document.getElementById('password-input').onkeydown = (e)=>{ if(e.key === 'Enter') onPasswordSubmit(); };
    document.getElementById('modal-backdrop').onclick = function(e){ if(e.target === this) closeModal(); };
  }

  function openPasswordModal(idx) {
    currentItemIndex = idx;
    const item = globalVideos[idx];
    const title = item.title || 'Protected item';
    const subtitle = (item.type === 'playlist') ? 'Playlist' : 'Video';
    const root = document.getElementById('modal-root');
    root.style.display = 'block';
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-subtitle').textContent = subtitle + ' — password required';
    document.getElementById('password-input').value = '';
    document.getElementById('password-error').style.display = 'none';
    document.getElementById('password-block').style.display = 'block';
    document.getElementById('player-block').style.display = 'none';
    setTimeout(()=>document.getElementById('password-input').focus(), 50);
  }

  function closeModal() {
    const root = document.getElementById('modal-root');
    root.style.display = 'none';
    destroyYTPlayer();
    const wrap = document.getElementById('player-wrap');
    if (wrap) wrap.innerHTML = '';
    const pl = document.getElementById('playlist-video-list'); if(pl) pl.innerHTML = '';
    currentItemIndex = null;
  }

  function onPasswordSubmit() {
    const val = (document.getElementById('password-input').value || '').trim();
    const item = globalVideos[currentItemIndex];
    const expected = b64decode((item.passB64 || '').trim());
    if (val === expected) {
      document.getElementById('password-block').style.display = 'none';
      document.getElementById('password-error').style.display = 'none';
      showPlayerForItem(item);
    } else {
      const err = document.getElementById('password-error');
      err.style.display = 'block';
      err.textContent = 'Incorrect password — try again.';
    }
  }

  /*************************************************************************
   * YouTube player / overlay logic (NEW)
   *
   * - iframe/player is intentionally untouchable via pointer-events:none
   * - overlay on top provides Pause/Resume + seek only
   *************************************************************************/
  function destroyYTPlayer(){
    if(ytPollInterval){ clearInterval(ytPollInterval); ytPollInterval = null; }
    if(ytPlayer && ytPlayer.destroy) { try { ytPlayer.destroy(); } catch(e){} }
    ytPlayer = null;
  }

  async function createYouTubePlayer(videoId, title){
    // Wait for YT API
    await YT_API_READY;

    // Prepare player DOM with overlay
    const wrap = document.getElementById('player-wrap');
    wrap.innerHTML = `
      <div class="yt-player-outer" id="yt-player-outer">
        <div id="yt-player"></div>
        <div class="yt-overlay" id="yt-overlay" aria-label="Video controls">
          <button class="play-btn" id="yt-play-toggle" aria-pressed="false">Pause</button>
          <div class="time" id="yt-current-time">0:00</div>
          <input type="range" min="0" max="100" value="0" step="0.1" id="yt-seek" class="seek" aria-label="Seek video">
          <div class="time" id="yt-duration">0:00</div>
        </div>
      </div>
    `;

    // Ensure previous is removed
    destroyYTPlayer();

    // Create the player via YT.Player (enablejsapi=1 is set by API itself)
    ytPlayer = new YT.Player('yt-player', {
      height: '520',
      width: '100%',
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        controls: 0,          // hide native controls
        rel: 0,
        modestbranding: 1,
        iv_load_policy: 3,
        disablekb: 1,
        fs: 0,                // prevent fullscreen button in player chrome (we control UI)
        origin: location.origin
      },
      events: {
        onReady: (e) => {
          try { e.target.playVideo(); } catch(e){}
          // Start updater
          startYTUpdater();
          // Update title
          const now = document.getElementById('now-playing-label');
          if(now) now.textContent = title ? `Now playing — ${title}` : 'Now playing';
        },
        onStateChange: (e) => {
          const btn = document.getElementById('yt-play-toggle');
          if(!btn) return;
          // 1 = playing, 2 = paused, 0 = ended
          if (e.data === YT.PlayerState.PLAYING) { btn.textContent = 'Pause'; btn.setAttribute('aria-pressed','false'); }
          else if (e.data === YT.PlayerState.PAUSED) { btn.textContent = 'Resume'; btn.setAttribute('aria-pressed','true'); }
          else if (e.data === YT.PlayerState.ENDED) { btn.textContent = 'Replay'; btn.setAttribute('aria-pressed','true'); }
        }
      }
    });

    // Hook up overlay controls
    const toggle = document.getElementById('yt-play-toggle');
    const seek = document.getElementById('yt-seek');

    toggle.onclick = () => {
      if (!ytPlayer || !ytPlayer.getPlayerState) return;
      const state = ytPlayer.getPlayerState();
      if(state === YT.PlayerState.PLAYING) { ytPlayer.pauseVideo(); }
      else { ytPlayer.playVideo(); }
    };

    let isSeeking = false;
    seek.addEventListener('input', (e) => {
      // while dragging, update current time text, don't force seek until change event
      const p = parseFloat(e.target.value);
      const dur = Math.max(1, (ytPlayer && ytPlayer.getDuration) ? ytPlayer.getDuration() : 1);
      const secs = (p / 100) * dur;
      document.getElementById('yt-current-time').textContent = formatTime(secs);
    });
    seek.addEventListener('change', (e) => {
      if(!ytPlayer || !ytPlayer.seekTo) return;
      const p = parseFloat(e.target.value);
      const dur = Math.max(1, ytPlayer.getDuration ? ytPlayer.getDuration() : 1);
      const secs = (p / 100) * dur;
      // Seek and reflect
      ytPlayer.seekTo(secs, true);
    });

    // start updater polls
    function startYTUpdater(){
      if(ytPollInterval) clearInterval(ytPollInterval);
      ytPollInterval = setInterval(()=> {
        if(!ytPlayer || !ytPlayer.getCurrentTime || !ytPlayer.getDuration) return;
        try {
          const cur = ytPlayer.getCurrentTime() || 0;
          const dur = ytPlayer.getDuration() || 0;
          // avoid NaN
          if(isFinite(cur) && isFinite(dur) && dur > 0){
            const pct = (cur / dur) * 100;
            const seekEl = document.getElementById('yt-seek');
            if(seekEl && !seekEl.matches(':active')) seekEl.value = pct;
            document.getElementById('yt-current-time').textContent = formatTime(cur);
            document.getElementById('yt-duration').textContent = formatTime(dur);
          }
        } catch(e){}
      }, 250);
    }
  }

  function formatTime(seconds){
    seconds = Math.max(0, Math.floor(seconds || 0));
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  /*************************************************************************
   * Playlist fetch + render (unchanged except hooking into createYouTubePlayer)
   *************************************************************************/
  async function fetchPlaylistVideos(playlistId){
    const items = []; let pageToken = '';
    do{
      let url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${encodeURIComponent(playlistId)}`;
      const headers = {};
      if(oauthToken) headers['Authorization'] = 'Bearer ' + oauthToken;
      else if(YT_API_KEY && YT_API_KEY !== 'YOUR_API_KEY_HERE') url += `&key=${encodeURIComponent(YT_API_KEY)}`;
      else throw new Error('No OAuth token and no API key configured. Sign in or set an API key.');

      if(pageToken) url += `&pageToken=${pageToken}`;
      const res = await fetch(url, { headers });
      if(!res.ok){
        const txt = await res.text().catch(()=>null);
        throw new Error('YouTube API error: '+res.status+' '+res.statusText+' '+(txt||''));
      }
      const data = await res.json();
      (data.items||[]).forEach(it => {
        const sn = it.snippet || {};
        if(sn.resourceId && sn.resourceId.videoId){
          const thumb = (sn.thumbnails && (sn.thumbnails.medium||sn.thumbnails.high||sn.thumbnails.default))||{};
          items.push({ videoId: sn.resourceId.videoId, title: sn.title||'Untitled', thumb: thumb.url||`https://img.youtube.com/vi/${sn.resourceId.videoId}/hqdefault.jpg` });
        }
      });
      pageToken = data.nextPageToken || '';
    } while(pageToken);
    return items;
  }

  async function showPlaylistInsideModal(item){
    const rawId = b64decode(item.idB64), playlistId = rawId.split('&')[0];
    try{
      const videos = await fetchPlaylistVideos(playlistId);
      if(!videos.length){ document.getElementById('player-wrap').innerHTML = `<div class="muted">No videos found or playlist is private.</div>`; document.getElementById('player-block').style.display='block'; return; }

      const listWrap = document.getElementById('playlist-video-list');
      listWrap.innerHTML = '';

      // Build rows with thumbnail + full title (wrapping)
      videos.forEach(v=>{
        const li = document.createElement('div');
        li.className = 'list-item';
        li.setAttribute('data-video-id', v.videoId);
        const thumb = escapeHtml(v.thumb || `https://img.youtube.com/vi/${v.videoId}/hqdefault.jpg`);
        const titleHtml = `<div class="title-wrap"><div class="playlist-title">${escapeHtml(v.title)}</div></div>`;
        li.innerHTML = `<img src="${thumb}" alt="${escapeHtml(v.title)}" loading="lazy" />` + titleHtml;
        li.onclick = ()=> createYouTubePlayer(v.videoId, v.title); // open via our API + overlay
        listWrap.appendChild(li);
      });

      document.getElementById('player-block').style.display='block';
      document.getElementById('playlist-list-wrap').style.display='block';
      // Play first video immediately
      createYouTubePlayer(videos[0].videoId, videos[0].title);
    } catch(err){
      console.error('Playlist fetch error', err);
      document.getElementById('player-wrap').innerHTML = `<div class="muted">Failed to load playlist: ${escapeHtml(err.message||'')}</div>`;
      document.getElementById('player-block').style.display='block';
    }
  }

  function showPlayerForVideo(videoId, title){
    // Create the locked iframe + overlay using the YT API
    createYouTubePlayer(videoId, title);
  }

  function showPlayerForItem(item){
    if(item.type==='video'){ const id=b64decode(item.idB64); showPlayerForVideo(id, item.title||item.name); } else showPlaylistInsideModal(item);
  }

  /*************************************************************************
   * Render main list (unchanged)
   *************************************************************************/
  function getThumb(item) {
    if (item.thumb && item.thumb.trim().length) return item.thumb;
    try {
      const id = b64decode(item.idB64);
      if (item.type === 'video') return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
      return 'https://i.imgur.com/8Km9tLL.png';
    } catch(e) { return 'https://i.imgur.com/8Km9tLL.png'; }
  }

  function renderList() {
    const ul = document.getElementById('global-video-list');
    ul.innerHTML = '';
    globalVideos.forEach((v, i) => {
      const li = document.createElement('li');
      li.className = 'list-item ripple';
      const thumb = getThumb(v);
      li.innerHTML = `
        <img src="${escapeHtml(thumb)}" alt="${escapeHtml(v.title)}" loading="lazy" />
        <span class="title">${escapeHtml(v.title)}</span>
      `;
      li.onclick = ()=> openPasswordModal(i);
      ul.appendChild(li);
    });
  }

  /*************************************************************************
   * Google OAuth (GSI) init & UI wiring (unchanged)
   *************************************************************************/
  function initGoogleOAuth(){
    if (isFileProtocol) { return; }
    if(!OAUTH_CLIENT_ID || OAUTH_CLIENT_ID === 'YOUR_OAUTH_CLIENT_ID_HERE'){ console.warn('OAUTH_CLIENT_ID not set.'); return; }
    if(!window.google){ setTimeout(initGoogleOAuth, 300); return; }
    if(tokenClient) return;
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: OAUTH_CLIENT_ID,
      scope: 'openid email profile https://www.googleapis.com/auth/youtube.readonly',
      callback: (resp) => {
        if(resp.error){ console.error('OAuth failed', resp); alert('Google sign-in failed: ' + (resp.error || 'unknown')); return; }
        oauthToken = resp.access_token;
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: 'Bearer ' + oauthToken } })
          .then(r=>r.json()).then(profile => {
            profileInfo = profile;
            const auth = document.getElementById('auth-area');
            auth.classList.add('logged-in');
            auth.innerHTML = `<div class="avatar"><img src="${profile.picture||''}" alt="avatar"/></div><div style="display:flex;align-items:center;gap:8px;"><button id="signout-btn" class="btn">Sign out</button></div>`;
            document.getElementById('signout-btn').onclick = signOutGoogle;
          }).catch(err => { console.warn('userinfo fetch failed', err); });
      }
    });
  }

  function signInWithGoogle(){
    if(isFileProtocol){ showServeHint(); return; }
    if(!tokenClient){ initGoogleOAuth(); setTimeout(signInWithGoogle, 300); return; }
    tokenClient.requestAccessToken({ prompt: 'consent' });
  }

  function signOutGoogle(){
    if(oauthToken){
      const revokeUrl = 'https://oauth2.googleapis.com/revoke?token=' + encodeURIComponent(oauthToken);
      fetch(revokeUrl, { method:'POST', headers:{ 'Content-type':'application/x-www-form-urlencoded' } }).catch(()=>{}).finally(()=>{
        oauthToken = null; profileInfo = null;
        const auth = document.getElementById('auth-area');
        auth.classList.remove('logged-in');
        auth.innerHTML = `<button id="signin-fallback" class="btn">Sign in with Google</button>`;
        document.getElementById('signin-fallback').addEventListener('click', ()=> {
          if(isFileProtocol){ showServeHint(); return; }
          initGoogleOAuth(); setTimeout(signInWithGoogle, 250);
        });
      });
    } else { profileInfo = null; }
  }

  // fallback hookup for initial visible button
  document.addEventListener('DOMContentLoaded', ()=> {
    createModal();
    renderList();
    attachHeaderInteractions();
    if(!isFileProtocol) initGoogleOAuth();
    // entrance delays
    const cards=document.querySelectorAll('.list-item'); cards.forEach((c,i)=> c.style.animationDelay=(i*60)+'ms');

    const fb = document.getElementById('signin-fallback');
    if(fb) fb.addEventListener('click', ()=> {
      if(isFileProtocol){ showServeHint(); return; }
      initGoogleOAuth(); setTimeout(signInWithGoogle, 250);
    });
  });

  /*************************************************************************
   * Particles overlay (unchanged)
   *************************************************************************/
  (function createParticles(){
    try {
      const canvas=document.createElement('canvas'); canvas.id='fx-canvas'; canvas.style.position='fixed'; canvas.style.left='0'; canvas.style.top='0'; canvas.style.width='100%'; canvas.style.height='100%'; canvas.style.zIndex='1'; canvas.style.pointerEvents='none'; document.body.appendChild(canvas);
      const ctx=canvas.getContext('2d'); let dpr=Math.min(2, window.devicePixelRatio || 1);
      function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
      window.addEventListener('resize', resize, {passive:true}); resize();
      const stars=[]; for(let i=0;i<80;i++){ stars.push({ x:Math.random()*innerWidth, y:Math.random()*innerHeight, r:Math.random()*1.8+0.3, vx:(Math.random()-0.5)*0.12, vy:(Math.random()-0.5)*0.06, hue:200+Math.random()*120, alpha:Math.random()*0.22+0.06 }); }
      function draw(){ ctx.clearRect(0,0,innerWidth,innerHeight); const g=ctx.createRadialGradient(innerWidth*0.7, innerHeight*0.35, 0, innerWidth*0.4, innerHeight*0.6, Math.max(innerWidth,innerHeight)); g.addColorStop(0,'rgba(123,97,255,0.05)'); g.addColorStop(0.45,'rgba(57,255,20,0.02)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,innerWidth,innerHeight);

        for(const s of stars){ s.x+=s.vx; s.y+=s.vy; if(s.x<-10) s.x=innerWidth+10; if(s.x>innerWidth+10) s.x=-10; if(s.y<-10) s.y=innerHeight+10; if(s.y>innerHeight+10) s.y=-10; ctx.beginPath(); ctx.fillStyle=`hsla(${s.hue},85%,70%,${s.alpha})`; ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }

        for(let i=0;i<stars.length;i++){ const a=stars[i]; for(let j=i+1;j<stars.length;j++){ const b=stars[j]; const dx=a.x-b.x, dy=a.y-b.y; const d=Math.sqrt(dx*dx+dy*dy); if(d<140){ ctx.beginPath(); ctx.strokeStyle=`rgba(120,150,255,${(1-d/140)*0.03})`; ctx.lineWidth=1; ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); } } }
        requestAnimationFrame(draw);
      }
      draw();
    } catch(e){ console.warn('particles failed', e); }
  })();

  /* header neon interactions (unchanged) */
  function attachHeaderInteractions(){
    const selector = 'header nav ul li a, header .logo';
    const els = Array.from(document.querySelectorAll(selector));
    if(els.length === 0){ setTimeout(attachHeaderInteractions, 200); return; }

    function onPointerEnter(e){ if(e.pointerType === 'touch') return; e.currentTarget.classList.add('hover-strong'); }
    function onPointerLeave(e){ e.currentTarget.classList.remove('hover-strong'); }
    function onPointerDown(e){ const el = e.currentTarget; el.classList.add('touch-active'); el.classList.add('pulse'); setTimeout(()=> el.classList.remove('pulse'), 480); setTimeout(()=> el.classList.remove('touch-active'), 420); }
    function onTouchStart(e){ const el = e.currentTarget; el.classList.add('touch-active'); setTimeout(()=> el.classList.remove('touch-active'), 420); }

    els.forEach(el=>{
      if(getComputedStyle(el).position === 'static') el.style.position = 'relative';
      el.addEventListener('pointerenter', onPointerEnter, {passive:true});
      el.addEventListener('pointerleave', onPointerLeave, {passive:true});
      el.addEventListener('pointerdown', onPointerDown, {passive:true});
      el.addEventListener('touchstart', onTouchStart, {passive:true});
      el.addEventListener('focus', ()=> el.classList.add('hover-strong'));
      el.addEventListener('blur', ()=> el.classList.remove('hover-strong'));
    });

    const mo = new MutationObserver(()=> attachHeaderInteractions());
    mo.observe(document.body, { childList:true, subtree:true });
  }

  // small deterrents & keyboard UX
  document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, false);
  document.addEventListener('keydown', function(e){
    if ((e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) ||
        (e.ctrlKey && (e.key === 'U' || e.key === 'u')) ||
        (e.key === 'F12')) { e.preventDefault(); return false; }
  });
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { closeModal(); } });
  </script>

  <!-- HTML5 UP Scripts kept as before -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>
</body>
</html>
