<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Classes — VIDU</title>

  <style>
    /* ---- page layout & visuals (self-contained) ---- */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{background:url('assets/images/background.gif') center/cover fixed no-repeat; color:#eaf7ea; line-height:1.35}

    .topbar{position:fixed;left:0;right:0;top:0;z-index:120;background:linear-gradient(180deg, rgba(8,10,10,0.45), rgba(8,10,10,0.18));backdrop-filter:blur(6px) saturate(120%);border-bottom:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    .topbar-inner{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .left{display:flex;align-items:center;gap:14px}
    .logo-btn{display:inline-flex;align-items:center;justify-content:center;width:46px;height:46px;border-radius:6px;background:linear-gradient(180deg,#07110a,#06200b);box-shadow:0 8px 26px rgba(0,0,0,0.6);text-decoration:none}
    .nav{display:flex;gap:12px;align-items:center}
    .nav a,.nav button{color:#dfeee1;text-decoration:none;padding:8px 10px;font-weight:700;border-radius:6px;font-size:14px;background:transparent;border:0;cursor:pointer}
    .nav a:hover,.nav button:hover{transform:translateY(-2px);transition:transform .18s ease}

    .page{margin-top:100px;min-height:calc(100vh - 120px)}
    .container{max-width:1200px;margin:0 auto;padding:28px}
    .title{font-size:42px;color:#fff;text-shadow:0 8px 36px rgba(0,0,0,0.65);margin-bottom:8px;font-weight:900}
    .subtitle{color:rgba(230,240,230,0.78);margin-bottom:32px;font-size:15px}

    .tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:22px;align-items:start}
    @media (min-width:900px){ .tiles{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:640px){ .tiles{grid-template-columns:1fr;gap:14px; justify-items:center;} .card{width:100%;max-width:420px;} }

    /* unified card styling */
    .card{display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.45));border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .22s,box-shadow .22s;box-shadow:0 14px 30px rgba(0,0,0,0.55);min-height:300px}
    .card:hover{transform:translateY(-8px);box-shadow:0 34px 60px rgba(0,0,0,0.65)}
    .card-media{position:relative;height:220px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.75));border-bottom:1px solid rgba(255,255,255,0.03);overflow:visible}

    /*
      Fixed neon area logic:
      - .neon-wrap has a fixed width that is wide enough to show five characters with .neon size.
      - .neon has a single fixed font-size so no JS resizing needed.
      - This ensures consistency across all thumbnails and avoids getting clipped or hidden.
    */
    .neon-wrap{
      position:relative;
      z-index:1;
      /* fixed width chosen so five typical uppercase letters will fit */
      width: 240px;
      max-width: 240px;
      display:block;
      margin:0 auto;
      overflow:hidden; /* clip glow/reflection */
      text-align:center;
      pointer-events:none;
    }

    .neon{
      font-weight:900;
      letter-spacing:6px;
      color:#00ff3a;
      text-shadow:0 0 6px rgba(0,255,120,0.95),0 0 18px rgba(0,255,120,0.45),0 18px 28px rgba(0,0,0,0.6);
      mix-blend-mode:screen;
      line-height:0.9;
      transform:translateY(-6px);
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
      /* fixed font-size to guarantee 5 letters fit inside 240px neon-wrap */
      font-size:48px !important;
    }

    /* smaller variant when the neon text is intentionally shorter */
    .neon.small{
      font-size:48px !important;
      letter-spacing:4px;
    }

    .neon-reflect{
      position:relative;
      text-align:center;
      transform:scaleY(-1);
      opacity:0.22;
      filter:blur(4px);
      font-weight:900;
      color:#00ff3a;
      mix-blend-mode:screen;
      pointer-events:none;
      white-space:nowrap;
      font-size:48px !important;
      margin-top:6px;
    }

    .card-caption{padding:14px 12px 18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column;align-items:center;gap:6px}
    .card-title{font-weight:800;color:#eaf8ea;font-size:14px;text-align:center}
    .card-type{font-size:11px;color:rgba(170,255,190,0.92);font-weight:700;text-transform:uppercase}

    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.62);z-index:300;padding:18px}
    .modal.hidden{display:none}
    .modal-box{max-width:420px;width:100%;background:linear-gradient(180deg, rgba(8,10,8,0.98), rgba(6,8,6,0.95));border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.7);color:#fff;text-align:center;position:relative}
    .modal-close{position:absolute;right:10px;top:10px;background:transparent;border:none;color:#ddd;font-size:18px;cursor:pointer}
    .modal-preview{height:120px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
    .pw-input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;margin-top:8px}
    .pw-actions{display:flex;gap:8px;margin-top:12px;justify-content:center}
    .btn{padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#00c85f,#00a955);color:white}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dfeee1}

    .viewer{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.78);z-index:400;padding:22px}
    .viewer.hidden{display:none}
    .viewer-inner{width:100%;max-width:1100px;height:72vh;border-radius:12px;overflow:hidden;background:rgba(2,2,2,0.75);position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.8);display:flex;flex-direction:column}
    .viewer-close{position:absolute;top:10px;right:10px;background:transparent;border:none;color:#ddd;font-size:20px;cursor:pointer;z-index:5}

    /* Now playing title (new): sits above the player */
    .now-playing {
      width:100%;
      padding:10px 16px;
      box-sizing:border-box;
      background:linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.45));
      color:#e8f7e8;
      font-weight:900;
      letter-spacing:0.6px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      z-index:8;
    }
    .now-playing .label { color:rgba(200,255,190,0.85); font-weight:800; font-size:13px; opacity:0.95; text-transform:uppercase; }
    .now-playing .title { color:#fff; font-size:15px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .iframe-wrap{width:100%;height:62%;display:block;background:#000;position:relative;border-bottom:1px solid rgba(255,255,255,0.03)}
    .viewer-playlist{width:100%;height:38%;box-sizing:border-box;overflow:auto;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.08));}
    .viewer-playlist .list-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;cursor:pointer;background:transparent;transition:background .12s}
    .viewer-playlist .list-item:hover{background:rgba(255,255,255,0.02)}
    .viewer-playlist img{width:120px;height:68px;object-fit:cover;border-radius:6px;flex:0 0 120px;}
    .playlist-meta{flex:1;display:flex;flex-direction:column;gap:6px}
    .playlist-title{font-size:14px;font-weight:700;color:#fff}
    .playlist-sub{font-size:12px;color:rgba(220,220,220,0.7)}

    .playlist-list{max-height:220px;overflow:auto}
    .copyright{text-align:center;margin-top:28px;color:rgba(255,255,255,0.85);font-size:13px}

    /* ===== player UI styles (must match JS expectations) ===== */
    .vidu-player-host{position:relative;width:100%;height:100%;overflow:hidden;border-radius:8px;background:#000}
    .vidu-mount{width:100%;height:100%;background:#000}
    .vidu-mount iframe{width:100%;height:100%;border:0;display:block}

    /* loading overlay (shows header.png until playback begins) */
    .vidu-loading{position:absolute;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;background-image: url('assets/images/header.png');background-repeat:no-repeat;background-position:center;background-size:cover;transition:opacity .28s ease;pointer-events:none}
    .vidu-loading.hidden{opacity:0;transform:scale(1.02);pointer-events:none;display:none}

    .vidu-controls-bg{position:absolute;left:0;right:0;bottom:0;height:64px;background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));pointer-events:none;z-index:9996;opacity:1;transition:opacity .22s ease, transform .22s ease;backdrop-filter:blur(4px)}
    .vidu-controls-bg.hidden{opacity:0;transform:translateY(6px)}

    .vidu-overlay{position:absolute;left:12px;right:12px;bottom:12px;z-index:9999;display:flex;gap:12px;align-items:center;padding:8px 12px;border-radius:10px;box-sizing:border-box;pointer-events:auto}
    .vidu-overlay.hidden{opacity:0;transform:translateY(6px);pointer-events:none}

    .vidu-overlay .inner-bg{position:absolute;inset:0;border-radius:10px;pointer-events:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));z-index:-1}

    .vidu-btn{background:rgba(255,255,255,0.06);color:#fff;padding:8px;border-radius:22px;cursor:pointer;font-weight:700;user-select:none;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;width:46px;height:46px;transition:transform .12s ease}
    .vidu-btn:active{transform:scale(.96)}

    .vidu-range{flex:1;-webkit-appearance:none;height:8px;border-radius:8px;background:rgba(255,255,255,0.06)}
    .vidu-range::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#39ff14;box-shadow:0 2px 8px rgba(0,0,0,0.5);border:2px solid rgba(0,0,0,0.18);margin-top:-4px}
    .vidu-range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#39ff14;border:2px solid rgba(0,0,0,0.18)}

    .vidu-time{min-width:90px;font-size:14px;font-weight:800;color:#cbd5ff;text-align:center;letter-spacing:1px}

    .vidu-close-btn{position:absolute;top:10px;right:10px;z-index:10002;width:36px;height:36px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.46);border:1px solid rgba(255,255,255,0.06);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.6);transition:opacity .18s ease,transform .18s ease}
    .vidu-close-btn.hidden{opacity:0;transform:translateY(-6px);pointer-events:none}

    /* small responsive tweaks */
    @media (max-width:720px){
      .vidu-time{min-width:76px;font-size:12px}
      .vidu-mount{height:320px}
      .iframe-wrap{height:56%}
      .viewer-playlist{height:44%}
      .now-playing{font-size:13px;padding:8px 10px}
      .now-playing .title{font-size:13px}
    }

    /* mobile visual adjustments: center and keep neon area the same size */
    @media (max-width:640px){
      .card { align-items: center; background: rgba(0,0,0,0.66); }
      .card-media { justify-content: center; align-items: center; position:relative; width:100%; overflow:visible; border-radius:8px; padding:18px 0; }
      .card-media::before{
        content: "";
        position: absolute;
        inset: 0;
        background: #000;
        border-radius: 8px;
        z-index: 0;
        opacity: 0.98;
      }
      /* Keep the neon-wrap fixed width on mobile as well so five letters are always visible */
      .neon-wrap { width: 240px; max-width:240px; }
      .neon, .neon-reflect { font-size:48px !important; }
      .card-caption { align-items: center; text-align: center; padding-top: 12px; padding-bottom: 14px; z-index: 1; width:100% }
    }

    @media (max-width:360px){
      /* very narrow devices: slightly reduce neon area so it still fits comfortably in narrow screens */
      .neon-wrap { width: 200px; max-width:200px; }
      .neon, .neon-reflect { font-size:44px !important; }
    }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="left">
        <a class="logo-btn" href="index.html" title="Home" aria-label="Home">
          <svg width="30" height="30" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <defs><linearGradient id="gV" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#00ff55"/><stop offset="1" stop-color="#00b86a"/></linearGradient></defs>
            <rect x="4" y="4" width="56" height="56" rx="8" fill="#07120b"/>
            <path d="M16 16 L32 46 L48 16" stroke="url(#gV)" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <nav class="nav" aria-label="Main navigation">
          <a href="index.html">Home</a>
          <button id="nav-private">Private</button>
          <a href="about.html">About</a>
        </nav>
      </div>
      <div style="width:46px;height:46px;"></div>
    </div>
  </header>

  <main class="page" role="main">
    <div class="container">
      <h1 class="title">Private Classes</h1>
      <p class="subtitle">To access Enter the password or sign in with a Google account that has admin access</p>

      <section id="tiles" class="tiles" aria-live="polite"></section>
      <div class="copyright">© VIDU. All rights reserved.</div>
    </div>
  </main>

  <!-- password modal -->
  <div id="pw-modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-box" role="document">
      <button class="modal-close" id="pw-close" aria-label="Close">✕</button>
      <div class="modal-preview" id="modal-preview"></div>
      <h3 id="pw-title" style="color:#dfeee1;font-weight:800;margin-bottom:6px;">Enter password</h3>
      <input id="pw-input" class="pw-input" type="password" placeholder="Password" autocomplete="off" />
      <div class="pw-actions">
        <button id="pw-submit" class="btn">Unlock</button>
        <button id="pw-cancel" class="btn ghost">Cancel</button>
      </div>
      <p id="pw-error" style="color:#ff8080;margin-top:10px;min-height:18px;"></p>
    </div>
  </div>

  <!-- viewer overlay -->
  <div id="viewer" class="viewer hidden" aria-hidden="true">
    <div class="viewer-inner">
      <button id="viewer-close" class="viewer-close" aria-label="Close viewer">✕</button>

      <!-- NOW PLAYING title (ADDED) -->
      <div class="now-playing" aria-hidden="false">
        <div class="label">Now playing</div>
        <div class="title" id="now-playing-title">—</div>
      </div>

      <!-- video host -->
      <div id="iframe-wrap" class="iframe-wrap"></div>

      <!-- playlist BELOW the player now -->
      <div id="viewer-playlist" class="viewer-playlist" aria-live="polite"></div>
    </div>
  </div>

  <div id="js-fail-note" style="display:none;position:fixed;right:14px;bottom:14px;background:rgba(255,80,80,0.12);color:#ffdede;border:1px solid rgba(255,80,80,0.2);padding:8px 12px;border-radius:8px;font-size:13px;z-index:9999">Some features may be unavailable — enable JavaScript.</div>

  <script>
  (function(){
    /* ---------- configuration ---------- */
    const YT_API_KEY = 'AIzaSyDFyNxJJ_LbTEwLZkcLZ0wT3bDNfGcHCAI'; // keep your key here (used for playlist fetching)
    const YT_API_LOAD_TIMEOUT = 18000; // ms - how long to wait for YT API before showing error

    /* ---------- sample items (unchanged layout) ---------- */
    const items = [
      { type: 'video', title: 'PHONK', idB64: btoa("m0fM0rBN7cQ"), passB64: btoa("")},
      { type: 'video', title: 'TEST', idB64: btoa("Lexok6H2c2s"), passB64: btoa("")},
      { type: 'playlist', title: 'SFT - Theory + Revision', idB64: btoa("PL9zX0VbNmKiGt19HZ9wzIwC-VQ_AN0z9K&si=0jJc5HTa68Weq851"), passB64: btoa("vidu123sft") },
      { type: 'playlist', title: 'ICT', idB64: btoa("PL9zX0VbNmKiFlxda5PCTn4_hA_7iKjEaA&si=9nF_7qpAzKt4cYZd"), passB64: btoa("6002vidu") },
      { type: 'playlist', title: 'ET', idB64: btoa("PL9zX0VbNmKiF-Q7bnmM1v_DrT3_Ol-Of5&si=efJHPzWR-kZcGwYw"), passB64: btoa("vidu123et")}
    ];

    /* ---------- utilities ---------- */
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function neonTextFor(title){
      if(!title) return '';
      const main = (title||'').split(/[\u2013\u2014\-+]/)[0].trim();
      const words = main.split(/\s+/);
      if(words.length === 1) return words[0].toUpperCase().slice(0, 6);
      return words[0].toUpperCase();
    }
    function normalizeIdFromB64(idB64){
      try { return atob(idB64 || '').split('&')[0]; } catch(e){ console.warn('Invalid idB64', idB64, e); return ''; }
    }

    /* ---------- render tiles (neon-wrap fixed-size approach) ---------- */
    function buildTiles(){
      const tiles = document.getElementById('tiles');
      tiles.innerHTML = '';
      items.forEach((it, idx)=>{
        const card = document.createElement('button');
        card.className = 'card';
        card.type = 'button';
        card.setAttribute('data-idx', idx);
        card.setAttribute('aria-label', it.title + ' ' + it.type);

        const neon = neonTextFor(it.title);
        const small = neon.length > 6 ? ' small' : '';
        card.innerHTML = `
          <div class="card-media" role="img" aria-label="${escapeHtml(it.title)} thumbnail">
            <div class="neon-wrap">
              <div class="neon${small}">${escapeHtml(neon)}</div>
              <div class="neon-reflect${small}" aria-hidden="true">${escapeHtml(neon)}</div>
            </div>
          </div>
          <div class="card-caption">
            <div class="card-title">${escapeHtml(it.title)}</div>
            <div class="card-type">${escapeHtml(it.type)}</div>
          </div>
        `;
        card.addEventListener('click', ()=> openPasswordModal(it));
        tiles.appendChild(card);
      });
    }

    /* ---------- modal ---------- */
    let currentItem = null;
    const pwModal = document.getElementById('pw-modal');
    const pwTitleEl = document.getElementById('pw-title');
    const pwInput = document.getElementById('pw-input');
    const pwSubmit = document.getElementById('pw-submit');
    const pwCancel = document.getElementById('pw-cancel');
    const pwClose = document.getElementById('pw-close');
    const pwError = document.getElementById('pw-error');
    const modalPreview = document.getElementById('modal-preview');

    function showModal(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

    function openPasswordModal(item){
      // If the item has no password (passB64 empty when decoded) skip the modal and open directly
      try{
        const decoded = item && typeof item.passB64 === 'string' ? atob(item.passB64) : '';
        if(!decoded || decoded.trim() === ''){
          // no password set — open directly
          openViewer(item);
          return;
        }
      }catch(e){
        // if decoding fails, continue with the normal modal flow
        console.warn('passB64 decode failed, showing modal', e);
      }

      currentItem = item;
      pwError.textContent = '';
      pwInput.value = '';
      pwTitleEl.textContent = `Unlock: ${item.title}`;
      modalPreview.innerHTML = `<div class="neon" style="font-size:56px;">${escapeHtml(neonTextFor(item.title))}</div>`;
      showModal(pwModal);
      setTimeout(()=> pwInput.focus(), 120);
    }

    function verifyPassword(){
      if(!currentItem) return;
      const entered = (pwInput.value || '').trim();
      try{
        const expected = atob(currentItem.passB64 || '');
        if(entered === expected){
          closeModal(pwModal);
          openViewer(currentItem);
        } else {
          pwError.textContent = 'Incorrect password. Try again.';
          pwInput.select();
        }
      }catch(e){
        pwError.textContent = 'Error checking password.';
      }
    }

    pwSubmit.addEventListener('click', verifyPassword);
    pwInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') verifyPassword(); });
    pwCancel.addEventListener('click', ()=> closeModal(pwModal));
    pwClose.addEventListener('click', ()=> closeModal(pwModal));
    pwModal.addEventListener('click', (e)=> { if(e.target === pwModal) closeModal(pwModal); });

    /* ---------- YT API loader (no iframe fallback) ---------- */
    function loadYTApi(){
      if(window.YT && window.YT.Player) return Promise.resolve();
      if(window._vidu_loading_yt_promise) return window._vidu_loading_yt_promise;
      window._vidu_loading_yt_promise = new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = 'https://www.youtube.com/iframe_api';
        s.async = true;
        s.onerror = () => reject(new Error('YT API failed to load (network error)'));
        document.head.appendChild(s);
        let finished = false;
        window.onYouTubeIframeAPIReady = function(){
          if(finished) return;
          finished = true;
          resolve();
        };
        const poll = setInterval(()=> {
          if(window.YT && window.YT.Player){
            if(finished) return;
            finished = true;
            clearInterval(poll);
            resolve();
          }
        }, 200);
        setTimeout(()=> {
          if(finished) return;
          finished = true;
          clearInterval(poll);
          reject(new Error('YT API timed out'));
        }, YT_API_LOAD_TIMEOUT);
      });
      return window._vidu_loading_yt_promise;
    }

    function resetYTLoader(){
      try{ delete window._vidu_loading_yt_promise; }catch(e){}
      try{ delete window.onYouTubeIframeAPIReady; }catch(e){}
    }

    /* ---------- Player module (advanced-player only) ----------
       (unchanged from previous working implementation)
    */
    (function playerModule(){
      if(window.__viduPlayerLoaded) return;
      window.__viduPlayerLoaded = true;

      const state = {
        player: null,
        updateInterval: null,
        keyHandler: null,
        mo: null,
        host: null,
        mount: null,
        fsListener: null,
        fsResizeHandler: null,
        inactivityTimer: null,
        lastActivity: Date.now(),
        desiredPlaying: null,
        lastVolume: 100
      };

      function pad2(n){ n = Math.max(0, Math.floor(n||0)); return (n < 10 ? '0' + n : String(n)); }
      function fmtTime(s){ s = Math.max(0, Math.floor(s||0)); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60; return pad2(h) + ' : ' + pad2(m) + ' : ' + pad2(sec); }
      function playSVG(){ return `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4.5v15l12-7.5L6 4.5z" fill="#fff"/></svg>`; }
      function pauseSVG(){ return `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="4" width="4" height="16" rx="1.2" fill="#fff"/><rect x="15" y="4" width="4" height="16" rx="1.2" fill="#fff"/></svg>`; }

      function createHostElementsIn(mountRootId){
        const wrap = document.getElementById(mountRootId);
        if(!wrap) throw new Error('#' + mountRootId + ' not found');
        const prev = wrap.querySelector('.vidu-player-host');
        if(prev) prev.remove();
        const host = document.createElement('div'); host.className = 'vidu-player-host';
        const mount = document.createElement('div'); mount.className = 'vidu-mount'; mount.id = 'vidu_mount_'+Math.floor(Math.random()*1e6);
        mount.style.height = '100%'; mount.style.background = '#000';
        host.appendChild(mount);

        // Loading overlay - show header.png until playback begins
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'vidu-loading';
        loadingDiv.id = 'vidu_loading';
        host.appendChild(loadingDiv);

        const ctrlBg = document.createElement('div'); ctrlBg.className = 'vidu-controls-bg'; host.appendChild(ctrlBg);
        const overlay = document.createElement('div'); overlay.className = 'vidu-overlay';
        overlay.innerHTML = `
          <div class="inner-bg" aria-hidden="true"></div>
          <button class="vidu-btn" id="vidu_playbtn">${playSVG()}</button>
          <div class="vidu-time" id="vidu_cur">` + fmtTime(0) + `</div>
          <input id="vidu_seek" class="vidu-range" type="range" min="0" max="100" step="0.1" value="0" />
          <div class="vidu-time" id="vidu_dur">` + fmtTime(0) + `</div>
          <button class="vidu-btn" id="vidu_fullbtn">⤢</button>
        `;
        host.appendChild(overlay);

        const closeBtn = document.createElement('button');
        closeBtn.className = 'vidu-close-btn'; closeBtn.id = 'vidu_closebtn'; closeBtn.title = 'Close'; closeBtn.type = 'button'; closeBtn.innerHTML = '✕';
        closeBtn.addEventListener('click', ()=> {
          try{
            const v = document.getElementById('viewer'); if(v){ v.classList.add('hidden'); v.setAttribute('aria-hidden','true'); }
            if(window.destroyViduPlayer) window.destroyViduPlayer();
            const wrap = document.getElementById(mountRootId); if(wrap) wrap.innerHTML = '';
            document.body.style.overflow = '';
          }catch(e){ console.warn('closeBtn error', e); }
        });
        host.appendChild(closeBtn);

        wrap.appendChild(host);
        return { host, mount, overlay, ctrlBg, closeBtn, loadingDiv };
      }

      function disableIframeClicks(host){
        try{
          const ifr = host.querySelector('iframe');
          if(ifr){
            ifr.style.pointerEvents = 'none';
            ifr.setAttribute('allow','autoplay; encrypted-media; fullscreen');
            ifr.setAttribute('allowfullscreen','');
            ifr.setAttribute('tabindex','-1');
          }
        }catch(e){ console.warn('disableIframeClicks', e); }
      }

      async function createYTPlayer(videoId, mountRootId='player-wrap'){
        // ensure YT API loaded (throws if not)
        await loadYTApi();

        // create host + mount now that API is available
        const { host, mount, overlay, ctrlBg, closeBtn, loadingDiv } = createHostElementsIn(mountRootId);
        state.host = host; state.mount = mount;

        // saved styles container so we can restore when exit fullscreen
        const saved = { stored:false, host:{}, mount:{}, iframe:{} };

        const playBtn = overlay.querySelector('#vidu_playbtn');
        const curEl = overlay.querySelector('#vidu_cur');
        const durEl = overlay.querySelector('#vidu_dur');
        const seekEl = overlay.querySelector('#vidu_seek');
        const fullBtn = overlay.querySelector('#vidu_fullbtn');

        function getFullscreenElement(){
          return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
        }

        const savedResizeHandler = ()=> {
          try{
            const curFS = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
            const stillOurFS = !!(curFS && (curFS === host || host.contains(curFS) || (curFS.contains && curFS.contains(host))));
            if(stillOurFS){
              try{ host.style.width = window.innerWidth + 'px'; host.style.height = window.innerHeight + 'px'; }catch(e){}
              try{ mount.style.height = window.innerHeight + 'px'; }catch(e){}
              try{ const ifr = host.querySelector('iframe'); if(ifr) ifr.style.height = window.innerHeight + 'px'; }catch(e){}
            }
          }catch(e){}
        };

        function toggleFullscreen(){
          const fs = getFullscreenElement();
          if(fs === host){
            const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
            if(exit) exit.call(document);
          } else {
            const req = host.requestFullscreen || host.webkitRequestFullscreen || host.mozRequestFullScreen || host.msRequestFullscreen;
            if(req) req.call(host);
          }
        }
        fullBtn.addEventListener('click', toggleFullscreen);

        function setOverlayHidden(hidden){
          if(hidden){ overlay.classList.add('hidden'); ctrlBg.classList.add('hidden'); if(closeBtn) closeBtn.classList.add('hidden'); }
          else { overlay.classList.remove('hidden'); ctrlBg.classList.remove('hidden'); if(closeBtn) closeBtn.classList.remove('hidden'); }
        }

        state.keyHandler = function(e){
          const active = document.activeElement;
          if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;
          const modal = document.getElementById('viewer');
          if(!modal || modal.classList.contains('hidden')) return;
          if(e.code === 'Space' || e.key === ' '){
            e.preventDefault();
            if(state.player){
              const st = state.player.getPlayerState ? state.player.getPlayerState() : -1;
              if(st === 1) try{ state.player.pauseVideo(); }catch(e){} else try{ state.player.playVideo(); }catch(e){}
            }
          } else if(e.code === 'KeyF' || e.key === 'f' || e.key === 'F'){
            e.preventDefault();
            toggleFullscreen();
          }
        };
        document.addEventListener('keydown', state.keyHandler);

        // seek handling
        seekEl.addEventListener('pointerdown', ()=> seekEl._drag=true, {passive:true});
        seekEl.addEventListener('pointerup', ()=>{ seekEl._drag=false; if(!state.player) return; const dur = state.player.getDuration ? state.player.getDuration() : 0; if(dur) state.player.seekTo(dur * (parseFloat(seekEl.value)/100), true); }, {passive:true});
        seekEl.addEventListener('input', ()=>{ if(seekEl._drag && state.player){ const dur = state.player.getDuration ? state.player.getDuration() : 0; if(dur) curEl.textContent = fmtTime(Math.floor(dur * (parseFloat(seekEl.value)/100))); updateSeekBackground(seekEl); } }, {passive:true});

        function updateSeekBackground(el){
          try{ const v = Math.max(0, Math.min(100, parseFloat(el.value) || 0)); el.style.background = `linear-gradient(90deg, #39ff14 ${v}%, rgba(255,255,255,0.06) ${v}%)`; }catch(e){}
        }
        updateSeekBackground(seekEl);

        // play/pause UI
        playBtn.addEventListener('click', ()=> {
          if(!state.player) return;
          let st = -1;
          try{ st = state.player.getPlayerState ? state.player.getPlayerState() : -1; }catch(e){}
          const wantPlay = !(st === 1);
          state.desiredPlaying = wantPlay;
          playBtn.innerHTML = wantPlay ? pauseSVG() : playSVG();
          try{ if(wantPlay){ if(typeof state.player.playVideo === 'function') state.player.playVideo(); } else { if(typeof state.player.pauseVideo === 'function') state.player.pauseVideo(); } }catch(e){ console.warn('play/pause toggle err', e); }
          resetInactivityTimer();
        });

        function onFSChange(){
          const fs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || null;
          const isOurFullscreen = !!(fs && (fs === host || host.contains(fs) || (fs.contains && fs.contains(host))));
          if(isOurFullscreen){
            // entering fullscreen: save inline styles and adjust to viewport
            try{
              if(!saved.stored){
                saved.host.position = host.style.position || '';
                saved.host.top = host.style.top || '';
                saved.host.left = host.style.left || '';
                saved.host.width = host.style.width || '';
                saved.host.height = host.style.height || '';
                saved.host.zIndex = host.style.zIndex || '';
                saved.host.borderRadius = host.style.borderRadius || '';

                saved.mount.height = mount.style.height || '';
                saved.mount.width = mount.style.width || '';
                saved.mount.maxHeight = mount.style.maxHeight || '';
                saved.mount.maxWidth = mount.style.maxWidth || '';

                const ifr = host.querySelector('iframe');
                if(ifr){
                  saved.iframe.height = ifr.style.height || '';
                  saved.iframe.width = ifr.style.width || '';
                  saved.iframe.pointerEvents = ifr.style.pointerEvents || '';
                  saved.iframe.maxHeight = ifr.style.maxHeight || '';
                  saved.iframe.maxWidth = ifr.style.maxWidth || '';
                } else {
                  saved.iframe = {};
                }

                saved.stored = true;
              }

              host.style.position = 'fixed';
              host.style.top = '0';
              host.style.left = '0';
              host.style.width = '100vw';
              host.style.height = '100vh';
              host.style.zIndex = '2147483647';
              host.style.borderRadius = '0';

              mount.style.width = '100%';
              mount.style.height = '100%';
              mount.style.maxHeight = 'none';
              mount.style.maxWidth = 'none';

              const ifr = host.querySelector('iframe');
              if(ifr){
                ifr.style.width = '100%';
                ifr.style.height = '100%';
                ifr.style.maxHeight = 'none';
                ifr.style.maxWidth = 'none';
                ifr.style.pointerEvents = 'auto';
              }
            }catch(e){}

            ctrlBg.classList.remove('hidden');
            overlay.classList.remove('hidden');
            if(closeBtn) closeBtn.classList.remove('hidden');

            // attach resize handler while in fullscreen so host keeps viewport size
            if(!state.fsResizeHandler){
              state.fsResizeHandler = savedResizeHandler;
              window.addEventListener('resize', state.fsResizeHandler);
            }
          } else {
            // exiting fullscreen: restore saved inline styles
            try{
              if(saved.stored){
                host.style.position = saved.host.position;
                host.style.top = saved.host.top;
                host.style.left = saved.host.left;
                host.style.width = saved.host.width;
                host.style.height = saved.host.height;
                host.style.zIndex = saved.host.zIndex;
                host.style.borderRadius = saved.host.borderRadius;

                mount.style.height = saved.mount.height;
                mount.style.width = saved.mount.width;
                mount.style.maxHeight = saved.mount.maxHeight;
                mount.style.maxWidth = saved.mount.maxWidth;

                const ifr = host.querySelector('iframe');
                if(ifr){
                  ifr.style.height = saved.iframe.height;
                  ifr.style.width = saved.iframe.width;
                  ifr.style.pointerEvents = saved.iframe.pointerEvents;
                  ifr.style.maxHeight = saved.iframe.maxHeight;
                  ifr.style.maxWidth = saved.iframe.maxWidth;
                }
                saved.stored = false;
              } else {
                // fallback restore: ensure mount has sensible defaults
                try{ mount.style.height = '100%'; mount.style.width = '100%'; }catch(e){}
                try{ const ifr = host.querySelector('iframe'); if(ifr) ifr.style.pointerEvents = 'none'; }catch(e){}
              }
            }catch(e){}

            if(state.fsResizeHandler){
              window.removeEventListener('resize', state.fsResizeHandler);
              state.fsResizeHandler = null;
            }

            if(overlay.classList.contains('hidden')){
              ctrlBg.classList.add('hidden');
              if(closeBtn) closeBtn.classList.add('hidden');
            } else {
              ctrlBg.classList.remove('hidden');
              if(closeBtn) closeBtn.classList.remove('hidden');
            }
          }
        }

        state.fsListener = onFSChange;
        document.addEventListener('fullscreenchange', state.fsListener);
        document.addEventListener('webkitfullscreenchange', state.fsListener);
        document.addEventListener('mozfullscreenchange', state.fsListener);
        document.addEventListener('MSFullscreenChange', state.fsListener);

        function resetInactivityTimer(){
          state.lastActivity = Date.now();
          setOverlayHidden(false);
          if(state.inactivityTimer){ clearTimeout(state.inactivityTimer); state.inactivityTimer = null; }
          state.inactivityTimer = setTimeout(()=>{ 
            try{
              const st = state.player && typeof state.player.getPlayerState === 'function' ? state.player.getPlayerState() : -1;
              if(st === 1 || st === 3 || st === -1 || st === 0 || st === 5){
                setOverlayHidden(true);
              }
            }catch(e){}
          }, 5000);
        }

        function attachActivityListeners(){
          try{ ['mousemove','pointermove','touchstart','touchmove','keydown','mousedown'].forEach(ev=>{ host.addEventListener(ev, resetInactivityTimer, {passive:true}); document.addEventListener(ev, resetInactivityTimer, {passive:true}); }); }catch(e){}
        }
        attachActivityListeners();

        // instantiate YT.Player
        return new Promise((resolve,reject)=>{
          try{
            state.player = new YT.Player(mount.id, {
              videoId: videoId,
              width: '100%',
              height: '100%',
              playerVars: { controls: 0, disablekb: 1, rel: 0, modestbranding: 1, playsinline: 1, iv_load_policy: 3, origin: location.origin },
              events: {
                onReady: function(evt){
                  disableIframeClicks(host);

                  // ensure loading overlay visible until playback starts
                  try{ const ld = document.getElementById('vidu_loading'); if(ld){ ld.classList.remove('hidden'); ld.style.display='flex'; } }catch(e){}

                  try{
                    if(typeof evt.target.setVolume === 'function'){
                      const v = Math.max(0, Math.min(100, state.lastVolume || 100));
                      evt.target.setVolume(v);
                      if(v === 0 && typeof evt.target.mute === 'function') evt.target.mute();
                      else if(v > 0 && typeof evt.target.unMute === 'function') evt.target.unMute();
                    }
                  }catch(e){}

                  // explicitly set default (auto) so YouTube chooses the best quality
                  try{
                    if(typeof evt.target.setPlaybackQuality === 'function'){
                      evt.target.setPlaybackQuality('default');
                      setTimeout(()=> { try{ evt.target.setPlaybackQuality('default'); }catch(e){} }, 800);
                      setTimeout(()=> { try{ evt.target.setPlaybackQuality('default'); }catch(e){} }, 2200);
                    }
                  }catch(e){}

                  try{ evt.target.playVideo(); }catch(e){}

                  if(state.updateInterval) clearInterval(state.updateInterval);
                  state.updateInterval = setInterval(()=>{
                    try{
                      if(!state.player) return;
                      const dur = state.player.getDuration ? state.player.getDuration() : 0;
                      const cur = state.player.getCurrentTime ? state.player.getCurrentTime() : 0;
                      const curElLocal = document.getElementById('vidu_cur');
                      const durElLocal = document.getElementById('vidu_dur');
                      if(curElLocal) curElLocal.textContent = fmtTime(Math.floor(cur));
                      if(durElLocal) durElLocal.textContent = (dur && isFinite(dur)) ? fmtTime(Math.floor(dur)) : fmtTime(0);
                      if(!seekEl._drag && dur && isFinite(dur)) {
                        seekEl.value = (cur / Math.max(1,dur)) * 100;
                        updateSeekBackground(seekEl);
                      }
                      const st = state.player.getPlayerState ? state.player.getPlayerState() : -1;
                      if(state.desiredPlaying !== null){
                        if(state.desiredPlaying && st !== 1) try{ state.player.playVideo(); }catch(e){}
                        else if(!state.desiredPlaying && st === 1) try{ state.player.pauseVideo(); }catch(e){}
                      }
                      const currentIcon = (st === 1) ? pauseSVG() : playSVG();
                      if(Date.now() - state.lastActivity > 300) playBtn.innerHTML = currentIcon;
                      else setTimeout(()=> { try{ const check = state.player.getPlayerState ? state.player.getPlayerState() : -1; if(check === 1) playBtn.innerHTML = pauseSVG(); else playBtn.innerHTML = playSVG(); }catch(e){} }, 600);
                    }catch(e){}
                  }, 160);

                  if(state.mo) state.mo.disconnect();
                  state.mo = new MutationObserver(()=> disableIframeClicks(host));
                  state.mo.observe(host, { childList:true, subtree:true });

                  resetInactivityTimer();
                  resolve(state.player);
                },
                onStateChange: function(e){
                  // hide loading overlay when state becomes PLAYING (1)
                  try{
                    if(e && e.data === 1){
                      try{ const ld = document.getElementById('vidu_loading'); if(ld){ ld.classList.add('hidden'); ld.style.display='none'; } }catch(err){}
                    }
                  }catch(err){}
                },
                onError: function(err){ console.error('YT player error', err); try{ const ld = document.getElementById('vidu_loading'); if(ld){ ld.classList.add('hidden'); ld.style.display='none'; } }catch(_){} reject(err); }
              }
            });
          }catch(err){ reject(err || new Error('YT player creation failed')); }
        });
      }

      function destroyPlayer(){
        try{
          if(state.updateInterval){ clearInterval(state.updateInterval); state.updateInterval = null; }
          if(state.keyHandler){ document.removeEventListener('keydown', state.keyHandler); state.keyHandler = null; }
          if(state.player){ try{ state.player.destroy(); }catch(e){} state.player = null; }
          if(state.mo){ try{ state.mo.disconnect(); }catch(e){} state.mo = null; }
          if(state.fsResizeHandler){ window.removeEventListener('resize', state.fsResizeHandler); state.fsResizeHandler = null; }
          if(state.fsListener){ document.removeEventListener('fullscreenchange', state.fsListener); document.removeEventListener('webkitfullscreenchange', state.fsListener); document.removeEventListener('mozfullscreenchange', state.fsListener); document.removeEventListener('MSFullscreenChange', state.fsListener); state.fsListener = null; }
          if(state.inactivityTimer){ clearTimeout(state.inactivityTimer); state.inactivityTimer = null; }
          if(state.host){
            try{ ['mousemove','pointermove','touchstart','touchmove','keydown','mousedown'].forEach(ev=>{ state.host.removeEventListener(ev, resetInactivityTimer); document.removeEventListener(ev, resetInactivityTimer); }); }catch(e){}
          }
          if(state.host){ try{ state.host.remove(); }catch(e){} state.host = null; state.mount = null; }
        }catch(e){ console.warn('destroyPlayer err', e); }
      }

      // expose
      window.showViduPlayer = async function(videoId, mountRootId='player-wrap'){
        return createYTPlayer(videoId, mountRootId);
      };
      window.destroyViduPlayer = function(){ destroyPlayer(); const w = document.getElementById('player-wrap'); if(w) w.innerHTML = ''; };

      window.addEventListener('beforeunload', ()=> { try{ window.destroyViduPlayer(); }catch(e){} }, {passive:true});

      // helper used in destroyPlayer closure
      function resetInactivityTimer(){ /* placeholder for removeEventListener binding */ }
    })(); // end playerModule

    /* ---------- Playlist fetcher (YouTube Data API) ---------- */
    async function fetchPlaylistVideos(playlistId){
      if(!YT_API_KEY || YT_API_KEY === 'YOUR_API_KEY_HERE') throw new Error('No API key configured.');
      const results = []; let pageToken = '';
      do {
        const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${encodeURIComponent(playlistId)}&key=${encodeURIComponent(YT_API_KEY)}` + (pageToken?`&pageToken=${pageToken}`:'');
        const res = await fetch(url);
        if(!res.ok){ const txt = await res.text().catch(()=>null); throw new Error('YouTube API error: '+res.status+' '+res.statusText+' '+(txt||'')); }
        const data = await res.json();
        (data.items||[]).forEach(it => {
          const sn = it.snippet || {};
          if(sn.resourceId && sn.resourceId.videoId){
            const thumb = (sn.thumbnails && (sn.thumbnails.high||sn.thumbnails.medium||sn.thumbnails.default))||{};
            results.push({ videoId: sn.resourceId.videoId, title: sn.title||'Untitled', thumb: thumb.url||`https://img.youtube.com/vi/${sn.resourceId.videoId}/hqdefault.jpg` });
          }
        });
        pageToken = data.nextPageToken || '';
      } while(pageToken);
      return results;
    }

    /* ---------- show playlist (advanced only) ---------- */
    async function showPlaylistInsideViewer(item){
      const rawId = normalizeIdFromB64(item.idB64);
      const playlistId = rawId.split('&')[0];
      const iframeWrap = document.getElementById('iframe-wrap');
      iframeWrap.innerHTML = '';

      // ensure playlist area is visible and set split sizes
      const playlistContainer = document.getElementById('viewer-playlist');
      playlistContainer.style.display = '';
      // set explicit flex split: player top 62%, playlist bottom 38%
      iframeWrap.style.flex = '0 0 62%';
      playlistContainer.style.flex = '0 0 38%';
      playlistContainer.innerHTML = '';
      playlistContainer.scrollTop = 0;

      // create mount inside the iframe-wrap for the advanced player
      const mountRoot = document.createElement('div'); mountRoot.id = 'player-wrap'; mountRoot.style.width='100%'; mountRoot.style.height='100%';
      iframeWrap.appendChild(mountRoot);

      // update now playing title (temporary while loading)
      const nowPlayingEl = document.getElementById('now-playing-title');
      if(nowPlayingEl) nowPlayingEl.textContent = item.title || 'Playlist';

      try{
        const videos = await fetchPlaylistVideos(playlistId);
        if(!videos.length) throw new Error('No videos found or playlist is private.');

        // populate playlistContainer (below player)
        videos.forEach(v=>{
          const li = document.createElement('div');
          li.className = 'list-item';
          li.setAttribute('role','button');
          li.tabIndex = 0;
          li.innerHTML = `<img src="${escapeHtml(v.thumb)}" alt="${escapeHtml(v.title)}" /><div class="playlist-meta"><div class="playlist-title">${escapeHtml(v.title)}</div><div class="playlist-sub">Click to play</div></div>`;
          function playThis(){
            // update now playing title
            const np = document.getElementById('now-playing-title');
            if(np) np.textContent = v.title || 'Now playing';
            if(window.showViduPlayer){
              try{ window.destroyViduPlayer(); }catch(e){}
              mountRoot.innerHTML = `<div style="padding:18px;color:#ddd;">Loading advanced player...</div>`;
              window.showViduPlayer(v.videoId, 'player-wrap').catch(err=>{
                mountRoot.innerHTML = '';
                const errBlock = document.createElement('div');
                errBlock.style.padding = '18px'; errBlock.style.color = '#ffdede';
                errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
                const retryBtn = document.createElement('button');
                retryBtn.className = 'btn'; retryBtn.textContent = 'Retry Advanced Player';
                retryBtn.addEventListener('click', ()=> {
                  resetYTLoader();
                  mountRoot.innerHTML = `<div style="padding:18px;color:#ddd;">Retrying advanced player...</div>`;
                  window.showViduPlayer(v.videoId, 'player-wrap').catch(e2=>{
                    mountRoot.innerHTML = '';
                    errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(e2 && e2.message ? e2.message : String(e2))}</div>`;
                    mountRoot.appendChild(errBlock); mountRoot.appendChild(retryBtn);
                  });
                });
                mountRoot.appendChild(errBlock); mountRoot.appendChild(retryBtn);
              });
            }
          }
          li.addEventListener('click', playThis);
          li.addEventListener('keydown', (e)=> { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); playThis(); } });
          playlistContainer.appendChild(li);
        });

        // autoplay first video using advanced player
        const first = videos[0];
        if(first && window.showViduPlayer){
          // update now playing title to first video
          const np = document.getElementById('now-playing-title');
          if(np) np.textContent = first.title || 'Now playing';
          try{
            await window.showViduPlayer(first.videoId, 'player-wrap');
          }catch(err){
            mountRoot.innerHTML = '';
            const errBlock = document.createElement('div');
            errBlock.style.padding = '18px'; errBlock.style.color = '#ffdede';
            errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn'; retryBtn.textContent = 'Retry Advanced Player';
            retryBtn.addEventListener('click', ()=> {
              resetYTLoader();
              mountRoot.innerHTML = `<div style="padding:18px;color:#ddd;">Retrying advanced player...</div>`;
              window.showViduPlayer(first.videoId, 'player-wrap').catch(e2=>{
                mountRoot.innerHTML = '';
                errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(e2 && e2.message ? e2.message : String(e2))}</div>`;
                mountRoot.appendChild(errBlock); mountRoot.appendChild(retryBtn);
              });
            });
            mountRoot.appendChild(errBlock); mountRoot.appendChild(retryBtn);
          }
        }
      }catch(err){
        // show error and retry button in playlist area (no iframe fallback)
        playlistContainer.innerHTML = '';
        const errBlock = document.createElement('div');
        errBlock.style.padding = '18px'; errBlock.style.color = '#ffdede';
        errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load playlist</div><div style="margin-bottom:10px;">${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn'; retryBtn.textContent = 'Retry Advanced Player';
        retryBtn.addEventListener('click', ()=> {
          resetYTLoader();
          playlistContainer.innerHTML = `<div style="padding:18px;color:#ddd;">Retrying advanced player...</div>`;
          fetchPlaylistVideos(playlistId).then(videos=>{
            if(!videos || !videos.length) throw new Error('No videos found on retry');
            window.showViduPlayer(videos[0].videoId, 'player-wrap').catch(e2=>{
              playlistContainer.innerHTML = '';
              errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(e2 && e2.message ? e2.message : String(e2))}</div>`;
              playlistContainer.appendChild(errBlock); playlistContainer.appendChild(retryBtn);
            });
          }).catch(e3=>{
            playlistContainer.innerHTML = '';
            errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load playlist</div><div style="margin-bottom:10px;">${escapeHtml(e3 && e3.message ? e3.message : String(e3))}</div>`;
            playlistContainer.appendChild(errBlock); playlistContainer.appendChild(retryBtn);
          });
        });
        playlistContainer.appendChild(errBlock); playlistContainer.appendChild(retryBtn);
      }
    }

    /* ---------- show single video (advanced only) ---------- */
    async function showVideoInViewer(item){
      const vid = normalizeIdFromB64(item.idB64);
      if(!vid){ alert('Unable to load the selected item.'); return; }
      const iframeWrap = document.getElementById('iframe-wrap');
      iframeWrap.innerHTML = '';

      // hide playlist area and let the iframe-wrap expand
      const playlistContainer = document.getElementById('viewer-playlist');
      playlistContainer.innerHTML = '';
      playlistContainer.style.display = 'none';
      // allow iframe-wrap to grow and occupy remaining area
      iframeWrap.style.flex = '1 1 100%';

      const mountRoot = document.createElement('div'); mountRoot.id = 'player-wrap'; mountRoot.style.width='100%'; mountRoot.style.height='100%';
      iframeWrap.appendChild(mountRoot);

      // set now playing title
      const np = document.getElementById('now-playing-title');
      if(np) np.textContent = item.title || 'Now playing';

      // attempt advanced player - if fails, show clear error and a retry button in the playlist area
      try{
        await window.showViduPlayer(vid, 'player-wrap');
      }catch(err){
        mountRoot.innerHTML = '';
        // restore playlist container so user can see error + retry
        playlistContainer.style.display = '';
        // set back default split
        iframeWrap.style.flex = '0 0 62%';
        playlistContainer.style.flex = '0 0 38%';
        playlistContainer.innerHTML = '';
        const errBlock = document.createElement('div');
        errBlock.style.padding = '18px'; errBlock.style.color = '#ffdede';
        errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn'; retryBtn.textContent = 'Retry Advanced Player';
        retryBtn.addEventListener('click', ()=> {
          resetYTLoader();
          mountRoot.innerHTML = `<div style="padding:18px;color:#ddd;">Retrying advanced player...</div>`;
          window.showViduPlayer(vid, 'player-wrap').catch(e2=>{
            mountRoot.innerHTML = '';
            errBlock.innerHTML = `<div style="font-weight:800;margin-bottom:10px;">Failed to load advanced player</div><div style="margin-bottom:10px;">${escapeHtml(e2 && e2.message ? e2.message : String(e2))}</div>`;
            playlistContainer.appendChild(errBlock); playlistContainer.appendChild(retryBtn);
          });
        });
        playlistContainer.appendChild(errBlock); playlistContainer.appendChild(retryBtn);
      }
    }

    /* ---------- viewer open/close wiring ---------- */
    const viewer = document.getElementById('viewer');
    const viewerClose = document.getElementById('viewer-close');

    function openViewer(item){
      // ensure default playlist area visible (will be hidden by showVideoInViewer if needed)
      const iframeWrap = document.getElementById('iframe-wrap');
      const playlistContainer = document.getElementById('viewer-playlist');
      playlistContainer.style.display = '';
      iframeWrap.style.flex = '0 0 62%';
      playlistContainer.style.flex = '0 0 38%';
      playlistContainer.innerHTML = '';

      viewer.classList.remove('hidden'); viewer.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
      if(item.type === 'video') showVideoInViewer(item); else showPlaylistInsideViewer(item);
    }
    function closeViewer(){
      if(window.destroyViduPlayer) try{ window.destroyViduPlayer(); }catch(e){}
      const iframeWrap = document.getElementById('iframe-wrap'); if(iframeWrap) iframeWrap.innerHTML = '';
      const playlistContainer = document.getElementById('viewer-playlist'); if(playlistContainer){ playlistContainer.innerHTML = ''; playlistContainer.style.display = ''; playlistContainer.style.flex = '0 0 38%'; }
      // reset iframe split default
      const iframeWrapEl = document.getElementById('iframe-wrap');
      if(iframeWrapEl) iframeWrapEl.style.flex = '0 0 62%';
      // clear now playing title
      const np = document.getElementById('now-playing-title'); if(np) np.textContent = '—';
      viewer.classList.add('hidden'); viewer.setAttribute('aria-hidden','true'); document.body.style.overflow='';
    }
    viewerClose.addEventListener('click', closeViewer);
    viewer.addEventListener('click', (e)=> { if(e.target === viewer){ closeViewer(); } });
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ if(!pwModal.classList.contains('hidden')) closeModal(pwModal); if(!viewer.classList.contains('hidden')) closeViewer(); } });

    /* ---------- small page interactions ---------- */
    document.getElementById('nav-private').addEventListener('click', ()=> location.reload());

    /* ---------- init ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      try{ buildTiles(); }catch(err){ console.error('buildTiles error', err); document.getElementById('js-fail-note').style.display='block'; }
      setTimeout(()=>{ const t = document.getElementById('tiles'); if(!t || !t.children || t.children.length===0) document.getElementById('js-fail-note').style.display='block'; }, 1200);
    });

    // expose reset helper for retry logic (used above)
    window.resetYTLoader = resetYTLoader;
  })();
  </script>
</body>
</html>
