<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Archive — VIDU</title>

  <link href="https://api.fontshare.com/v2/css?f[]=clash-display@700&f[]=satoshi@700,500&display=swap" rel="stylesheet">

  <style>
    /* ===== NEW: Complete Style Overhaul for a Modern, Premium Feel ===== */

    /* ---- 1. Root Variables & Base Setup ---- */
    :root {
      --bg-color: #0c0a10;
      --text-primary: #e6e6fa;
      --text-secondary: rgba(230, 230, 250, 0.6);
      --accent-primary: #00ff8a;
      --accent-secondary: #9e5fff;
      --card-bg: rgba(20, 18, 28, 0.5);
      --border-color: rgba(255, 255, 255, 0.07);
      --font-heading: 'Clash Display', sans-serif;
      --font-body: 'Satoshi', sans-serif;
    }

    *{box-sizing:border-box}

    html,body{height:100%;margin:0;font-family: var(--font-body); -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

    body{
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height:1.5;
      overflow-x: hidden;
    }

    /* ---- 2. Dynamic Aurora Background ---- */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background:
        radial-gradient(circle at 15% 25%, rgba(0, 255, 138, 0.15), transparent 30%),
        radial-gradient(circle at 85% 75%, rgba(158, 95, 255, 0.15), transparent 30%);
      z-index: -1;
      animation: background-pan 30s linear infinite;
    }
    @keyframes background-pan {
      0% { transform: translate(0%, 0%) rotate(0deg); }
      25% { transform: translate(5%, -10%) rotate(10deg); }
      50% { transform: translate(0%, 0%) rotate(0deg); }
      75% { transform: translate(-5%, 10%) rotate(-10deg); }
      100% { transform: translate(0%, 0%) rotate(0deg); }
    }
    
    /* ---- 3. Custom Scrollbar ---- */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

    /* ---- 4. Redesigned Top Bar ---- */
    .topbar{
      position:fixed;
      left:0;right:0;top:0;
      z-index:120;
      background:rgba(12, 10, 16, 0.5);
      backdrop-filter:blur(12px);
      border-bottom:1px solid var(--border-color);
    }
    .topbar-inner{max-width:1400px;margin:0 auto;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;}
    
    .left{display:flex;align-items:center;gap:24px}
    .logo-btn{display:inline-flex;align-items:center;justify-content:center;text-decoration:none; transition: transform 0.2s ease;}
    .logo-btn:hover { transform: scale(1.05) rotate(-5deg); }

    .nav{display:flex;gap:8px;align-items:center}
    .nav a,.nav button{
      color:var(--text-secondary);
      text-decoration:none;padding:8px 14px;
      font-weight:700;border-radius:8px;font-size:15px;
      background:transparent;border:0;cursor:pointer;
      transition: all .2s ease;
    }
    .nav a:hover,.nav button:hover{ color: var(--text-primary); background: var(--border-color); transform: translateY(-2px); }

    /* ---- 5. Page Layout & Hero Section ---- */
    .page{margin-top:80px;min-height:calc(100vh - 80px)}
    .container{max-width:1400px;margin:0 auto;padding:48px 24px}
    .hero { text-align: center; margin-bottom: 64px; }
    .title{
      font-family: var(--font-heading);
      font-size:clamp(3rem, 10vw, 6rem); /* Responsive font size */
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      letter-spacing: -2px;
    }
    .subtitle{color: var(--text-secondary); font-size:18px; margin-top: 16px; max-width: 600px; margin-left: auto; margin-right: auto;}

    /* ---- 6. Modern Card Grid & Design ---- */
    .tiles{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
      gap:32px;
    }
    
    .card{
      position: relative;
      display:flex;flex-direction:column;
      background:var(--card-bg);
      border-radius:16px;
      border:1px solid var(--border-color);
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
      min-height:350px;
      overflow: hidden;
    }
    /* Card Hover Glow Effect */
    .card::before {
      content: "";
      position: absolute;
      left: 0; top: 0;
      width: 100%; height: 100%;
      border-radius: 16px;
      background: radial-gradient(
        400px circle at var(--mouse-x) var(--mouse-y),
        rgba(0, 255, 138, 0.2),
        transparent 40%
      );
      z-index: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card:hover::before { opacity: 1; }
    .card:hover{transform:translateY(-8px); border-color: rgba(255, 255, 255, 0.15);}
    
    .card-media{position:relative;height:250px;display:flex;align-items:center;justify-content:center; border-bottom:1px solid var(--border-color); overflow:hidden;}
    .neon-wrap{ text-align:center; position: relative; z-index: 1; pointer-events: none;}
    .neon{
      font-family: var(--font-heading);
      letter-spacing: 2px;
      color: var(--accent-primary);
      text-shadow:0 0 8px var(--accent-primary), 0 0 24px rgba(0, 255, 138, 0.4);
      line-height:1;
      user-select:none;
      white-space:nowrap;
      font-size: 56px !important;
    }
    .neon-reflect{
      position:relative;
      transform:scaleY(-1);
      opacity:0.1;
      filter:blur(5px);
      font-family: var(--font-heading);
      letter-spacing: 2px;
      color: var(--accent-primary);
      pointer-events:none;
      white-space:nowrap;
      font-size: 56px !important;
      margin-top:12px;
    }

    .card-caption{padding:20px;display:flex;flex-direction:column;gap:10px; position: relative; z-index: 1;}
    .card-title{font-weight:700;color:var(--text-primary);font-size:18px;}
    .card-type{
      font-size:12px;
      color: var(--accent-primary);
      background: rgba(0, 255, 138, 0.1);
      border: 1px solid rgba(0, 255, 138, 0.2);
      font-weight:700;
      text-transform:uppercase;
      padding: 4px 10px;
      border-radius: 99px;
      align-self: flex-start;
    }

    /* ---- 7. Restyled Modals & Buttons ---- */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:300;padding:18px}
    .modal.hidden{display:none}
    .modal-box{
      max-width:460px;
      width:100%;
      background:rgba(18, 16, 24, 0.6);
      backdrop-filter: blur(16px);
      border-radius:16px;
      padding:32px;
      border: 1px solid var(--border-color);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      color:var(--text-primary);
      text-align:center;position:relative
    }
    .modal-close{position:absolute;right:16px;top:16px;background:transparent;border:none;color:var(--text-secondary);font-size:18px;cursor:pointer; transition: color 0.2s ease;}
    .modal-close:hover { color: var(--text-primary); }

    .login-input{
      width:100%;padding:14px 16px;border-radius:8px;
      border:1px solid var(--border-color);
      background:rgba(0,0,0,0.2);
      color:var(--text-primary);margin-top:12px;font-size:16px;
      transition: all 0.2s ease;
    }
    .login-input:focus { border-color: var(--accent-primary); box-shadow: 0 0 8px rgba(0, 255, 138, 0.3); outline: none; }
    
    .pw-actions, .login-actions{display:flex;gap:12px;margin-top:24px;justify-content:center}
    
    .btn{
      padding:12px 24px;border-radius:8px;border:none;font-weight:700;
      cursor:pointer;
      background: linear-gradient(90deg, var(--accent-primary), #00d474);
      color:#0c0a10;font-size:16px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(0, 255, 138, 0.2);
    }
    .btn:hover{transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(0, 255, 138, 0.3);}
    .btn:disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }

    .login-btn-top{
        background: linear-gradient(90deg, var(--accent-primary), #00d474);
        color: #0c0a10;
        font-weight: 700;
        font-size: 15px;
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all .2s ease;
    }
    .login-btn-top:hover{ transform: translateY(-2px) scale(1.02); }
    .login-btn-top:disabled {
        background: var(--border-color);
        color: var(--text-secondary);
        cursor: not-allowed; transform: none;
    }

    .copyright{text-align:center;margin-top:64px;color:var(--text-secondary);font-size:14px}

    /* ===== Unchanged player, playlist, and utility styles below this line ===== */
    /* These styles are required for the player JavaScript to function correctly. */
    .viewer{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.78);z-index:400;padding:22px}
    .viewer.hidden{display:none}
    .viewer-inner{width:100%;max-width:1100px;height:72vh;border-radius:12px;overflow:hidden;background:rgba(2,2,2,0.75);position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.8);display:flex;flex-direction:column}
    .viewer-close{position:absolute;top:10px;right:10px;background:transparent;border:none;color:#ddd;font-size:20px;cursor:pointer;z-index:5}
    .now-playing {width:100%;padding:10px 16px;box-sizing:border-box;background:linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.45));color:#e8f7e8;font-weight:900;letter-spacing:0.6px;font-size:15px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.03);z-index:8;}
    .now-playing .label { color:rgba(200,255,190,0.85); font-weight:800; font-size:13px; opacity:0.95; text-transform:uppercase; }
    .now-playing .title { color:#fff; font-size:15px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .iframe-wrap{width:100%;height:100%;display:block;background:#000;position:relative;border-bottom:1px solid rgba(255,255,255,0.03)}
    .vidu-player-host{position:relative;width:100%;height:100%;overflow:hidden;border-radius:8px;background:#000}
    .vidu-mount{width:100%;height:100%;background:#000}
    .vidu-mount iframe{width:100%;height:100%;border:0;display:block}
    .vidu-loading{position:absolute;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;background-image: url('assets/images/header.png');background-repeat:no-repeat;background-position:center;background-size:cover;transition:opacity .28s ease;pointer-events:none}
    .vidu-loading.hidden{opacity:0;transform:scale(1.02);pointer-events:none;display:none}
    .vidu-controls-bg{position:absolute;left:0;right:0;bottom:0;height:64px;background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));pointer-events:none;z-index:9996;opacity:1;transition:opacity .22s ease, transform .22s ease;backdrop-filter:blur(4px)}
    .vidu-controls-bg.hidden{opacity:0;transform:translateY(6px)}
    .vidu-overlay{position:absolute;left:12px;right:12px;bottom:12px;z-index:9999;display:flex;gap:12px;align-items:center;padding:8px 12px;border-radius:10px;box-sizing:border-box;pointer-events:auto}
    .vidu-overlay.hidden{opacity:0;transform:translateY(6px);pointer-events:none}
    .vidu-overlay .inner-bg{position:absolute;inset:0;border-radius:10px;pointer-events:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));z-index:-1}
    .vidu-btn{background:rgba(255,255,255,0.06);color:#fff;padding:8px;border-radius:22px;cursor:pointer;font-weight:700;user-select:none;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;width:46px;height:46px;transition:transform .12s ease}
    .vidu-btn:active{transform:scale(.96)}
    .vidu-range{flex:1;-webkit-appearance:none;height:8px;border-radius:8px;background:rgba(255,255,255,0.06)}
    .vidu-range::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#39ff14;box-shadow:0 2px 8px rgba(0,0,0,0.5);border:2px solid rgba(0,0,0,0.18);margin-top:-4px}
    .vidu-range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#39ff14;border:2px solid rgba(0,0,0,0.18)}
    .vidu-time{min-width:90px;font-size:14px;font-weight:800;color:#cbd5ff;text-align:center;letter-spacing:1px}
    .vidu-close-btn{position:absolute;top:10px;right:10px;z-index:10002;width:36px;height:36px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.46);border:1px solid rgba(255,255,255,0.06);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.6);transition:opacity .18s ease,transform .18s ease}
    .vidu-close-btn.hidden{opacity:0;transform:translateY(-6px);pointer-events:none}
    .playlist-popup { position: fixed; inset: 12px; z-index: 600; display: none; align-items: center; justify-content: center; pointer-events: auto; }
    .playlist-popup.visible { display:flex; }
    .playlist-popup-inner { width: 100%; height: 100%; background: linear-gradient(180deg, rgba(18, 16, 24, 0.95), rgba(12, 10, 16, 0.98)); backdrop-filter: blur(16px); border-radius: 14px; box-shadow: 0 40px 120px rgba(0,0,0,0.8); padding: 18px; box-sizing: border-box; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
    .playlist-popup-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .playlist-popup-count { font-weight:700; color:var(--text-primary); background: var(--border-color); padding:8px 14px; border-radius: 8px; font-size: 14px; }
    .playlist-popup-title { font-size:18px; font-weight:700; color:#fff; flex:1; text-align:left; margin-left:16px; }
    .playlist-popup-close { border:0; background:transparent; color:var(--text-secondary); font-weight:800; font-size:20px; cursor:pointer; }
    .playlist-popup-body { overflow:auto; border-radius:10px; padding:8px; background: rgba(0,0,0,0.2); flex:1; }
    .playlist-item { display:flex; gap:16px; align-items:center; padding:12px; border-radius:10px; transition: background .12s, transform .08s; cursor:pointer; margin-bottom:8px; background:transparent; }
    .playlist-item:hover { background: var(--border-color); transform: translateX(4px); }
    .playlist-item-num-thumb { width: 140px; height: 78px; flex: 0 0 140px; border-radius: 8px; background: #000; display: flex; align-items: center; justify-content: center; font-size: 42px; font-weight: 900; color: var(--accent-primary); text-shadow: 0 0 6px var(--accent-primary), 0 0 18px rgba(0,255,138,0.45); user-select: none; border: 1px solid var(--border-color); }
    .playlist-item .meta { display:flex; flex-direction:column; gap:6px; }
    .playlist-item .meta .t { font-weight:700; color:#fff; font-size:15px; }
    .playlist-item .meta .s { color: var(--text-secondary); font-size:13px; }
    .playlist-loading-indicator { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 18px; user-select: none; text-align: center; }
    .playlist-loading-indicator .spinner { width: 48px; height: 48px; border: 5px solid rgba(255, 255, 255, 0.12); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .playlist-loading-indicator .loading-text { font-size: 18px; font-weight: 700; color: var(--text-secondary); }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="left">
        <a class="logo-btn" href="index.html" title="Home" aria-label="Home">
          <svg width="42" height="42" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 11.4142L12 3.41421L20 11.4142V20C20 20.2652 19.8946 20.5196 19.7071 20.7071C19.5196 20.8946 19.2652 21 19 21H5C4.73478 21 4.48043 20.8946 4.29289 20.7071C4.10536 20.5196 4 20.2652 4 20V11.4142Z" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 21V12H15V21" stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <nav class="nav" aria-label="Main navigation">
          <a href="index.html">🏠 Home</a>
          <a href="about.html">ℹ️ About</a>
        </nav>
      </div>
      <button id="login-btn-top" class="login-btn-top">🔑 Login</button>
    </div>
  </header>

  <main class="page" role="main">
    <div class="container">
      <section class="hero">
        <h1 class="title">The Archive</h1>
        <p class="subtitle">Exclusive access to private classes and curated playlists. Log in to view your permitted content.</p>
      </section>

      <section id="tiles" class="tiles" aria-live="polite"></section>
      <div class="copyright">© VIDU. All rights reserved.</div>
    </div>
  </main>

  <div id="login-modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-box" role="document">
      <button class="modal-close" id="login-close" aria-label="Close">✕</button>
      <h3 style="font-weight:700; margin-bottom:16px; font-size: 24px;">🗝️ Secure Login</h3>
      <input id="login-username" class="login-input" type="text" placeholder="Username" autocomplete="username" />
      <input id="login-password" class="login-input" type="password" placeholder="Password" autocomplete="current-password" />
      <div class="login-actions">
        <button id="login-submit" class="btn">Login</button>
      </div>
      <p id="login-error" style="color:#ff8080;margin-top:16px;min-height:18px;"></p>
    </div>
  </div>

  <div id="access-modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-box" role="document">
        <button class="modal-close" id="access-close" aria-label="Close">✕</button>
        <p style="font-size: 22px; font-weight: 700; margin: 20px 0;">🔒 Login Required</p>
        <div class="pw-actions">
            <button id="access-request-btn" class="btn">Request Access</button>
        </div>
    </div>
  </div>

  <div id="no-access-modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-box" role="document">
      <button class="modal-close" id="no-access-close" aria-label="Close">✕</button>
      <p style="font-size: 22px; font-weight: 700; margin: 20px 0;">🔒 Access Denied</p>
      <p style="color: var(--text-secondary); margin-top: -10px; margin-bottom: 24px;">You don't have permission for this content.</p>
      <div class="pw-actions">
          <button id="no-access-request-btn" class="btn">Request Access</button>
      </div>
    </div>
  </div>

  <div id="viewer" class="viewer hidden" aria-hidden="true"><div class="viewer-inner"><button id="viewer-close" class="viewer-close" aria-label="Close viewer">✕</button><div class="now-playing" aria-hidden="false"><div class="label">Now playing</div><div class="title" id="now-playing-title">—</div></div><div id="iframe-wrap" class="iframe-wrap"></div></div></div>
  <div id="playlist-popup" class="playlist-popup" aria-hidden="true"><div class="playlist-popup-inner" role="dialog" aria-modal="true" aria-label="Playlist"><div class="playlist-popup-header"><div class="playlist-popup-count" id="playlist-count">0 Videos</div><div class="playlist-popup-title" id="playlist-popup-title">Playlist</div><button class="playlist-popup-close" id="playlist-popup-close" aria-label="Close playlist">✕</button></div><div class="playlist-popup-body" id="playlist-popup-body" tabindex="0"></div></div></div>
  <div id="js-fail-note" style="display:none;position:fixed;right:14px;bottom:14px;background:rgba(255,80,80,0.12);color:#ffdede;border:1px solid rgba(255,80,80,0.2);padding:8px 12px;border-radius:8px;font-size:13px;z-index:9999">Some features may be unavailable — enable JavaScript.</div>

  <script>
  // ===== NO CHANGES TO JAVASCRIPT LOGIC =====
  // The functionality is the same as the previous version. All changes are purely stylistic.
  (function(){
    /* ---------- configuration ---------- */
    const YT_API_KEY = 'AIzaSyB8UVKOZOnUnYdqbFGOtlg6BPfR9HpD35c';
    const userPermissions = {
      'vidu': { password: 'vidu123', access: ['PHONK', 'TEST', 'ICT', 'ET Speed Revision', 'ET Theory'] },
      'Imal': { password: '123', access: ['ET Speed Revision', 'ET Theory'] },
      'user': { password: 'password', access: ['PHONK', 'TEST'] }
    };
    let currentUser = null;
    let globalLastVolume = 100;

    const items = [
      { type: 'video', title: 'PHONK', idB64: btoa("m0fM0rBN7cQ"), passB64: btoa("")},
      { type: 'video', title: 'TEST', idB64: btoa("Lexok6H2c2s"), passB64: btoa("")},
      { type: 'playlist', title: 'ICT', idB64: btoa("PL9zX0VbNmKiFlxda5PCTn4_hA_7iKjEaA&si=9nF_7qpAzKt4cYZd"), passB64: btoa("6002vidu") },
      { type: 'playlist', title: 'ET Speed Revision', idB64: btoa("PL9zX0VbNmKiF-Q7bnmM1v_DrT3_Ol-Of5&si=efJHPzWR-kZcGwYw"), passB64: btoa("amilaet") },
      { type: 'playlist', title: 'ET Theory', idB64: btoa("PL9zX0VbNmKiFKQ388JcZsq18mlyIe7BeI&si=cn4rwat6rsqC8kH_"), passB64: btoa("amilaet") }
    ];

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function neonTextFor(title){
      if(!title) return '';
      const main = (title||'').split(/[\u2013\u2014\-+]/)[0].trim();
      const words = main.split(/\s+/);
      if(words.length === 1) return words[0].toUpperCase().slice(0, 6);
      return words[0].toUpperCase();
    }
    function normalizeIdFromB64(idB64){
      try { return atob(idB64 || '').split('&')[0]; } catch(e){ console.warn('Invalid idB64', idB64, e); return ''; }
    }

    function buildTiles(){
      const tiles = document.getElementById('tiles');
      tiles.innerHTML = '';
      items.forEach((it, idx)=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-idx', idx);
        card.setAttribute('aria-label', it.title + ' ' + it.type);
        const neon = neonTextFor(it.title);
        card.innerHTML = `
          <div class="card-media">
            <div class="neon-wrap">
              <div class="neon">${escapeHtml(neon)}</div>
              <div class="neon-reflect" aria-hidden="true">${escapeHtml(neon)}</div>
            </div>
          </div>
          <div class="card-caption">
            <div class="card-title">${escapeHtml(it.title)}</div>
            <div class="card-type">${escapeHtml(it.type)}</div>
          </div>`;
        card.addEventListener('click', ()=> handleTileClick(it));
        // JS for card hover glow effect
        card.addEventListener('mousemove', e => {
          const rect = card.getBoundingClientRect();
          card.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
          card.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
        });
        tiles.appendChild(card);
      });
    }

    function showModal(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    
    let lastOpenedPlaylistItem = null;
    const playlistCache = {};
    const playlistPopup = document.getElementById('playlist-popup');
    const playlistBody = document.getElementById('playlist-popup-body');
    const playlistCountEl = document.getElementById('playlist-count');
    const playlistTitleEl = document.getElementById('playlist-popup-title');
    const playlistCloseBtn = document.getElementById('playlist-popup-close');
    
    function renderPlaylistBody(videos) {
      playlistBody.innerHTML = '';
      playlistCountEl.textContent = `${videos.length} Videos`;
      if (!videos.length) { playlistBody.innerHTML = `<div style="padding:18px;color:#ffdede">No videos found.</div>`; return; }
      videos.forEach((v, index) => {
        const node = document.createElement('div');
        node.className = 'playlist-item';
        node.innerHTML = `<div class="playlist-item-num-thumb">${index + 1}</div><div class="meta"><div class="t">${escapeHtml(v.title)}</div><div class="s">Click to play</div></div>`;
        node.tabIndex = 0;
        function clickHandler() {
          closePlaylistPopup();
          openViewer({ type: 'video', title: v.title, idB64: btoa(v.videoId) });
        }
        node.addEventListener('click', clickHandler);
        node.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); clickHandler(); } });
        playlistBody.appendChild(node);
      });
      playlistBody.scrollTop = 0;
    }
    
    async function openPlaylistPopup(item) {
      playlistTitleEl.textContent = item.title || 'Playlist';
      lastOpenedPlaylistItem = item;
      const playlistId = normalizeIdFromB64(item.idB64 || '');
      playlistPopup.classList.add('visible');
      playlistPopup.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      if (playlistCache[playlistId]) {
        renderPlaylistBody(playlistCache[playlistId]);
      } else {
        playlistCountEl.textContent = 'Loading...';
        playlistBody.innerHTML = `<div class="playlist-loading-indicator"><div class="spinner"></div><div class="loading-text">Loading Videos...</div></div>`;
        try {
          const videos = await fetchPlaylistVideos(playlistId);
          playlistCache[playlistId] = videos;
          if (lastOpenedPlaylistItem === item && playlistPopup.classList.contains('visible')) {
            renderPlaylistBody(videos);
          }
        } catch (err) {
          console.error("Playlist fetch error:", err);
          if (lastOpenedPlaylistItem === item && playlistPopup.classList.contains('visible')) {
            playlistBody.innerHTML = `<div style="padding:18px;color:#ffdede">Failed to load: ${escapeHtml(err.message)}</div>`;
            playlistCountEl.textContent = '0 Videos';
          }
        }
      }
    }
    function closePlaylistPopup(){ playlistPopup.classList.remove('visible'); playlistPopup.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }
    playlistCloseBtn.addEventListener('click', ()=> closePlaylistPopup());
    playlistPopup.addEventListener('click', (e)=> { if(e.target === playlistPopup) closePlaylistPopup(); });

    function handleTileClick(item) {
      if (currentUser) {
        if (currentUser.permissions.includes(item.title)) {
          if (item && item.type === 'playlist') { openPlaylistPopup(item); }
          else { lastOpenedPlaylistItem = null; openViewer(item); }
        } else { showModal(document.getElementById('no-access-modal')); }
      } else { showModal(document.getElementById('access-modal')); }
    }
    
    function openViewer(item){
      try{
        const viewer = document.getElementById('viewer');
        if(!viewer) return;
        document.getElementById('now-playing-title').textContent = item.title || 'Now playing';
        viewer.classList.remove('hidden'); viewer.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden';
        const iframeWrap = document.getElementById('iframe-wrap');
        iframeWrap.innerHTML = '';
        const mountRoot = document.createElement('div'); mountRoot.id = 'player-wrap'; mountRoot.style.cssText='width:100%;height:100%';
        iframeWrap.appendChild(mountRoot);
        // This relies on the player module existing in the global scope
        window.showViduPlayer(normalizeIdFromB64(item.idB64), 'player-wrap').catch(err=>{
          mountRoot.innerHTML = `<div style="padding:18px;color:#ffdede;">${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
        });
      }catch(e){ console.warn('openViewer err', e); }
    }
    
    document.getElementById('viewer-close').addEventListener('click', ()=>{
      const v = document.getElementById('viewer'); if(v){ v.classList.add('hidden'); v.setAttribute('aria-hidden','true'); }
      if(window.destroyViduPlayer) window.destroyViduPlayer();
      const wrap = document.getElementById('iframe-wrap'); if(wrap) wrap.innerHTML = '';
      document.body.style.overflow = '';
      if(lastOpenedPlaylistItem){ setTimeout(()=> openPlaylistPopup(lastOpenedPlaylistItem), 120); }
    });
    
    async function fetchPlaylistVideos(playlistId){
      if(!YT_API_KEY) throw new Error('No API key configured.');
      const results = []; let pageToken = '';
      do {
        const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${encodeURIComponent(playlistId)}&key=${encodeURIComponent(YT_API_KEY)}` + (pageToken?`&pageToken=${pageToken}`:'');
        const res = await fetch(url);
        if(!res.ok) throw new Error('YouTube API error: '+res.status);
        const data = await res.json();
        (data.items||[]).forEach(it => {
          if(it.snippet?.resourceId?.videoId){
            results.push({ videoId: it.snippet.resourceId.videoId, title: it.snippet.title||'Untitled' });
          }
        });
        pageToken = data.nextPageToken || '';
      } while(pageToken);
      return results;
    }

    buildTiles();

    const loginBtnTop = document.getElementById('login-btn-top');
    const loginModal = document.getElementById('login-modal');
    const loginClose = document.getElementById('login-close');
    const loginUsernameInput = document.getElementById('login-username');
    const loginPasswordInput = document.getElementById('login-password');
    const loginSubmit = document.getElementById('login-submit');
    const loginError = document.getElementById('login-error');
    
    const accessModal = document.getElementById('access-modal');
    const accessClose = document.getElementById('access-close');
    const accessRequestBtn = document.getElementById('access-request-btn');

    const noAccessModal = document.getElementById('no-access-modal');
    const noAccessClose = document.getElementById('no-access-close');
    const noAccessRequestBtn = document.getElementById('no-access-request-btn');

    const requestAccessLink = 'https://wa.me/254703255099';

    function handleLogin() {
        const username = loginUsernameInput.value.trim();
        const password = loginPasswordInput.value.trim();
        loginError.textContent = '';
        const userAccount = userPermissions[username];
        if (userAccount && userAccount.password === password) {
            currentUser = { username: username, permissions: userAccount.access || [] };
            alert('✅ Logged in successfully!');
            closeModal(loginModal);
            loginBtnTop.textContent = `Logged In as ${username}`;
            loginBtnTop.disabled = true;
        } else {
            loginError.textContent = 'Invalid username or password.';
        }
    }

    loginBtnTop.addEventListener('click', () => {
        loginError.textContent = ''; loginUsernameInput.value = ''; loginPasswordInput.value = '';
        showModal(loginModal); setTimeout(() => loginUsernameInput.focus(), 120);
    });
    loginClose.addEventListener('click', () => closeModal(loginModal));
    loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeModal(loginModal); });
    loginSubmit.addEventListener('click', handleLogin);
    loginPasswordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleLogin(); });

    accessClose.addEventListener('click', () => closeModal(accessModal));
    accessModal.addEventListener('click', (e) => { if (e.target === accessModal) closeModal(accessModal); });
    accessRequestBtn.addEventListener('click', () => window.open(requestAccessLink, '_blank'));

    noAccessClose.addEventListener('click', () => closeModal(noAccessModal));
    noAccessModal.addEventListener('click', (e) => { if (e.target === noAccessModal) closeModal(noAccessModal); });
    noAccessRequestBtn.addEventListener('click', () => window.open(requestAccessLink, '_blank'));
    
    // The self-contained player module - no changes needed here.
    (function playerModule(){ if(window.__viduPlayerLoaded) return; window.__viduPlayerLoaded=true; const state={player:null,updateInterval:null,keyHandler:null,mo:null,host:null,mount:null,fsListener:null,fsResizeHandler:null,inactivityTimer:null,lastActivity:Date.now(),desiredPlaying:null,lastVolume:100,volumeHideTimer:null}; function pad2(n){n=Math.max(0,Math.floor(n||0));return(n<10?'0'+n:String(n))} function fmtTime(s){s=Math.max(0,Math.floor(s||0));const h=Math.floor(s/3600);const m=Math.floor((s%3600)/60);const sec=s%60;return pad2(h)+' : '+pad2(m)+' : '+pad2(sec)} function playSVG(){return`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4.5v15l12-7.5L6 4.5z" fill="#fff"/></svg>`} function pauseSVG(){return`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="4" width="4" height="16" rx="1.2" fill="#fff"/><rect x="15" y="4" width="4" height="16" rx="1.2" fill="#fff"/></svg>`} function gearSVG(){return`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.4-3.5c0-.4-.03-.78-.09-1.15l1.86-1.44a.5.5 0 0 0 .12-.65l-1.76-3.05a.5.5 0 0 0-.6-.22l-2.2.88a7.72 7.72 0 0 0-1.9-1.1l-.33-2.33A.5.5 0 0 0 13.9 2h-3.8a.5.5 0 0 0-.5.42l-.33 2.33c-.69.25-1.35.6-1.95 1.02l-2.2-.88a.5.5 0 0 0-.6.22L2.7 6.96a.5.5 0 0 0 .12.65l1.86 1.44c-.06.37-.09.75-.09 1.15s.03.78.09 1.15L2.82 14.95a.5.5 0 0 0-.12.65l1.76 3.05c.14.24.4.34.64.28l2.2-.88c.6.42 1.26.77 1.95 1.02l.33 2.33c.03.25.25.42.5.42h3.8c.25 0 .47-.17.5-.42l.33-2.33c.69-.25 1.35-.6 1.95-1.02l2.2.88c.24.09.5-.04.64-.28l1.76-3.05a.5.5 0 0 0-.12-.65l-1.86-1.44c.06-.37.09-.75.09-1.15z" fill="#fff"/></svg>`} function enterFullscreenSVG(){return`<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6m-2-4L11 13m-2 8H3v-6m2 4l8-8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`} function exitFullscreenSVG(){return`<svg viewBox="0 0 24 24" width="20" height="20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 9V3h6m4 2L5 13m16-2v6h-6m-2-4l8 8" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`} function createHostElementsIn(mountRootId){const wrap=document.getElementById(mountRootId);if(!wrap)throw new Error('#'+mountRootId+' not found');const prev=wrap.querySelector('.vidu-player-host');if(prev)prev.remove();const host=document.createElement('div');host.className='vidu-player-host';const mount=document.createElement('div');mount.className='vidu-mount';mount.id='vidu_mount_'+Math.floor(Math.random()*1e6);mount.style.height='100%';mount.style.background='#000';host.appendChild(mount);const loadingDiv=document.createElement('div');loadingDiv.className='vidu-loading';loadingDiv.id='vidu_loading';host.appendChild(loadingDiv);const ctrlBg=document.createElement('div');ctrlBg.className='vidu-controls-bg';host.appendChild(ctrlBg);const overlay=document.createElement('div');overlay.className='vidu-overlay';overlay.innerHTML=`<div class="inner-bg" aria-hidden="true"></div><button class="vidu-btn" id="vidu_playbtn">${playSVG()}</button><div class="vidu-time" id="vidu_cur">`+fmtTime(0)+`</div><input id="vidu_seek" class="vidu-range" type="range" min="0" max="100" step="0.1" value="0" /><div class="vidu-time" id="vidu_dur">`+fmtTime(0)+`</div><button class="vidu-btn" id="vidu_playbackbtn" title="Playback speed" aria-label="Playback speed">`+gearSVG()+`</button><button class="vidu-btn" id="vidu_fullbtn" title="Toggle fullscreen" aria-label="Toggle fullscreen">${enterFullscreenSVG()}</button>`;host.appendChild(overlay);const closeBtn=document.createElement('button');closeBtn.className='vidu-close-btn';closeBtn.id='vidu_closebtn';closeBtn.title='Close';closeBtn.type='button';closeBtn.innerHTML='✕';closeBtn.addEventListener('click',()=>{try{const v=document.getElementById('viewer');if(v){v.classList.add('hidden');v.setAttribute('aria-hidden','true')} if(window.destroyViduPlayer)window.destroyViduPlayer();const wrap=document.getElementById(mountRootId);if(wrap)wrap.innerHTML='';document.body.style.overflow=''}catch(e){console.warn('closeBtn error',e)}});host.appendChild(closeBtn);return{host,mount,overlay,ctrlBg,closeBtn,loadingDiv}} async function createYTPlayer(videoId,mountRootId='player-wrap'){if(!window.YT?.Player){const s=document.createElement('script');s.src='https://www.youtube.com/iframe_api';s.async=true;document.head.appendChild(s);await new Promise(r=>{window.onYouTubeIframeAPIReady=r})} const{host,mount,overlay,ctrlBg,closeBtn,loadingDiv}=createHostElementsIn(mountRootId);state.host=host;state.mount=mount;const playBtn=overlay.querySelector('#vidu_playbtn');const curEl=overlay.querySelector('#vidu_cur');const durEl=overlay.querySelector('#vidu_dur');const seekEl=overlay.querySelector('#vidu_seek');const fullBtn=overlay.querySelector('#vidu_fullbtn');function toggleFullscreen(){const fs=document.fullscreenElement||document.webkitFullscreenElement;if(fs===host){if(document.exitFullscreen)document.exitFullscreen()}else{if(host.requestFullscreen)host.requestFullscreen()}} fullBtn.addEventListener('click',toggleFullscreen);function setOverlayHidden(hidden){if(hidden){overlay.classList.add('hidden');ctrlBg.classList.add('hidden');if(closeBtn)closeBtn.classList.add('hidden')}else{overlay.classList.remove('hidden');ctrlBg.classList.remove('hidden');if(closeBtn)closeBtn.classList.remove('hidden')}} state.keyHandler=function(e){if(e.key==='ArrowUp'||e.key==='ArrowDown'){try{if(!state.player)return;e.preventDefault();let curVol=state.player.getVolume();const delta=e.key==='ArrowUp'?5:-5;let target=Math.max(0,Math.min(100,Math.round(curVol+delta)));state.player.setVolume(target);state.lastVolume=target;globalLastVolume=target}catch(err){}}else if(e.key==='ArrowLeft'||e.key==='ArrowRight'){try{if(!state.player)return;e.preventDefault();const cur=state.player.getCurrentTime();const dur=state.player.getDuration();const delta=e.key==='ArrowRight'?10:-10;let target=Math.max(0,cur+delta);if(dur!==null)target=Math.min(target,dur);state.player.seekTo(target,true)}catch(err){}} if((document.activeElement?.tagName==='INPUT'||document.activeElement?.tagName==='TEXTAREA'))return;if(e.code==='Space'||e.key===' '){e.preventDefault();if(state.player){const st=state.player.getPlayerState();if(st===1)state.player.pauseVideo();else state.player.playVideo()}}else if(e.code==='KeyF'||e.key==='f'){e.preventDefault();toggleFullscreen()}};document.addEventListener('keydown',state.keyHandler);seekEl.addEventListener('input',()=>{if(state.player){const dur=state.player.getDuration();if(dur)state.player.seekTo(dur*(parseFloat(seekEl.value)/100),true)}});playBtn.addEventListener('click',()=>{if(!state.player)return;const st=state.player.getPlayerState();if(st===1)state.player.pauseVideo();else state.player.playVideo()});function onFSChange(){const isFS=!!(document.fullscreenElement||document.webkitFullscreenElement);if(isFS)fullBtn.innerHTML=exitFullscreenSVG();else fullBtn.innerHTML=enterFullscreenSVG()} state.fsListener=onFSChange;document.addEventListener('fullscreenchange',state.fsListener);document.addEventListener('webkitfullscreenchange',state.fsListener);function resetInactivityTimer(){state.lastActivity=Date.now();setOverlayHidden(false);if(state.inactivityTimer)clearTimeout(state.inactivityTimer);state.inactivityTimer=setTimeout(()=>{const st=state.player?.getPlayerState();if(st===1)setOverlayHidden(true)},3000)}['mousemove','touchstart','keydown'].forEach(ev=>host.addEventListener(ev,resetInactivityTimer,{passive:true}));return new Promise((resolve,reject)=>{state.player=new YT.Player(mount.id,{videoId:videoId,width:'100%',height:'100%',playerVars:{controls:0,disablekb:1,rel:0,modestbranding:1,playsinline:1,iv_load_policy:3,origin:location.origin},events:{onReady:function(evt){evt.target.setVolume(globalLastVolume);evt.target.playVideo();state.updateInterval=setInterval(()=>{try{if(!state.player)return;const dur=state.player.getDuration();const cur=state.player.getCurrentTime();curEl.textContent=fmtTime(cur);durEl.textContent=fmtTime(dur);seekEl.value=(cur/Math.max(1,dur))*100;const st=state.player.getPlayerState();playBtn.innerHTML=(st===1)?pauseSVG():playSVG()}catch(e){}},160);resolve(state.player)},onStateChange:function(e){if(e.data===1)loadingDiv.classList.add('hidden')},onError:function(err){reject(err)}}})})} function destroyPlayer(){try{if(state.updateInterval)clearInterval(state.updateInterval);if(state.keyHandler)document.removeEventListener('keydown',state.keyHandler);if(state.player)state.player.destroy();if(state.fsListener){document.removeEventListener('fullscreenchange',state.fsListener);document.removeEventListener('webkitfullscreenchange',state.fsListener)} if(state.host)state.host.remove();Object.keys(state).forEach(k=>state[k]=null)}catch(e){}} window.showViduPlayer=async function(videoId,mountRootId='player-wrap'){return createYTPlayer(videoId,mountRootId)};window.destroyViduPlayer=function(){destroyPlayer()}})();
  })();
  </script>
</body>
</html>
